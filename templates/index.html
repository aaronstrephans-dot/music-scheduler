<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Scheduler</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #252836;
    --border: #2e3147; --accent: #6c63ff; --accent2: #ff6584;
    --text: #e2e8f0; --muted: #7c85a2; --success: #48bb78; --danger: #fc8181;
    --warn: #f6ad55;
  }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; min-height: 100vh; }
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; gap: 16px; height: 56px; }
  header h1 { font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: .5px; }
  header .badge { background: var(--accent); color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 600; }
  nav { display: flex; gap: 2px; margin-left: auto; }
  nav button { background: none; border: none; color: var(--muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all .15s; }
  nav button:hover { background: var(--surface2); color: var(--text); }
  nav button.active { background: var(--accent); color: #fff; }
  main { max-width: 1100px; margin: 0 auto; padding: 24px; }
  .tab { display: none; } .tab.active { display: block; }
  h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  /* Toolbar */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  input[type=text], input[type=number], input[type=time], input[type=date], select, textarea {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    border-radius: 6px; padding: 7px 12px; font-size: 13px; outline: none; transition: border .15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  input[type=text] { min-width: 180px; }
  /* Buttons */
  .btn { padding: 7px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity .15s; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
  .btn:hover { opacity: .85; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-danger  { background: var(--danger); color: #fff; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-warn    { background: var(--warn); color: #1a1200; }
  .btn-muted   { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  /* Table */
  .tbl-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .6px; color: var(--muted); padding: 8px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }
  tr.row-error td { background: rgba(252,129,129,.07); }
  tr.row-warn  td { background: rgba(246,173,85,.07); }
  .pill { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; }
  .pill-purple { background: #3d3571; color: #b8b0ff; }
  .pill-blue   { background: #1e3a5f; color: #90cdf4; }
  .pill-green  { background: #1d4a2e; color: #9ae6b4; }
  .pill-orange { background: #4a2d0d; color: #fbd38d; }
  .pill-pink   { background: #4a1d2e; color: #fbb6ce; }
  .pill-red    { background: #4a1d1d; color: #fca5a5; }
  /* Forms */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  label { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); }
  .form-grid input, .form-grid select { width: 100%; }
  /* Stats */
  .stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
  .stat { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; flex: 1; min-width: 120px; }
  .stat-val { font-size: 22px; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; }
  /* Toast */
  #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; font-size: 13px; box-shadow: 0 4px 20px #0008; opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 999; }
  #toast.show { opacity: 1; }
  #toast.ok   { border-left: 3px solid var(--success); }
  #toast.err  { border-left: 3px solid var(--danger); }
  /* Empty */
  .empty { text-align: center; color: var(--muted); padding: 40px; }
  /* Modal */
  .modal-bg { display: none; position: fixed; inset: 0; background: #0009; z-index: 100; align-items: center; justify-content: center; }
  .modal-bg.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
  .modal h3 { margin-bottom: 16px; font-size: 15px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
  /* Clock slots */
  #slots-list .slot-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  #slots-list .slot-row select, #slots-list .slot-row input { flex: 1; }
  /* Schedule track list */
  .track-pos { color: var(--muted); font-size: 12px; width: 32px; }
  .air-time  { color: var(--warn); font-size: 12px; white-space: nowrap; }
  .dur       { color: var(--muted); font-size: 12px; }
  /* Progress bar */
  .progress-wrap { background: var(--surface2); border-radius: 99px; height: 8px; overflow: hidden; margin: 12px 0; }
  .progress-bar  { height: 100%; background: var(--accent); border-radius: 99px; transition: width .4s ease; width: 0%; }
  /* Dashboard quick actions */
  .quick-actions { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .quick-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; cursor: pointer; transition: border-color .15s, transform .15s; display: flex; align-items: center; gap: 12px; }
  .quick-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .quick-card .icon { font-size: 24px; }
  .quick-card .label { font-weight: 600; font-size: 13px; }
  .quick-card .sub   { font-size: 11px; color: var(--muted); margin-top: 2px; }
  /* Activity feed */
  .activity-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
  .activity-text { flex: 1; font-size: 13px; }
  .activity-time { font-size: 11px; color: var(--muted); white-space: nowrap; }
  /* Export format cards */
  .export-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .export-card { background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all .15s; }
  .export-card:hover { border-color: var(--muted); }
  .export-card.selected { border-color: var(--accent); background: rgba(108,99,255,.08); }
  .export-card .ec-icon { font-size: 28px; margin-bottom: 8px; }
  .export-card .ec-title { font-weight: 700; font-size: 14px; }
  .export-card .ec-desc  { font-size: 11px; color: var(--muted); margin: 4px 0 8px; }
  .export-card .ec-tags  { display: flex; gap: 4px; flex-wrap: wrap; }
  .ec-tag { background: var(--border); color: var(--muted); font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
  /* Violation panel */
  .viol-panel { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 16px; }
  .viol-stats { display: flex; gap: 16px; margin-bottom: 12px; }
  .viol-stat { flex: 1; text-align: center; }
  .viol-stat-val { font-size: 28px; font-weight: 700; }
  .viol-stat-val.err  { color: var(--danger); }
  .viol-stat-val.warn { color: var(--warn); }
  .viol-stat-val.ok   { color: var(--success); }
  .viol-stat-label { font-size: 11px; color: var(--muted); }
  .viol-list { max-height: 200px; overflow-y: auto; }
  .viol-item { padding: 6px 8px; border-radius: 6px; margin-bottom: 4px; font-size: 12px; }
  .viol-item.error   { background: rgba(252,129,129,.12); color: var(--danger); }
  .viol-item.warning { background: rgba(246,173,85,.12); color: var(--warn); }

  /* ── Daypart bands ── */
  :root {
    --dp-overnight: rgba(0,229,255,.18);
    --dp-early:     rgba(255,112,67,.20);
    --dp-morning:   rgba(255,234,0,.22);
    --dp-midmorn:   rgba(0,230,118,.18);
    --dp-midday:    rgba(255,167,38,.20);
    --dp-afternoon: rgba(244,67,54,.20);
    --dp-evening:   rgba(233,30,99,.20);
    --dp-latenight: rgba(156,39,176,.18);
  }
  tr.dp-overnight td { background: var(--dp-overnight); }
  tr.dp-early td     { background: var(--dp-early); }
  tr.dp-morning td   { background: var(--dp-morning); }
  tr.dp-midmorn td   { background: var(--dp-midmorn); }
  tr.dp-midday td    { background: var(--dp-midday); }
  tr.dp-afternoon td { background: var(--dp-afternoon); }
  tr.dp-evening td   { background: var(--dp-evening); }
  tr.dp-latenight td { background: var(--dp-latenight); }
  /* hour-label overrides to keep its own bg */
  tr.dp-overnight td.hour-label { background: var(--surface2); border-left: 3px solid #00e5ff; }
  tr.dp-early td.hour-label     { background: var(--surface2); border-left: 3px solid #ff7043; }
  tr.dp-morning td.hour-label   { background: var(--surface2); border-left: 3px solid #ffea00; }
  tr.dp-midmorn td.hour-label   { background: var(--surface2); border-left: 3px solid #00e676; }
  tr.dp-midday td.hour-label    { background: var(--surface2); border-left: 3px solid #ffa726; }
  tr.dp-afternoon td.hour-label { background: var(--surface2); border-left: 3px solid #f44336; }
  tr.dp-evening td.hour-label   { background: var(--surface2); border-left: 3px solid #e91e63; }
  tr.dp-latenight td.hour-label { background: var(--surface2); border-left: 3px solid #9c27b0; }

  /* ── Program Grid (week view) ── */
  .pg-view-toggle { display: flex; gap: 4px; margin-bottom: 16px; }
  .pg-view-toggle button { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .15s; }
  .pg-view-toggle button.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .prog-grid-wrap { overflow-x: auto; }
  .prog-grid { border-collapse: collapse; font-size: 12px; min-width: 700px; width: 100%; }
  .prog-grid th { padding: 6px 8px; background: var(--surface2); border: 1px solid var(--border); white-space: nowrap; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); text-align: center; }
  .prog-grid td { border: 1px solid var(--border); padding: 0; vertical-align: top; min-width: 100px; }
  .prog-grid .hour-label { background: var(--surface2); color: var(--muted); font-size: 11px; padding: 5px 8px; text-align: right; white-space: nowrap; min-width: 56px; font-weight: 600; }
  .grid-cell { min-height: 32px; padding: 4px 6px; cursor: pointer; transition: background .1s; display: flex; align-items: center; justify-content: space-between; gap: 4px; }
  .grid-cell:hover { background: var(--surface2); }
  .grid-cell .gc-name { font-size: 11px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
  .grid-cell .gc-empty { font-size: 11px; color: var(--border); font-style: italic; }
  .grid-cell .gc-clr { display: inline-block; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .cell-assigned { background: rgba(108,99,255,.08); }
  .day-col-head { font-weight: 700; color: var(--text); }
  /* Grid cell picker dropdown */
  .gc-select { width: 100%; background: transparent; border: none; color: var(--text); font-size: 11px; padding: 4px; border-radius: 4px; cursor: pointer; }
  .gc-select:focus { outline: 1px solid var(--accent); background: var(--surface); }
  /* Daypart map mode — interactive selects */
  .dp-map-cell { height: 28px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; letter-spacing: .4px; color: rgba(0,0,0,.45); cursor: default; }
  .dp-sel { width: 100%; border: 1px solid rgba(255,255,255,.12); border-radius: 4px; font-size: 10px; font-weight: 600; padding: 3px 4px; height: 28px; cursor: pointer; color: var(--text); font-family: inherit; }
  .dp-sel:focus { outline: 1px solid var(--accent); }
  .dp-sel option { background: #1a1d2e; }

  /* ── Day Detail view ── */
  .day-detail-wrap { display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; max-height: 70vh; }
  .ddl-panel { width: 190px; flex-shrink: 0; border-right: 1px solid var(--border); overflow-y: auto; background: var(--surface2); }
  .ddl-item { padding: 9px 14px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); transition: background .1s; }
  .ddl-item:hover { background: var(--surface); }
  .ddl-item.active { background: rgba(108,99,255,.18); color: var(--accent); font-weight: 600; }
  .ddl-item.add-btn { color: var(--accent); font-size: 12px; }
  .dd-center { flex: 1; overflow-y: auto; }
  .dd-row { display: flex; align-items: center; gap: 0; border-bottom: 1px solid var(--border); }
  .dd-row:last-child { border-bottom: none; }
  .dd-hour { width: 70px; flex-shrink: 0; font-size: 11px; color: var(--muted); font-weight: 600; padding: 5px 10px; white-space: nowrap; }
  .dd-hour-name { font-size: 9px; display: block; text-transform: uppercase; letter-spacing: .4px; margin-top: 1px; }
  .dd-sel { flex: 1; background: transparent; border: none; color: var(--text); font-size: 12px; padding: 5px 8px; cursor: pointer; }
  .dd-sel:focus { outline: 1px solid var(--accent); background: var(--surface2); }

  /* ── Daypart legend (map mode) ── */
  .dp-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; align-items: center; }
  .dp-leg-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted); }
  .dp-swatch { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }

  /* ── Clock pie chart ── */
  .pie-modal-body { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; justify-content: center; }
  .pie-legend { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
  .pie-leg-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }
  .pie-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

  /* ── Clock grid (visual clock view) ── */
  .clock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; padding: 4px 0; }
  .clock-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 10px 10px; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: border-color .15s; }
  .clock-card:hover { border-color: var(--accent); }
  .clock-card-name { font-weight: 700; font-size: 13px; color: var(--text); text-align: center; }
  .clock-card-sub { font-size: 11px; color: var(--muted); }
  .clock-card-actions { display: flex; gap: 6px; margin-top: 6px; }

  /* ── Schedule view modes ── */
  .view-toggle { display: flex; gap: 4px; margin-bottom: 12px; }
  .view-toggle button { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .15s; }
  .view-toggle button.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Hour-block view */
  .hour-block { margin-bottom: 12px; }
  .hour-block-head { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px 6px 0 0; padding: 6px 12px; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .hour-block-body { border: 1px solid var(--border); border-top: none; border-radius: 0 0 6px 6px; }
  .hb-row { display: flex; align-items: center; gap: 10px; padding: 7px 12px; border-bottom: 1px solid var(--border); }
  .hb-row:last-child { border-bottom: none; }
  .hb-pos { color: var(--muted); font-size: 11px; width: 24px; flex-shrink: 0; }
  .hb-time { color: var(--warn); font-size: 11px; width: 52px; flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .hb-title { font-weight: 500; flex: 1; font-size: 13px; }
  .hb-artist { color: var(--muted); font-size: 12px; width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .hb-dur { color: var(--muted); font-size: 11px; width: 40px; text-align: right; flex-shrink: 0; }

  /* Timeline view */
  .timeline-wrap { overflow-x: auto; padding-bottom: 8px; }
  .timeline { position: relative; height: auto; }
  .tl-ruler { display: flex; height: 20px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
  .tl-tick { border-left: 1px solid var(--border); flex-shrink: 0; font-size: 10px; color: var(--muted); padding-left: 3px; padding-top: 4px; }
  .tl-track { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .tl-label { width: 130px; flex-shrink: 0; font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; }
  .tl-bar-wrap { flex: 1; position: relative; height: 22px; }
  .tl-bar { position: absolute; height: 20px; border-radius: 3px; display: flex; align-items: center; padding: 0 6px; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: default; transition: opacity .1s; }
  .tl-bar:hover { opacity: .85; }
  .tl-spot  { background: rgba(252,129,129,.5); color: #fca5a5; }
  .tl-liner { background: rgba(246,173,85,.4); color: #fbd38d; }
  .tl-lognote { background: rgba(128,128,128,.4); color: var(--muted); }
  .tl-music-0 { background: rgba(108,99,255,.6); color: #b8b0ff; }
  .tl-music-1 { background: rgba(72,187,120,.5); color: #9ae6b4; }
  .tl-music-2 { background: rgba(246,173,85,.5); color: #fbd38d; }
  .tl-music-3 { background: rgba(255,101,132,.5); color: #fbb6ce; }

  /* ── Rules Engine ── */
  .rules-section-head { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--muted); margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  .rule-hint { font-size: 10px; color: var(--muted); margin-top: 2px; line-height: 1.4; }
  /* Conditional rule cards */
  .cr-rule { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
  .cr-rule.cr-disabled { opacity: .55; }
  .cr-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .cr-toggle { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; color: var(--muted); white-space: nowrap; flex-shrink: 0; }
  .cr-toggle input[type=checkbox] { width: auto; }
  .cr-label-inp { flex: 1; background: transparent; border: none; border-bottom: 1px dashed var(--border); color: var(--text); font-size: 13px; font-weight: 600; padding: 2px 4px; outline: none; min-width: 0; }
  .cr-label-inp:focus { border-bottom-color: var(--accent); }
  .cr-body { padding: 14px; display: flex; flex-direction: column; gap: 12px; }
  .cr-section { display: flex; gap: 10px; align-items: flex-start; }
  .cr-kw { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: .6px; padding: 5px 8px; border-radius: 4px; flex-shrink: 0; margin-top: 5px; min-width: 44px; text-align: center; }
  .cr-kw.kw-if   { background: rgba(108,99,255,.2); color: var(--accent); }
  .cr-kw.kw-then { background: rgba(72,187,120,.2); color: var(--success); }
  .cr-inner { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  .cr-cond-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .cr-cond-field { flex: 2; min-width: 160px; }
  .cr-cond-op    { flex: 1; min-width: 80px; }
  .cr-cond-val   { flex: 1.5; min-width: 90px; }
  .cr-cond-val input, .cr-cond-val select { width: 100%; }
  .cr-between { display: flex; gap: 4px; align-items: center; }
  .cr-between input { flex: 1; min-width: 50px; }
  .cr-foot { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 2px; }
  .cr-logic { display: flex; gap: 10px; align-items: center; font-size: 12px; color: var(--muted); }
  .cr-logic label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; text-transform: none; letter-spacing: 0; color: var(--text); }
  .cr-logic input[type=radio] { width: auto; }
  .cr-action-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .cr-action-type { flex: 2; min-width: 240px; }
  .cr-action-val { flex: 1; min-width: 90px; }
  .cr-action-val input, .cr-action-val select { width: 100%; }

  /* ── Track modal tabs ── */
  .tm-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin: -24px -24px 20px; padding: 0 20px; overflow-x: auto; }
  .tm-tab  { padding: 11px 14px; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; background: none; border-top: none; border-left: none; border-right: none; transition: all .15s; }
  .tm-tab:hover  { color: var(--text); }
  .tm-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tm-panel { display: none; } .tm-panel.active { display: block; }
  /* Tempo badges */
  .tempo-sl { background: rgba(96,165,250,.15); color: #60a5fa; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  .tempo-ms { background: rgba(52,211,153,.12); color: #34d399; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  .tempo-me { background: rgba(251,191,36,.12); color: #fbbf24; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  .tempo-mf { background: rgba(251,146,60,.12); color: #fb923c; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  .tempo-fa { background: rgba(248,113,113,.15); color: #f87171; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  /* Sound code chips */
  .sc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 6px; }
  .sc-item { display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; }
  .sc-item input[type=checkbox] { width: auto; flex-shrink: 0; accent-color: var(--accent); }
  /* Wide track modal */
  .modal-wide { width: min(760px, 96vw); }
  /* Cart/intro chip in table */
  .cart-chip { font-family: monospace; font-size: 11.5px; color: var(--warn); background: rgba(246,173,85,.1); padding: 1px 5px; border-radius: 4px; }
  /* Last played date */
  .lp-date { font-size: 11px; color: var(--muted); }
  /* Column picker */
  .col-picker-wrap { position: relative; display: inline-block; }
  .col-picker-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; }
  .col-picker-btn:hover { border-color: var(--accent); color: var(--text); }
  .col-picker-panel {
    display: none; position: absolute; top: calc(100% + 4px); right: 0; z-index: 90;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px; width: 560px; max-height: 60vh; overflow-y: auto;
    box-shadow: 0 8px 32px #0009;
  }
  .col-picker-panel.open { display: block; }
  .col-picker-panel h4 { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); margin-bottom: 8px; }
  .col-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 4px; margin-bottom: 10px; }
  .col-pill { display: flex; align-items: center; gap: 6px; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; border: 1px solid transparent; }
  .col-pill:hover { background: var(--surface2); }
  .col-pill.on { background: rgba(108,99,255,.12); border-color: rgba(108,99,255,.3); color: var(--accent); }
  .col-pill input { width: auto; accent-color: var(--accent); flex-shrink: 0; }
  /* Attribute mini-chips */
  .attr-chip { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: 600; }
  .mood-1 { background: rgba(52,211,153,.15); color: #34d399; }
  .mood-2 { background: rgba(96,165,250,.15); color: #60a5fa; }
  .mood-3 { background: rgba(251,191,36,.15); color: #fbbf24; }
  .mood-4 { background: rgba(251,146,60,.15); color: #fb923c; }
  .mood-5 { background: rgba(248,113,113,.15); color: #f87171; }
  .tex-chip { background: rgba(244,114,182,.12); color: #f472b6; }
  .gen-chip { background: rgba(167,139,250,.12); color: #a78bfa; }
  .pct-chip { background: rgba(52,211,153,.1); color: var(--success); }
</style>
</head>
<body>

<header>
  <h1 style="cursor:pointer" onclick="window.location.href='/'">&#127925; Music Scheduler</h1>
  <span class="badge" id="ai-badge" style="display:none">AI</span>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
    <button onclick="showTab('tracks',this)">Tracks</button>
    <button onclick="showTab('clocks',this)">Clocks</button>
    <button onclick="showTab('schedules',this)">Schedules</button>
    <button onclick="showTab('program',this)">Program</button>
    <button onclick="showTab('export',this)">Export</button>
    <button onclick="showTab('rules',this)">Rules</button>
    <button onclick="showTab('soundcodes',this)">Sound Codes</button>
    <button onclick="showTab('bulk',this)">Bulk Actions</button>
    <button onclick="showTab('traffic',this)">Traffic</button>
    <button onclick="showTab('announcers',this)">Announcers</button>
  </nav>
</header>

<main>

<!-- ======================== DASHBOARD TAB ======================== -->
<div id="tab-dashboard" class="tab active">
  <div class="stats" id="dash-stats"></div>

  <div class="card">
    <h2>Quick Actions</h2>
    <div class="quick-actions">
      <div class="quick-card" onclick="showTab('schedules',navBtn('schedules'))">
        <div class="icon">&#9654;</div>
        <div><div class="label">Generate Schedule</div><div class="sub">Build a new rotation</div></div>
      </div>
      <div class="quick-card" onclick="showTab('tracks',navBtn('tracks'))">
        <div class="icon">&#127925;</div>
        <div><div class="label">Track Library</div><div class="sub">Add or manage tracks</div></div>
      </div>
      <div class="quick-card" onclick="showTab('clocks',navBtn('clocks'))">
        <div class="icon">&#128336;</div>
        <div><div class="label">Clock Templates</div><div class="sub">Design hour clocks</div></div>
      </div>
      <div class="quick-card" onclick="showTab('export',navBtn('export'))">
        <div class="icon">&#128229;</div>
        <div><div class="label">Export</div><div class="sub">Download schedule files</div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Recent Schedules</h2>
    <div id="dash-activity"></div>
  </div>
</div>

<!-- ======================== TRACKS TAB ======================== -->
<div id="tab-tracks" class="tab">
  <div class="stats" id="track-stats"></div>
  <div class="card">
    <div class="toolbar" style="flex-wrap:wrap;gap:6px">
      <input type="text" id="track-search" placeholder="Search title, artist, cart, genre…" oninput="loadTracks()" style="min-width:220px">
      <select id="track-cat" onchange="loadTracks()">
        <option value="">All categories</option>
      </select>
      <select id="track-active" onchange="loadTracks()">
        <option value="">Active + inactive</option>
        <option value="true">Active only</option>
        <option value="false">Inactive only</option>
      </select>
      <select id="track-tempo" onchange="loadTracks()">
        <option value="">All tempos</option>
        <option value="1">1 — Slow</option>
        <option value="2">2 — Med-Slow</option>
        <option value="3">3 — Medium</option>
        <option value="4">4 — Med-Fast</option>
        <option value="5">5 — Fast</option>
      </select>
      <select id="track-gender" onchange="loadTracks()">
        <option value="">All genders</option>
        <option value="1">Male</option>
        <option value="2">Female</option>
        <option value="3">Duo/Group</option>
        <option value="4">Instrumental</option>
      </select>
      <select id="track-mood" onchange="loadTracks()">
        <option value="">All moods</option>
        <option value="1">1 — Joyful</option>
        <option value="2">2 — Inspirational</option>
        <option value="3">3 — Reflective</option>
        <option value="4">4 — Contemplative</option>
        <option value="5">5 — Somber</option>
      </select>
      <select id="track-sort" onchange="loadTracks()">
        <option value="title" selected>Sort: Title</option>
        <option value="artist">Sort: Artist</option>
        <option value="added_at">Sort: Date Added</option>
        <option value="play_count">Sort: Plays</option>
        <option value="last_played_at">Sort: Last Play</option>
        <option value="tempo">Sort: Tempo</option>
        <option value="cart_number">Sort: Cart #</option>
        <option value="bpm">Sort: BPM</option>
        <option value="chart_position">Sort: Chart Pos</option>
        <option value="pct_play">Sort: % Play</option>
      </select>
      <select id="track-order" onchange="loadTracks()">
        <option value="asc">↑ Asc</option>
        <option value="desc">↓ Desc</option>
      </select>
      <!-- Column picker -->
      <div class="col-picker-wrap" id="col-picker-wrap">
        <button class="col-picker-btn" onclick="toggleColPicker(event)">⊞ Columns</button>
        <div class="col-picker-panel" id="col-picker-panel">
          <h4>Always visible</h4>
          <div style="font-size:12px;color:var(--muted);margin-bottom:10px">#, Title, Artist, Actions are always shown.</div>
          <h4>Toggle columns</h4>
          <div class="col-picker-grid" id="col-picker-grid"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-muted btn-sm" onclick="selectAllCols()">All</button>
            <button class="btn btn-muted btn-sm" onclick="selectDefaultCols()">Default</button>
            <button class="btn btn-muted btn-sm" onclick="selectNoneCols()">None</button>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="openAddTrack()">+ Add Track</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead id="tracks-thead"><tr></tr></thead>
        <tbody id="tracks-body"></tbody>
      </table>
    </div>
    <div id="tracks-empty" class="empty">Select a category or type in the search box to browse your library.</div>
    <div id="tracks-footer" style="font-size:12px;color:var(--muted);margin-top:10px;display:none;gap:12px;align-items:center">
      <span id="tracks-count"></span>
      <button id="tracks-load-more" class="btn btn-muted btn-sm" style="display:none" onclick="loadMoreTracks()">Load more…</button>
    </div>
  </div>
</div>

<!-- ======================== CLOCKS TAB ======================== -->
<div id="tab-clocks" class="tab">
  <div class="card">
    <div class="toolbar" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
      <button class="btn btn-primary" onclick="openClockModal()">+ New Clock Template</button>
      <div class="pg-view-toggle">
        <button id="clocks-view-btn-list" class="active" onclick="setClocksView('list')">&#9776; List</button>
        <button id="clocks-view-btn-clock" onclick="setClocksView('clock')">&#9685; Clock View</button>
      </div>
    </div>
    <!-- List view -->
    <div id="clocks-list-view">
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Name</th><th>Slots</th><th>Created</th><th></th></tr></thead>
          <tbody id="clocks-body"></tbody>
        </table>
      </div>
    </div>
    <!-- Clock (visual pie) view -->
    <div id="clocks-clock-view" style="display:none">
      <div class="clock-grid" id="clocks-grid"></div>
    </div>
    <div id="clocks-empty" class="empty" style="display:none">No clock templates yet.</div>
  </div>
</div>

<!-- Clock Pie Chart Modal -->
<div class="modal-bg" id="modal-pie">
  <div class="modal" style="width:520px">
    <h3 id="pie-title">Clock Composition</h3>
    <div class="pie-modal-body">
      <svg id="pie-svg" width="220" height="220" viewBox="0 0 220 220"></svg>
      <div class="pie-legend" id="pie-legend"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-pie')">Close</button>
    </div>
  </div>
</div>

<!-- ======================== SCHEDULES TAB ======================== -->
<div id="tab-schedules" class="tab">
  <div class="card">
    <h2>Generate Schedule</h2>
    <div class="form-grid" style="margin-bottom:12px">
      <div class="form-group">
        <label>Clock Template</label>
        <select id="gen-clock"></select>
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" id="gen-duration" value="60" min="1">
      </div>
      <div class="form-group">
        <label>Start Time</label>
        <input type="time" id="gen-start">
      </div>
      <div class="form-group">
        <label>Schedule Name</label>
        <input type="text" id="gen-name" placeholder="Optional name…">
      </div>
    </div>
    <div id="gen-progress" style="display:none">
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px" id="gen-status-text">Generating…</div>
      <div class="progress-wrap"><div class="progress-bar" id="gen-bar"></div></div>
    </div>
    <button class="btn btn-primary" id="gen-btn" onclick="generateSchedule()">&#9654; Generate</button>
  </div>

  <div class="card">
    <h2>Saved Schedules</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Clock</th><th>Tracks</th><th>Duration</th><th>Created</th><th></th></tr></thead>
        <tbody id="schedules-body"></tbody>
      </table>
    </div>
    <div id="schedules-empty" class="empty" style="display:none">No schedules yet.</div>
  </div>
</div>

<!-- ======================== PROGRAM GRID TAB ======================== -->
<div id="tab-program" class="tab">

  <!-- Template selector + create toolbar -->
  <div class="card">
    <h2>Program Grid</h2>
    <div class="toolbar" style="margin-bottom:12px">
      <select id="pg-tmpl-sel" onchange="loadProgramGrid()">
        <option value="">— Select a day template —</option>
      </select>
      <input type="text" id="pg-new-name" placeholder="New template name…" style="max-width:200px">
      <button class="btn btn-primary btn-sm" onclick="createDayTemplate()">+ New Template</button>
      <button class="btn btn-danger btn-sm" id="pg-del-btn" style="display:none" onclick="deleteDayTemplate()">Delete Template</button>
    </div>

    <!-- View mode toggle -->
    <div class="pg-view-toggle">
      <button class="active" id="pgv-grid"     onclick="switchPgView('grid')">&#9783; Week Grid</button>
      <button              id="pgv-detail"   onclick="switchPgView('detail')">&#9776; Day Detail</button>
      <button              id="pgv-daypart"  onclick="switchPgView('daypart')">&#9632; Daypart Map</button>
    </div>

    <!-- ── WEEK GRID view ── -->
    <div id="pg-view-grid">
      <p style="font-size:12px;color:var(--muted);margin-bottom:10px">
        Each cell: pick a clock for that day &amp; hour. Row colors show daypart bands. Changes save immediately.
      </p>
      <div class="prog-grid-wrap">
        <table class="prog-grid" id="prog-grid">
          <thead>
            <tr>
              <th style="min-width:56px">Hr</th>
              <th class="day-col-head">Mon</th>
              <th class="day-col-head">Tue</th>
              <th class="day-col-head">Wed</th>
              <th class="day-col-head">Thu</th>
              <th class="day-col-head">Fri</th>
              <th class="day-col-head">Sat</th>
              <th class="day-col-head">Sun</th>
            </tr>
          </thead>
          <tbody id="prog-grid-body"></tbody>
        </table>
      </div>
      <div id="prog-grid-empty" class="empty" style="display:none">Select or create a day template to start programming.</div>
    </div>

    <!-- ── DAY DETAIL view ── -->
    <div id="pg-view-detail" style="display:none">
      <p style="font-size:12px;color:var(--muted);margin-bottom:10px">
        Select a day template on the left to see &amp; edit its full 24-hour clock schedule.
      </p>
      <div class="day-detail-wrap">
        <div class="ddl-panel" id="ddl-panel">
          <div class="empty" style="padding:16px;font-size:12px">No templates yet.</div>
        </div>
        <div class="dd-center" id="dd-center">
          <div class="empty" style="padding:40px 20px">Select a template on the left.</div>
        </div>
      </div>
    </div>

    <!-- ── DAYPART MAP view ── -->
    <div id="pg-view-daypart" style="display:none">
      <div class="dp-legend" id="dp-legend"></div>
      <div class="prog-grid-wrap">
        <table class="prog-grid" id="dp-map-grid">
          <thead>
            <tr>
              <th style="min-width:56px">Hr</th>
              <th class="day-col-head">Mon</th>
              <th class="day-col-head">Tue</th>
              <th class="day-col-head">Wed</th>
              <th class="day-col-head">Thu</th>
              <th class="day-col-head">Fri</th>
              <th class="day-col-head">Sat</th>
              <th class="day-col-head">Sun</th>
            </tr>
          </thead>
          <tbody id="dp-map-body"></tbody>
        </table>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:8px">
        Bands show standard daypart groupings. Use the dropdowns to assign clocks — changes save immediately.
      </p>
    </div>
  </div>

  <!-- Generate from template -->
  <div class="card" id="pg-gen-card" style="display:none">
    <h2>Generate from Template</h2>
    <div class="form-grid" style="margin-bottom:12px">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="pg-gen-date">
      </div>
      <div class="form-group">
        <label>Start Hour</label>
        <input type="number" id="pg-gen-start-hr" value="0" min="0" max="23">
      </div>
      <div class="form-group">
        <label>End Hour</label>
        <input type="number" id="pg-gen-end-hr" value="23" min="0" max="23">
      </div>
      <div class="form-group">
        <label>Schedule Name</label>
        <input type="text" id="pg-gen-name" placeholder="Optional…">
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateFromTemplate()">&#9654; Generate Full Day</button>
    <span id="pg-gen-status" style="font-size:12px;color:var(--muted);margin-left:12px"></span>
  </div>
</div>

<!-- ======================== EXPORT TAB ======================== -->
<div id="tab-export" class="tab">
  <div class="card">
    <h2>Export Format</h2>
    <div class="export-grid" id="export-cards">
      <div class="export-card selected" data-fmt="csv" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128202;</div>
        <div class="ec-title">CSV</div>
        <div class="ec-desc">Universal spreadsheet format</div>
        <div class="ec-tags"><span class="ec-tag">.CSV</span></div>
      </div>
      <div class="export-card" data-fmt="zetta-log" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128251;</div>
        <div class="ec-title">Zetta LOG</div>
        <div class="ec-desc">RCS Zetta automation system</div>
        <div class="ec-tags"><span class="ec-tag">.LOG</span></div>
      </div>
      <div class="export-card" data-fmt="zetta-xml" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128251;</div>
        <div class="ec-title">Zetta XML</div>
        <div class="ec-desc">RCS Zetta XML format</div>
        <div class="ec-tags"><span class="ec-tag">.XML</span></div>
      </div>
      <div class="export-card" data-fmt="wideorbit" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#127925;</div>
        <div class="ec-title">WideOrbit</div>
        <div class="ec-desc">WideOrbit automation system</div>
        <div class="ec-tags"><span class="ec-tag">.WO</span></div>
      </div>
      <div class="export-card" data-fmt="enco" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#127926;</div>
        <div class="ec-title">ENCO DAD</div>
        <div class="ec-desc">ENCO automation system</div>
        <div class="ec-tags"><span class="ec-tag">.TXT</span></div>
      </div>
    </div>
    <div class="form-grid" style="margin-bottom:16px">
      <div class="form-group">
        <label>Schedule</label>
        <select id="export-sched-sel"></select>
      </div>
      <div class="form-group">
        <label>Start Time (for air times)</label>
        <input type="time" id="export-start">
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-primary" onclick="doExport()">&#128229; Export</button>
      <span id="export-note" style="font-size:12px;color:var(--muted)"></span>
    </div>
  </div>

  <div class="card">
    <h2>Saved Schedules</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Clock</th><th>Tracks</th><th>Created</th><th></th></tr></thead>
        <tbody id="export-schedules-body"></tbody>
      </table>
    </div>
    <div id="export-schedules-empty" class="empty" style="display:none">No schedules yet.</div>
  </div>
</div>

<!-- ======================== RULES TAB ======================== -->
<div id="tab-rules" class="tab">

  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Rotation Rules Engine</h2>
    <button class="btn btn-primary" onclick="saveRules()">Save All Rules</button>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">Configure global scheduling rules applied during schedule generation. Conditional rules override global values for specific tracks or contexts.</p>

  <!-- ── Separation Rules ── -->
  <div class="card">
    <div class="rules-section-head">Separation Rules</div>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(230px,1fr))">
      <div class="form-group">
        <label>Artist Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-artist_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between plays of the same artist</span>
      </div>
      <div class="form-group">
        <label>Title Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-title_separation_hours" min="0" step="0.5" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">hours</span>
        </div>
        <span class="rule-hint">Min hours before the same title can repeat</span>
      </div>
      <div class="form-group">
        <label>Stack Key Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-stack_key_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between tracks sharing a stack group (versions / box sets)</span>
      </div>
      <div class="form-group">
        <label>Album Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-album_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between tracks from the same album (0 = disabled)</span>
      </div>
    </div>
    <div style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px">
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-allow_double_shots" style="width:auto">
          Allow Double Shots
        </label>
        <span class="rule-hint">Let the same artist appear back-to-back on occasion</span>
      </div>
      <div class="form-group">
        <label>Double Shot Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-double_shot_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Songs between double-shot appearances</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-check_prev_day_artist" style="width:auto">
          Check Prev-Day Artist
        </label>
        <span class="rule-hint">Avoid the same artist in the same hour on consecutive days</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-check_prev_day_song" style="width:auto">
          Check Prev-Day Song
        </label>
        <span class="rule-hint">Avoid the same title in the same hour on consecutive days</span>
      </div>
    </div>
  </div>

  <!-- ── Flow & Sequencing ── -->
  <div class="card">
    <div class="rules-section-head">Flow &amp; Sequencing</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Limit consecutive runs of the same attribute. Set <strong style="color:var(--text)">−1</strong> to disable a limit.</p>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr))">
      <div class="form-group">
        <label>Max Gender Run</label>
        <input type="number" id="rule-max_gender_run" min="-1">
        <span class="rule-hint">e.g. 3 = no more than 3 consecutive male songs</span>
      </div>
      <div class="form-group">
        <label>Max Tempo Run</label>
        <input type="number" id="rule-max_tempo_run" min="-1">
        <span class="rule-hint">Prevents monotonous tempo sequences</span>
      </div>
      <div class="form-group">
        <label>Max Mood Run</label>
        <input type="number" id="rule-max_mood_run" min="-1">
        <span class="rule-hint">Prevents monotonous mood sequences</span>
      </div>
      <div class="form-group">
        <label>Max Texture Run</label>
        <input type="number" id="rule-max_texture_run" min="-1">
        <span class="rule-hint">Prevents monotonous texture sequences</span>
      </div>
      <div class="form-group">
        <label>Max Energy Run</label>
        <input type="number" id="rule-max_energy_run" min="-1">
        <span class="rule-hint">Prevents monotonous energy-level sequences</span>
      </div>
    </div>
    <div style="margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
      <div class="form-group">
        <label>Energy Step Limit</label>
        <input type="number" id="rule-energy_step_limit" min="0">
        <span class="rule-hint">Max energy jump between consecutive songs (0 = off)</span>
      </div>
      <div class="form-group">
        <label>BPM Step Limit</label>
        <input type="number" id="rule-bpm_step_limit" min="0">
        <span class="rule-hint">Max BPM jump between consecutive songs (0 = off)</span>
      </div>
    </div>
  </div>

  <!-- ── Scheduling Restrictions ── -->
  <div class="card">
    <div class="rules-section-head">Scheduling Restrictions</div>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr))">
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-enforce_date_range" style="width:auto">
          Enforce Date Range
        </label>
        <span class="rule-hint">Skip tracks outside their configured start/end date window</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-enforce_hour_open_close" style="width:auto">
          Enforce Hour Open / Close Flags
        </label>
        <span class="rule-hint">Respect can_open_hour / can_close_hour track flags</span>
      </div>
    </div>
  </div>

  <!-- ── Conditional Rules ── -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div class="rules-section-head" style="margin:0;border:none;padding:0">Conditional Rules — If / Then</div>
      <button class="btn btn-primary btn-sm" onclick="addConditionalRule()">+ Add Rule</button>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
      Override scheduling behavior for specific tracks or contexts. Rules are evaluated in order; multiple matching rules stack their overrides.
      <br>Use <strong style="color:var(--text)">IF</strong> conditions to describe the context, and <strong style="color:var(--success)">THEN</strong> to define what changes or is required.
    </p>
    <div id="cond-rules-list">
      <div class="empty" id="cond-rules-empty" style="padding:20px">No conditional rules defined. Click <strong>+ Add Rule</strong> to create one.</div>
    </div>
  </div>

</div>

<!-- ======================== SOUND CODES TAB ======================== -->
<div id="tab-soundcodes" class="tab">
  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Sound Code Library</h2>
    <button class="btn btn-primary" onclick="openSCModal()">+ Add Sound Code</button>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">
    Define names for Music1 sound codes 1–30. Assign codes to tracks to enable sound-code filtering in clock slots.
  </p>
  <div class="card">
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>#</th><th>Code</th><th>Name</th><th>Description</th><th></th></tr></thead>
        <tbody id="sc-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======================== BULK ACTIONS TAB ======================== -->
<div id="tab-bulk" class="tab">
  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Bulk Track Operations</h2>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">
    Apply an action to many tracks at once. Use filters to narrow the selection or enter specific track IDs.
  </p>

  <div class="card">
    <h3 style="font-size:14px;font-weight:600;margin-bottom:16px">Filter / Select Tracks</h3>
    <div class="form-grid" style="margin-bottom:16px">
      <div class="form-group">
        <label>Category</label>
        <select id="bulk-cat"><option value="">All Categories</option></select>
      </div>
      <div class="form-group">
        <label>Tempo</label>
        <select id="bulk-tempo">
          <option value="">Any</option>
          <option value="1">1 — Slow</option>
          <option value="2">2 — Slow-Med</option>
          <option value="3">3 — Medium</option>
          <option value="4">4 — Med-Fast</option>
          <option value="5">5 — Fast</option>
        </select>
      </div>
      <div class="form-group">
        <label>Search (title / artist)</label>
        <input type="text" id="bulk-search" placeholder="e.g. Amazing Grace">
      </div>
    </div>

    <div class="form-group" style="margin-bottom:16px">
      <label>Action</label>
      <select id="bulk-action" onchange="updateBulkUI()">
        <option value="activate">Activate tracks</option>
        <option value="deactivate">Deactivate tracks</option>
        <option value="recategorize">Move to category</option>
        <option value="set_field">Set a field value</option>
        <option value="delete">Delete tracks</option>
      </select>
    </div>

    <div id="bulk-recategorize-row" style="display:none" class="form-group">
      <label>New Category</label>
      <select id="bulk-new-cat"><option value="">Select…</option></select>
    </div>

    <div id="bulk-setfield-row" style="display:none">
      <div class="form-grid" style="margin-bottom:0">
        <div class="form-group">
          <label>Field Name</label>
          <input type="text" id="bulk-field" placeholder="e.g. pct_play">
        </div>
        <div class="form-group">
          <label>New Value</label>
          <input type="text" id="bulk-value" placeholder="e.g. 50">
        </div>
      </div>
    </div>

    <div id="bulk-delete-warn" style="display:none;background:rgba(252,129,129,.1);border:1px solid rgba(252,129,129,.3);border-radius:8px;padding:10px 14px;margin:12px 0;font-size:13px;color:var(--danger)">
      ⚠ This will permanently delete the selected tracks. This cannot be undone.
    </div>

    <button class="btn btn-primary" style="margin-top:12px" onclick="runBulkAction()">Apply Action</button>
    <span id="bulk-result" style="margin-left:14px;font-size:13px;color:var(--success)"></span>
  </div>
</div>

<!-- ======================== TRAFFIC TAB ======================== -->
<div id="tab-traffic" class="tab">
  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Traffic / Spot Components</h2>
    <button class="btn btn-primary" onclick="openTrafficModal()">+ Add Component</button>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">
    Manage commercial spots, PSAs, promos, and liners scheduled alongside music.
  </p>
  <div class="toolbar" style="margin-bottom:12px">
    <select id="traffic-type-filter" onchange="loadTraffic()">
      <option value="">All Types</option>
      <option value="spot">Spot (Commercial)</option>
      <option value="psa">PSA</option>
      <option value="promo">Promo</option>
      <option value="liner">Liner</option>
      <option value="jingle">Jingle</option>
      <option value="news">News</option>
    </select>
  </div>
  <div class="card">
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Type</th><th>Client</th><th>Duration</th><th>Cart</th><th>Dates</th><th>Active</th><th></th></tr></thead>
        <tbody id="traffic-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======================== ANNOUNCERS TAB ======================== -->
<div id="tab-announcers" class="tab">
  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Announcers / Jocks</h2>
    <button class="btn btn-primary" onclick="openAnnouncerModal()">+ Add Announcer</button>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">
    Register announcers / jocks. Assign a required announcer to tracks or clock slots to enforce live-assist assignments.
  </p>
  <div class="card">
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Initials</th><th>Active</th><th>Notes</th><th></th></tr></thead>
        <tbody id="ann-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

</main>

<!-- ======================== MODALS ======================== -->

<!-- Add Track -->
<div class="modal-bg" id="modal-track">
  <div class="modal modal-wide">
    <h3 id="modal-track-title">Add Track</h3>

    <!-- Tab bar -->
    <div class="tm-tabs">
      <button class="tm-tab active" onclick="showTmTab('basic',this)">Basic Info</button>
      <button class="tm-tab" onclick="showTmTab('timing',this)">Timing</button>
      <button class="tm-tab" onclick="showTmTab('attrs',this)">Attributes</button>
      <button class="tm-tab" onclick="showTmTab('scodes',this)">Sound Codes</button>
      <button class="tm-tab" onclick="showTmTab('sched',this)">Scheduling</button>
      <button class="tm-tab" onclick="showTmTab('restrict',this)">Restrictions</button>
      <button class="tm-tab" onclick="showTmTab('license',this)">Licensing</button>
    </div>

    <!-- Tab 1: Basic Info -->
    <div class="tm-panel active" id="tmp-basic">
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2"><label>Title *</label><input type="text" id="t-title"></div>
        <div class="form-group" style="grid-column:span 2"><label>Artist *</label><input type="text" id="t-artist"></div>
        <div class="form-group"><label>Alt. Artists</label><input type="text" id="t-alt-artists" placeholder="feat. / with …"></div>
        <div class="form-group">
          <label>Category *</label>
          <select id="t-category"></select>
        </div>
        <div class="form-group"><label>Duration (sec)</label><input type="number" id="t-duration" min="1" placeholder="e.g. 225"></div>
        <div class="form-group"><label>Cart Number</label><input type="text" id="t-cart" placeholder="e.g. T1234"></div>
        <div class="form-group"><label>Genre</label><input type="text" id="t-genre" placeholder="e.g. CCM"></div>
        <div class="form-group"><label>Album</label><input type="text" id="t-album"></div>
        <div class="form-group"><label>Record Label</label><input type="text" id="t-record-label"></div>
        <div class="form-group"><label>Chart Position</label><input type="number" id="t-chart-pos" min="1"></div>
        <div class="form-group" style="grid-column:span 2"><label>Notes / Announcer Notes</label><textarea id="t-notes" rows="2" style="width:100%;resize:vertical"></textarea></div>
      </div>
    </div>

    <!-- Tab 2: Timing -->
    <div class="tm-panel" id="tmp-timing">
      <div class="form-grid">
        <div class="form-group"><label>Intro (sec)</label><input type="number" id="t-intro" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>Outro (sec)</label><input type="number" id="t-outro" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>Hook In (sec)</label><input type="number" id="t-hookin" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>Hook Out (sec)</label><input type="number" id="t-hookout" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>Mix In (sec)</label><input type="number" id="t-mixin" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>Mix Out (sec)</label><input type="number" id="t-mixout" min="0" step="0.1" placeholder="0.0"></div>
        <div class="form-group"><label>BPM</label><input type="number" id="t-bpm" min="1" max="300"></div>
        <div class="form-group"><label>Energy (1–10)</label><input type="number" id="t-energy" min="1" max="10"></div>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:12px">Intro: length before vocals start. Hook: memorable section. Mix: crossfade points.</p>
    </div>

    <!-- Tab 3: Attributes -->
    <div class="tm-panel" id="tmp-attrs">
      <div class="form-grid">
        <div class="form-group">
          <label>Tempo</label>
          <select id="t-tempo">
            <option value="">— unset —</option>
            <option value="1">1 — Slow</option>
            <option value="2">2 — Med-Slow</option>
            <option value="3">3 — Medium</option>
            <option value="4">4 — Med-Fast</option>
            <option value="5">5 — Fast</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tempo Range (Min–Max)</label>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="t-tempo-min" style="flex:1">
              <option value="">Min</option>
              <option value="1">1 Slow</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option><option value="5">5 Fast</option>
            </select>
            <span style="color:var(--muted)">–</span>
            <select id="t-tempo-max" style="flex:1">
              <option value="">Max</option>
              <option value="1">1 Slow</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option><option value="5">5 Fast</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Gender / Vocal Style</label>
          <select id="t-gender">
            <option value="">— unset —</option>
            <option value="1">1 — Male</option>
            <option value="2">2 — Female</option>
            <option value="3">3 — Duo / Group</option>
            <option value="4">4 — Instrumental</option>
            <option value="5">5 — Mixed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mood (Music1 scale)</label>
          <select id="t-mood">
            <option value="">— unset —</option>
            <option value="1">1 — Joyful</option>
            <option value="2">2 — Inspirational</option>
            <option value="3">3 — Reflective</option>
            <option value="4">4 — Contemplative</option>
            <option value="5">5 — Somber</option>
          </select>
        </div>
        <div class="form-group">
          <label>Texture (1–5)</label>
          <select id="t-texture">
            <option value="">— unset —</option>
            <option value="1">1 — Open / Sparse</option>
            <option value="2">2 — Light</option>
            <option value="3">3 — Medium</option>
            <option value="4">4 — Full</option>
            <option value="5">5 — Busy / Dense</option>
          </select>
        </div>
        <div class="form-group">
          <label>Texture Range (Min–Max)</label>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="t-texture-min" style="flex:1">
              <option value="">Min</option>
              <option value="1">1 Open</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option><option value="5">5 Busy</option>
            </select>
            <span style="color:var(--muted)">–</span>
            <select id="t-texture-max" style="flex:1">
              <option value="">Max</option>
              <option value="1">1 Open</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option><option value="5">5 Busy</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Key (Primary)</label>
          <select id="t-key1">
            <option value="">— unset —</option>
            <option value="1">C</option><option value="2">C#/Db</option>
            <option value="3">D</option><option value="4">D#/Eb</option>
            <option value="5">E</option><option value="6">F</option>
            <option value="7">F#/Gb</option><option value="8">G</option>
            <option value="9">G#/Ab</option><option value="10">A</option>
            <option value="11">A#/Bb</option><option value="12">B</option>
          </select>
        </div>
        <div class="form-group"><label>Key (Secondary / Minor)</label>
          <select id="t-key2">
            <option value="">— unset —</option>
            <option value="1">C</option><option value="2">C#/Db</option>
            <option value="3">D</option><option value="4">D#/Eb</option>
            <option value="5">E</option><option value="6">F</option>
            <option value="7">F#/Gb</option><option value="8">G</option>
            <option value="9">G#/Ab</option><option value="10">A</option>
            <option value="11">A#/Bb</option><option value="12">B</option>
          </select>
        </div>
        <div class="form-group"><label>User Field 1</label><input type="text" id="t-user1"></div>
        <div class="form-group"><label>User Field 2</label><input type="text" id="t-user2"></div>
        <div class="form-group"><label>User Field 3</label><input type="text" id="t-user3"></div>
        <div class="form-group"><label>User Field 4</label><input type="text" id="t-user4"></div>
      </div>
    </div>

    <!-- Tab 4: Sound Codes -->
    <div class="tm-panel" id="tmp-scodes">
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Sound codes are style/content flags used for scheduling rules and separation. Check all that apply.</p>
      <div class="sc-grid" id="sc-checkboxes"></div>
    </div>

    <!-- Tab 5: Scheduling -->
    <div class="tm-panel" id="tmp-sched">
      <div class="form-grid">
        <div class="form-group">
          <label>Active / Schedulable</label>
          <select id="t-active">
            <option value="true">Yes — include in rotation</option>
            <option value="false">No — exclude from scheduling</option>
          </select>
        </div>
        <div class="form-group">
          <label>% Play Weight (1–200, default 100)</label>
          <input type="number" id="t-pct-play" min="0" max="200" placeholder="100" title="Higher = more likely to be selected within its category">
        </div>
        <div class="form-group">
          <label>Required Announcer (0 = any)</label>
          <select id="t-announcer">
            <option value="0">0 — Any announcer</option>
          </select>
        </div>
        <div class="form-group">
          <label>Link Type</label>
          <select id="t-link-type">
            <option value="0">0 — None</option>
            <option value="1">1 — Hard-link to NEXT track</option>
            <option value="2">2 — Hard-link to PREV track</option>
          </select>
        </div>
        <div class="form-group">
          <label>Chart Position</label>
          <input type="number" id="t-chart-pos2" min="0" placeholder="e.g. 42">
        </div>
        <div class="form-group">
          <label>File Path (automation system)</label>
          <input type="text" id="t-file-path" placeholder="e.g. HOSA-42">
        </div>
        <div class="form-group">
          <label>Auto Parameters</label>
          <input type="text" id="t-auto-params" placeholder="extra automation params">
        </div>
        <div class="form-group">
          <label>Program Type</label>
          <input type="text" id="t-prog-type" placeholder="e.g. Music">
        </div>
        <div class="form-group">
          <label>Production Source</label>
          <input type="text" id="t-prod-source" placeholder="e.g. Live, Library">
        </div>
        <div class="form-group">
          <label>Music Usage</label>
          <input type="text" id="t-music-usage" placeholder="e.g. Feature, Background">
        </div>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:10px">
        % Play weight: 100 = normal; 200 = twice as likely; 50 = half as likely. Announcer 0 = no restriction.
      </p>
    </div>

    <!-- Tab 6: Restrictions -->
    <div class="tm-panel" id="tmp-restrict">
      <div class="form-grid">
        <div class="form-group"><label>Start Hour (0–23)</label><input type="number" id="t-start-hour" min="0" max="23" placeholder="0"></div>
        <div class="form-group"><label>End Hour (0–23)</label><input type="number" id="t-end-hour" min="0" max="23" placeholder="23"></div>
        <div class="form-group"><label>Active From Date</label><input type="date" id="t-start-date"></div>
        <div class="form-group"><label>Active Until Date</label><input type="date" id="t-end-date"></div>
        <div class="form-group"><label>Hit Date</label><input type="date" id="t-hit-date"></div>
        <div class="form-group"><label>ID in Player / Automation</label><input type="text" id="t-player-id" placeholder="e.g. VINE-921"></div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:16px;margin-top:14px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-beginning" style="width:auto;accent-color:var(--accent)"> Beginning of hour only
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-ending" style="width:auto;accent-color:var(--accent)"> End of hour only
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-hr-restricted" style="width:auto;accent-color:var(--accent)"> Hour restricted
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-native" style="width:auto;accent-color:var(--accent)"> Native Content
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-prior-approval" style="width:auto;accent-color:var(--accent)"> Prior Approval Required
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;text-transform:none;letter-spacing:0;color:var(--text)">
          <input type="checkbox" id="t-mcps" style="width:auto;accent-color:var(--accent)"> MCPS Licensed
        </label>
      </div>
    </div>

    <!-- Tab 6: Licensing -->
    <div class="tm-panel" id="tmp-license">
      <div class="form-grid">
        <div class="form-group"><label>Composer</label><input type="text" id="t-composer"></div>
        <div class="form-group"><label>Arranger</label><input type="text" id="t-arranger"></div>
        <div class="form-group"><label>Publisher</label><input type="text" id="t-publisher"></div>
        <div class="form-group"><label>Catalog Number</label><input type="text" id="t-catalog-num"></div>
        <div class="form-group"><label>Work Code</label><input type="text" id="t-work-code"></div>
        <div class="form-group"><label>Recording Code</label><input type="text" id="t-recording-code"></div>
        <div class="form-group"><label>ISCI Code</label><input type="text" id="t-isci"></div>
        <div class="form-group"><label>Origin / Source</label><input type="text" id="t-origin" placeholder="e.g. Domestic"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-track')">Cancel</button>
      <button class="btn btn-primary" id="modal-track-save-btn" onclick="saveTrack()">Add Track</button>
    </div>
  </div>
</div>

<!-- Clock Builder -->
<div class="modal-bg" id="modal-clock">
  <div class="modal" style="width:min(560px,96vw)">
    <h3 id="clock-modal-title">New Clock Template</h3>
    <div class="form-group" style="margin-bottom:12px">
      <label>Clock Name</label>
      <input type="text" id="clock-name" style="width:100%" placeholder="e.g. Morning Drive">
    </div>
    <label style="font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);display:block;margin-bottom:8px">Slots</label>
    <div id="slots-list" style="max-height:52vh;overflow-y:auto;padding-right:4px"></div>
    <button class="btn btn-muted btn-sm" onclick="addSlot()" style="margin-top:6px">+ Add Slot</button>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-clock')">Cancel</button>
      <button class="btn btn-primary" id="clock-save-btn" onclick="saveClock()">Create Clock</button>
    </div>
  </div>
</div>

<!-- Schedule Viewer -->
<div class="modal-bg" id="modal-schedule">
  <div class="modal" style="width:min(1020px,96vw);max-height:94vh">
    <h3 id="modal-sched-title"></h3>
    <div id="modal-sched-stats" class="stats" style="margin-bottom:12px"></div>

    <!-- View mode toggle -->
    <div class="view-toggle">
      <button class="active" id="vt-list"     onclick="switchView('list')">&#9776; List</button>
      <button              id="vt-blocks"   onclick="switchView('blocks')">&#9632; Hour Blocks</button>
      <button              id="vt-timeline" onclick="switchView('timeline')">&#9472; Timeline</button>
    </div>

    <!-- Violation panel -->
    <div id="viol-panel" class="viol-panel" style="display:none">
      <div class="viol-stats" id="viol-stats"></div>
      <div class="viol-list" id="viol-list"></div>
    </div>

    <!-- LIST view -->
    <div id="view-list" class="tbl-wrap">
      <table>
        <thead><tr><th>#</th><th>Air</th><th>Title</th><th>Artist</th><th>Category</th><th>Dur</th></tr></thead>
        <tbody id="modal-sched-body"></tbody>
      </table>
    </div>

    <!-- HOUR BLOCKS view -->
    <div id="view-blocks" style="display:none;max-height:60vh;overflow-y:auto"></div>

    <!-- TIMELINE view -->
    <div id="view-timeline" style="display:none;max-height:60vh;overflow-y:auto">
      <div class="timeline-wrap">
        <div class="tl-ruler" id="tl-ruler"></div>
        <div class="timeline" id="tl-tracks"></div>
      </div>
    </div>

    <div class="modal-actions" id="modal-sched-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-schedule')">Close</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ── Utilities ────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);

// ── Category map ─────────────────────────────────────────────────────────────
// Keyed by m1_id (string), uuid, and name — all pointing to the category record.
let _catMap  = {};   // key → category record
let _catList = [];   // sorted list of schedulable categories (for dropdowns)
let _allCats = [];   // complete category list (for library filter dropdown)

async function loadCategories() {
  const data = await api('GET', '/api/categories');
  const all  = data.categories || [];
  _catMap = {};
  for (const cat of all) {
    if (cat.m1_id != null)  _catMap[String(cat.m1_id)] = cat;
    if (cat.id)             _catMap[cat.id]             = cat;
    if (cat.name)           _catMap[cat.name]           = cat;
  }
  // All categories sorted by name for the library filter
  _allCats = all.slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  // Schedulable categories for dropdowns (exclude housekeeping ones)
  _catList = all.filter(c =>
    c.schedulable !== false &&
    !(c.name || '').startsWith('(')
  ).sort((a, b) => (a.priority || 0) - (b.priority || 0));
}

// Resolve any category key (m1_id / uuid / name) to a display record
function catResolve(c) {
  return _catMap[String(c)] || null;
}
// Value to use in selects for a category record (prefer m1_id, fall back to name)
function catValue(rec) {
  return rec.m1_id != null ? String(rec.m1_id) : (rec.name || rec.id);
}
const api = async (method, path, body) => {
  const r = await fetch(path, {
    method,
    headers: body ? {'Content-Type':'application/json'} : {},
    body: body ? JSON.stringify(body) : undefined,
  });
  if (r.status === 204) return null;
  return r.json();
};
const toast = (msg, ok=true) => {
  const el = $('toast');
  el.textContent = msg;
  el.className = 'show ' + (ok ? 'ok' : 'err');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.className = '', 2800);
};
const fmtDur = s => s ? `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}` : '—';
const fmtDate = s => s ? new Date(s).toLocaleDateString() : '—';
const timeAgo = s => {
  if (!s) return '—';
  const d = (Date.now() - new Date(s)) / 1000;
  if (d < 60)   return 'just now';
  if (d < 3600) return `${Math.floor(d/60)}m ago`;
  if (d < 86400) return `${Math.floor(d/3600)}h ago`;
  return `${Math.floor(d/86400)}d ago`;
};
const CAT_COLORS = {Current:'pill-purple',Recurrent:'pill-blue',Gold:'pill-orange',Power:'pill-green',Jingle:'pill-pink'};
const catPill = c => {
  const rec  = catResolve(c);
  const name = rec ? rec.name : (c || '—');
  if (rec && rec.color) {
    // Use the category's own M1 colour with a subtle tint
    const hex = rec.color;
    return `<span class="pill" style="background:${hex}28;color:${hex};border:1px solid ${hex}55" title="${esc(name)}">${esc(name)}</span>`;
  }
  return `<span class="pill ${CAT_COLORS[name]||'pill-blue'}">${esc(name)}</span>`;
};
function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
const _NAV_TABS = ['dashboard','tracks','clocks','schedules','program','export','rules','soundcodes','bulk','traffic','announcers'];
const navBtn = name => document.querySelector(`nav button:nth-child(${_NAV_TABS.indexOf(name)+1})`);

// ── Tabs ─────────────────────────────────────────────────────────────────────
function showTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  $('tab-'+name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name==='dashboard') loadDashboard();
  if (name==='tracks')    initTracksTab();
  if (name==='clocks')    loadClocks();
  if (name==='schedules') { loadSchedules(); loadClocksForGen(); }
  if (name==='program')    loadProgramTab();
  if (name==='export')     loadExportTab();
  if (name==='rules')      loadRules();
  if (name==='soundcodes') loadSoundCodes();
  if (name==='bulk')       initBulkTab();
  if (name==='traffic')    loadTraffic();
  if (name==='announcers') loadAnnouncers();
}

// ── Modals ────────────────────────────────────────────────────────────────────
function openModal(id)  { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

// ── Dashboard ─────────────────────────────────────────────────────────────────
async function loadDashboard() {
  const [tracksData, schedules, clocks] = await Promise.all([
    api('GET', '/api/tracks?limit=0'),
    api('GET', '/api/schedules'),
    api('GET', '/api/clocks'),
  ]);
  const tracks = tracksData.tracks || [];
  const totalDur = tracks.reduce((s,t) => s+(t.duration_seconds||0), 0);

  $('dash-stats').innerHTML = [
    ['Total Tracks', tracksData.total ?? tracks.length],
    ['Library Duration', fmtDur(totalDur)],
    ['Schedules', schedules.length],
    ['Clock Templates', clocks.length],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');

  // Recent schedules
  const recent = [...schedules].sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||'')).slice(0,5);
  $('dash-activity').innerHTML = recent.length
    ? recent.map(s => `
        <div class="activity-item">
          <div class="activity-dot"></div>
          <div class="activity-text"><strong>${esc(s.name||'Untitled')}</strong> — ${(s.tracks||[]).length} tracks, ${s.duration_minutes||0} min</div>
          <div class="activity-time">${timeAgo(s.created_at)}</div>
          <button class="btn btn-muted btn-sm" onclick="viewScheduleById('${s.id}')">View</button>
        </div>`).join('')
    : '<div class="empty">No schedules yet — generate one!</div>';
}

// ── Tracks ────────────────────────────────────────────────────────────────────
const TRACKS_PER_PAGE = 200;
let _tracksTotal = 0;
let _tracksLoaded = 0;

function initTracksTab() {
  populateCatFilter();   // fill dropdown from full category list immediately
  buildColPicker();      // render column picker panel
  renderTableHeader();   // render thead based on active columns
  // Only reload if a filter is already active (e.g. user switched away and back)
  const search = $('track-search').value.trim();
  const cat    = $('track-cat').value;
  if (search || cat) {
    loadTracks();
  } else {
    $('tracks-body').innerHTML = '';
    $('tracks-empty').textContent = 'Select a category or type in the search box to browse your library.';
    $('tracks-empty').style.display = '';
    $('tracks-footer').style.display = 'none';
    $('track-stats').innerHTML = '';
  }
}

async function loadTracks() {
  const search = $('track-search').value.trim();
  const cat    = $('track-cat').value;
  const tempo  = $('track-tempo')?.value || '';
  const gender = $('track-gender')?.value || '';
  const mood   = $('track-mood')?.value  || '';
  const active = $('track-active')?.value || '';
  const sort   = $('track-sort').value;
  const order  = $('track-order').value;

  // No filter set — return to prompt state without hitting the API
  if (!search && !cat && !tempo && !gender && !mood && !active) {
    $('tracks-body').innerHTML = '';
    $('tracks-empty').textContent = 'Select a category or type in the search box to browse your library.';
    $('tracks-empty').style.display = '';
    $('tracks-footer').style.display = 'none';
    $('track-stats').innerHTML = '';
    return;
  }

  const colCount = 3 + _loadCols().length + 1;
  $('tracks-body').innerHTML = `<tr><td colspan="${colCount}" style="text-align:center;padding:24px;color:var(--muted)">Loading library…</td></tr>`;
  $('tracks-empty').style.display = 'none';
  $('tracks-footer').style.display = 'none';

  let url = `/api/tracks?sort=${sort}&order=${order}&limit=${TRACKS_PER_PAGE}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (cat)    url += `&category=${encodeURIComponent(cat)}`;
  if (tempo)  url += `&tempo=${encodeURIComponent(tempo)}`;
  if (gender) url += `&gender=${encodeURIComponent(gender)}`;
  if (mood)   url += `&mood=${encodeURIComponent(mood)}`;
  if (active) url += `&active=${encodeURIComponent(active)}`;
  const data = await api('GET', url);
  const tracks = data.tracks || [];
  _tracksTotal  = data.total || tracks.length;
  _tracksLoaded = tracks.length;

  renderTracks(tracks);
  updateTrackStats(tracks, _tracksTotal);
  populateCatFilter();

  $('tracks-footer').style.display = 'flex';
  $('tracks-count').textContent = _tracksLoaded >= _tracksTotal
    ? `Showing all ${_tracksTotal.toLocaleString()} tracks`
    : `Showing ${_tracksLoaded.toLocaleString()} of ${_tracksTotal.toLocaleString()} tracks`;
  $('tracks-load-more').style.display = _tracksLoaded < _tracksTotal ? '' : 'none';
}

async function loadMoreTracks() {
  const search = $('track-search').value.trim();
  const cat    = $('track-cat').value;
  const tempo  = $('track-tempo')?.value || '';
  const gender = $('track-gender')?.value || '';
  const mood   = $('track-mood')?.value  || '';
  const active = $('track-active')?.value || '';
  const sort   = $('track-sort').value;
  const order  = $('track-order').value;

  $('tracks-load-more').textContent = 'Loading…';
  $('tracks-load-more').disabled = true;

  let url = `/api/tracks?sort=${sort}&order=${order}&limit=${TRACKS_PER_PAGE}&offset=${_tracksLoaded}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (cat)    url += `&category=${encodeURIComponent(cat)}`;
  if (tempo)  url += `&tempo=${encodeURIComponent(tempo)}`;
  if (gender) url += `&gender=${encodeURIComponent(gender)}`;
  if (mood)   url += `&mood=${encodeURIComponent(mood)}`;
  if (active) url += `&active=${encodeURIComponent(active)}`;
  const data = await api('GET', url);
  const newTracks = data.tracks || [];
  _tracksLoaded += newTracks.length;

  // Append rows instead of replacing
  $('tracks-body').innerHTML += newTracks.map((t, i) => renderTrackRow(t, _tracksLoaded - newTracks.length + i)).join('');

  $('tracks-count').textContent = _tracksLoaded >= _tracksTotal
    ? `Showing all ${_tracksTotal.toLocaleString()} tracks`
    : `Showing ${_tracksLoaded.toLocaleString()} of ${_tracksTotal.toLocaleString()} tracks`;
  $('tracks-load-more').textContent = 'Load more…';
  $('tracks-load-more').disabled = false;
  $('tracks-load-more').style.display = _tracksLoaded < _tracksTotal ? '' : 'none';
}
function populateCatFilter() {
  const sel = $('track-cat');
  const cur = sel.value;
  // Use the full category list from the API so all categories are visible
  // regardless of which page of tracks is currently loaded.
  sel.innerHTML = '<option value="">All categories</option>' +
    _allCats.map(c => {
      const v = catValue(c);
      return `<option value="${esc(v)}" ${v===cur?'selected':''}>${esc(c.name)}</option>`;
    }).join('');
}
const TEMPO_LABELS   = ['','SL','MS','ME','MF','FA'];
const TEMPO_CLASSES  = ['','tempo-sl','tempo-ms','tempo-me','tempo-mf','tempo-fa'];
const MOOD_LABELS    = ['','Joyful','Inspir.','Reflect.','Contemp.','Somber'];
const MOOD_CLASSES   = ['','mood-1','mood-2','mood-3','mood-4','mood-5'];
const TEX_LABELS     = ['','Open','Light','Med','Full','Busy'];
const GENDER_LABELS  = ['','Male','Female','Group','Instr.','Mixed'];
const KEY_LABELS     = ['','C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

function fmtTempo(v) {
  if (!v) return '<span style="color:var(--muted)">—</span>';
  return `<span class="${TEMPO_CLASSES[v]||''}">${TEMPO_LABELS[v]||v}</span>`;
}
function fmtMood(v) {
  if (!v) return '<span style="color:var(--muted)">—</span>';
  return `<span class="attr-chip ${MOOD_CLASSES[v]||''}">${MOOD_LABELS[v]||v}</span>`;
}
function fmtTexture(v) {
  if (!v) return '<span style="color:var(--muted)">—</span>';
  return `<span class="attr-chip tex-chip">${TEX_LABELS[v]||v}</span>`;
}
function fmtGender(v) {
  if (!v) return '<span style="color:var(--muted)">—</span>';
  return `<span class="attr-chip gen-chip">${GENDER_LABELS[v]||v}</span>`;
}
function fmtSec(sec) {
  if (!sec) return '<span style="color:var(--muted)">—</span>';
  const s = +sec;
  if (s >= 60) return `<span style="font-size:11px;color:var(--muted)">${Math.floor(s/60)}:${String(Math.round(s%60)).padStart(2,'0')}</span>`;
  return `<span style="font-size:11px;color:var(--muted)">${s.toFixed(1)}s</span>`;
}
function fmtMs(ms) {
  if (!ms) return '<span style="color:var(--muted)">—</span>';
  return fmtSec(ms/1000);
}
function fmtLastPlay(dt) {
  if (!dt) return '<span class="lp-date">Never</span>';
  try {
    return `<span class="lp-date">${new Date(dt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'})}</span>`;
  } catch { return '<span class="lp-date">—</span>'; }
}
function fmtSoundCodes(t) {
  // Accept both sound_codes array and legacy sc1..sc30 booleans
  let active = Array.isArray(t.sound_codes) ? [...t.sound_codes] : [];
  if (!active.length) {
    for (let i = 1; i <= 30; i++) { if (t[`sc${i}`] || t[`SC${i}`]) active.push(i); }
  }
  if (!active.length) return '<span style="color:var(--muted)">—</span>';
  return active.slice(0,4).map(n => `<span style="font-size:10px;background:rgba(108,99,255,.15);color:#b8b0ff;padding:1px 4px;border-radius:3px">${n}</span>`).join(' ')
    + (active.length > 4 ? `<span style="font-size:10px;color:var(--muted)"> +${active.length-4}</span>` : '');
}
function fmtActive(v) {
  if (v === false) return '<span style="font-size:10px;background:rgba(252,129,129,.15);color:#f87171;padding:1px 6px;border-radius:3px">OFF</span>';
  return '<span style="font-size:10px;background:rgba(72,187,120,.12);color:#68d391;padding:1px 6px;border-radius:3px">ON</span>';
}
function fmtPct(v) {
  if (!v && v !== 0) return '<span style="color:var(--muted)">—</span>';
  const n = +v;
  const col = n > 100 ? '#68d391' : n < 100 ? '#f6ad55' : 'var(--muted)';
  return `<span class="attr-chip pct-chip" style="color:${col}">${n}%</span>`;
}

// ── Column Definitions (order = display order; key = t[key] field) ───────────
const TRACK_COLS = [
  { id: 'cart',          label: 'Cart #',       group: 'Core',
    render: t => (t.cart||t.cart_number) ? `<span class="cart-chip">${esc(t.cart||t.cart_number)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'duration',      label: 'Duration',     group: 'Core',
    render: t => `<span class="dur">${fmtDur(t.duration_seconds)}</span>` },
  { id: 'category',      label: 'Category',     group: 'Core',
    render: t => catPill(t.category) },
  { id: 'intro',         label: 'Intro',        group: 'Timing',
    render: t => fmtMs(t.intro_ms) },
  { id: 'outro',         label: 'Outro',        group: 'Timing',
    render: t => fmtMs(t.outro_ms) },
  { id: 'hook_in',       label: 'Hook In',      group: 'Timing',
    render: t => fmtMs(t.hook_in_ms) },
  { id: 'mix_in',        label: 'Mix In',       group: 'Timing',
    render: t => fmtMs(t.mix_in_ms) },
  { id: 'mix_out',       label: 'Mix Out',      group: 'Timing',
    render: t => fmtMs(t.mix_out_ms) },
  { id: 'bpm',           label: 'BPM',          group: 'Timing',
    render: t => t.bpm ? `<span style="font-size:11px;color:var(--muted)">${t.bpm}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'tempo',         label: 'Tempo',        group: 'Attributes',
    render: t => fmtTempo(t.tempo) },
  { id: 'mood',          label: 'Mood',         group: 'Attributes',
    render: t => fmtMood(t.mood) },
  { id: 'texture',       label: 'Texture',      group: 'Attributes',
    render: t => fmtTexture(t.texture) },
  { id: 'gender',        label: 'Gender',       group: 'Attributes',
    render: t => fmtGender(t.gender) },
  { id: 'key',           label: 'Key',          group: 'Attributes',
    render: t => t.key1 ? `<span style="font-size:11px;color:var(--muted)">${KEY_LABELS[t.key1]||'?'}${t.key2?'/'+KEY_LABELS[t.key2]:''}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'sound_codes',   label: 'Sound Codes',  group: 'Attributes',
    render: t => fmtSoundCodes(t) },
  { id: 'play_count',    label: 'Plays',        group: 'Play History',
    render: t => `<span style="font-size:12px">${t.play_count||0}</span>` },
  { id: 'last_played_at',label: 'Last Play',    group: 'Play History',
    render: t => fmtLastPlay(t.last_played_at) },
  { id: 'active',        label: 'Active',       group: 'Scheduling',
    render: t => fmtActive(t.active) },
  { id: 'pct_play',      label: '% Play',       group: 'Scheduling',
    render: t => fmtPct(t.pct_play) },
  { id: 'chart_position',label: 'Chart Pos',    group: 'Scheduling',
    render: t => t.chart_position ? `<span style="font-size:11px;color:var(--muted)">#${t.chart_position}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'announcer',     label: 'Announcer',    group: 'Scheduling',
    render: t => t.announcer ? `<span style="font-size:11px;color:var(--accent)">${t.announcer}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'album',         label: 'Album',        group: 'Metadata',
    render: t => t.album ? `<span style="font-size:11px">${esc(t.album)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'genre',         label: 'Genre',        group: 'Metadata',
    render: t => t.genre ? `<span style="font-size:11px">${esc(t.genre)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'record_label',  label: 'Label',        group: 'Metadata',
    render: t => t.record_label ? `<span style="font-size:11px">${esc(t.record_label)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'composer',      label: 'Composer',     group: 'Metadata',
    render: t => t.composer ? `<span style="font-size:11px">${esc(t.composer)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'isrc_code',     label: 'ISRC',         group: 'Licensing',
    render: t => (t.isrc_code||t.isci_code) ? `<span class="cart-chip">${esc(t.isrc_code||t.isci_code)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'file_path',     label: 'File Path',    group: 'Automation',
    render: t => t.file_path ? `<span style="font-size:11px;font-family:monospace;color:var(--muted)">${esc(t.file_path)}</span>` : '<span style="color:var(--muted)">—</span>' },
  { id: 'added_at',      label: 'Date Added',   group: 'History',
    render: t => t.added_at ? `<span style="font-size:11px;color:var(--muted)">${t.added_at.slice(0,10)}</span>` : '<span style="color:var(--muted)">—</span>' },
];

const DEFAULT_COLS = ['cart','duration','category','intro','tempo','sound_codes','play_count','last_played_at'];
const LS_KEY = 'trackLibCols';

let _activeCols = null; // null = not loaded yet

function _loadCols() {
  if (_activeCols) return _activeCols;
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    _activeCols = Array.isArray(saved) ? saved : [...DEFAULT_COLS];
  } catch { _activeCols = [...DEFAULT_COLS]; }
  return _activeCols;
}
function _saveCols() {
  localStorage.setItem(LS_KEY, JSON.stringify(_activeCols));
}
function isColActive(id) { return _loadCols().includes(id); }

function buildColPicker() {
  const grid = $('col-picker-grid');
  if (!grid) return;
  const cols = _loadCols();
  // Group by group
  const groups = {};
  TRACK_COLS.forEach(c => { (groups[c.group] = groups[c.group]||[]).push(c); });
  grid.innerHTML = Object.entries(groups).map(([grp, cs]) =>
    `<div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:2px;margin-top:6px;grid-column:1/-1">${grp}</div>` +
    cs.map(c => {
      const on = cols.includes(c.id);
      return `<label class="col-pill ${on?'on':''}" id="cp-${c.id}">
        <input type="checkbox" ${on?'checked':''} onchange="toggleCol('${c.id}',this.checked)">
        ${esc(c.label)}
      </label>`;
    }).join('')
  ).join('');
}
function toggleCol(id, on) {
  _loadCols();
  if (on && !_activeCols.includes(id)) _activeCols.push(id);
  if (!on) _activeCols = _activeCols.filter(x => x !== id);
  const pill = document.getElementById('cp-'+id);
  if (pill) pill.classList.toggle('on', on);
  _saveCols();
  renderTableHeader();
  renderTracks(_lastTracks);
}
function selectAllCols()     { _activeCols = TRACK_COLS.map(c=>c.id); _saveCols(); buildColPicker(); renderTableHeader(); renderTracks(_lastTracks); }
function selectNoneCols()    { _activeCols = []; _saveCols(); buildColPicker(); renderTableHeader(); renderTracks(_lastTracks); }
function selectDefaultCols() { _activeCols = [...DEFAULT_COLS]; _saveCols(); buildColPicker(); renderTableHeader(); renderTracks(_lastTracks); }

function toggleColPicker(e) {
  e.stopPropagation();
  const panel = $('col-picker-panel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) buildColPicker();
}
document.addEventListener('click', e => {
  const wrap = $('col-picker-wrap');
  if (wrap && !wrap.contains(e.target)) $('col-picker-panel')?.classList.remove('open');
});

function renderTableHeader() {
  const cols = _loadCols();
  const thead = $('tracks-thead');
  if (!thead) return;
  const defs = TRACK_COLS.filter(c => cols.includes(c.id));
  thead.innerHTML = `<tr>
    <th>#</th><th>Title</th><th>Artist</th>
    ${defs.map(c => `<th>${esc(c.label)}</th>`).join('')}
    <th></th>
  </tr>`;
}

let _lastTracks = [];

function renderTrackRow(t, i) {
  const cols = _loadCols();
  const defs = TRACK_COLS.filter(c => cols.includes(c.id));
  return `<tr>
    <td class="track-pos">${i+1}</td>
    <td><strong>${esc(t.title)}</strong>${t.alt_artists?`<div style="font-size:11px;color:var(--muted)">${esc(t.alt_artists)}</div>`:''}</td>
    <td>${esc(t.artist||'')}</td>
    ${defs.map(c => `<td>${c.render(t)}</td>`).join('')}
    <td style="white-space:nowrap">
      <button class="btn btn-muted btn-sm" onclick="openEditTrack('${t.id}')" style="margin-right:4px">Edit</button>
      <button class="btn btn-danger btn-sm" onclick="deleteTrack('${t.id}')">✕</button>
    </td>
  </tr>`;
}
function renderTracks(tracks) {
  _lastTracks = tracks;
  renderTableHeader();
  const empty = $('tracks-empty');
  if (tracks.length) {
    empty.style.display = 'none';
  } else {
    empty.textContent = 'No tracks found for this search.';
    empty.style.display = '';
  }
  $('tracks-body').innerHTML = tracks.map((t, i) => renderTrackRow(t, i)).join('');
}
function updateTrackStats(tracks, total) {
  const totalDur = tracks.reduce((s,t) => s+(t.duration_seconds||0), 0);
  const cats = new Set(tracks.map(t=>t.category).filter(Boolean)).size;
  $('track-stats').innerHTML = [
    ['Tracks', total ?? tracks.length],
    ['Total Duration', fmtDur(totalDur)],
    ['Categories', cats],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');
}
// Sound code names (from PraiseFM M1 database — stations can customise in Vars)
const SC_NAMES = [
  null,                             // 0 (unused)
  'Call To Worship','Proclamation','Testimony','Horizontal','Vertical',
  'SC 6','Christmas','Easter','SC 9','SC 10',
  'Africa Call','Africa Proc','Africa Test','Africa Hori','Africa Vert',
  'SC 16','SC 17','SC 18','SC 19','SC 20',
  'SC 21','SC 22','SC 23','SC 24','SC 25',
  'SC 26','SC 27','SC 28','SC 29','SC 30',
];

function buildScCheckboxes(track) {
  const container = $('sc-checkboxes');
  container.innerHTML = '';
  for (let i = 1; i <= 30; i++) {
    const name = SC_NAMES[i] || `SC ${i}`;
    const key  = `sc${i}`;
    const checked = track && (track[key] || track[`SC${i}`]) ? 'checked' : '';
    const dim = (i > 15 && name.startsWith('SC ')) ? 'style="opacity:.45"' : '';
    container.innerHTML += `<label class="sc-item" ${dim}>
      <input type="checkbox" id="t-sc${i}" ${checked}>
      <span>${i}. ${esc(name)}</span>
    </label>`;
  }
}

function showTmTab(name, btn) {
  document.querySelectorAll('.tm-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tm-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  $('tmp-' + name).classList.add('active');
}

let _editingTrackId = null;

function _resetTrackForm() {
  // Reset all tabs to show Basic
  document.querySelectorAll('.tm-tab').forEach((t,i) => t.classList.toggle('active', i===0));
  document.querySelectorAll('.tm-panel').forEach((p,i) => p.classList.toggle('active', i===0));
  // Text + number inputs
  ['t-title','t-artist','t-alt-artists','t-cart','t-genre','t-album','t-record-label','t-notes',
   't-duration','t-intro','t-outro','t-hookin','t-hookout','t-mixin','t-mixout','t-bpm','t-energy',
   't-user1','t-user2','t-user3','t-user4',
   't-chart-pos','t-chart-pos2','t-player-id','t-origin',
   't-composer','t-arranger','t-publisher','t-catalog-num','t-work-code','t-recording-code','t-isci',
   't-pct-play','t-file-path','t-auto-params','t-prog-type','t-prod-source','t-music-usage',
  ].forEach(id => { if ($(id)) $(id).value = ''; });
  // Date inputs
  ['t-start-date','t-end-date','t-hit-date'].forEach(id => { if ($(id)) $(id).value = ''; });
  // Selects with empty default
  ['t-category','t-tempo','t-tempo-min','t-tempo-max',
   't-gender','t-mood','t-texture','t-texture-min','t-texture-max','t-key1','t-key2',
   't-link-type'].forEach(id => { if ($(id)) $(id).value = ''; });
  // Selects with non-empty default
  if ($('t-active')) $('t-active').value = 'true';
  if ($('t-announcer')) $('t-announcer').value = '0';
  // Checkboxes
  ['t-beginning','t-ending','t-hr-restricted','t-native','t-prior-approval','t-mcps'].forEach(id => {
    if ($(id)) $(id).checked = false;
  });
}

async function _populateAnnouncerSelect(selectedId) {
  const sel = $('t-announcer');
  if (!sel) return;
  try {
    const data = await api('GET', '/api/announcers');
    const announcers = data.announcers || data || [];
    const current = sel.value || selectedId || '0';
    sel.innerHTML = '<option value="0">— Any announcer —</option>' +
      announcers.filter(a => a.active !== false).map(a =>
        `<option value="${esc(String(a.id))}" ${String(a.id) === String(current) ? 'selected' : ''}>${esc(a.name)}</option>`
      ).join('');
    if (selectedId) sel.value = String(selectedId);
  } catch (e) {
    // If announcers not loaded, just leave default option
  }
}

function _fillTrackForm(t) {
  const set = (id, val) => { if ($(id) && val != null) $(id).value = val; };
  const setChk = (id, val) => { if ($(id)) $(id).checked = !!val; };
  // Basic Info
  set('t-title', t.title);
  set('t-artist', t.artist);
  set('t-alt-artists', t.alt_artists);
  set('t-cart', t.cart || t.cart_number);
  set('t-genre', t.genre);
  set('t-album', t.album);
  set('t-record-label', t.record_label);
  set('t-notes', t.notes);
  set('t-chart-pos', t.chart_position);
  // Timing
  set('t-duration', t.duration_seconds);
  set('t-intro', t.intro_seconds ?? (t.intro_ms ? t.intro_ms/1000 : null));
  set('t-outro', t.outro_seconds ?? (t.outro_ms ? t.outro_ms/1000 : null));
  set('t-hookin', t.hook_in_seconds ?? (t.hook_in_ms ? t.hook_in_ms/1000 : null));
  set('t-hookout', t.hook_out_seconds ?? (t.hook_out_ms ? t.hook_out_ms/1000 : null));
  set('t-mixin', t.mix_in_seconds ?? (t.mix_in_ms ? t.mix_in_ms/1000 : null));
  set('t-mixout', t.mix_out_seconds ?? (t.mix_out_ms ? t.mix_out_ms/1000 : null));
  set('t-bpm', t.bpm);
  set('t-energy', t.energy);
  // Attributes
  set('t-tempo', t.tempo);
  set('t-tempo-min', t.tempo_min);
  set('t-tempo-max', t.tempo_max);
  set('t-gender', t.gender);
  set('t-mood', t.mood);
  set('t-texture', t.texture);
  set('t-texture-min', t.texture_min);
  set('t-texture-max', t.texture_max);
  set('t-key1', t.key1);
  set('t-key2', t.key2);
  set('t-user1', t.user1);
  set('t-user2', t.user2);
  set('t-user3', t.user3);
  set('t-user4', t.user4);
  // Scheduling
  if ($('t-active'))    $('t-active').value    = t.active === false ? 'false' : 'true';
  set('t-pct-play', t.pct_play);
  if ($('t-announcer')) $('t-announcer').value = t.announcer ?? 0;
  if ($('t-link-type')) $('t-link-type').value = t.link_type ?? 0;
  set('t-chart-pos2', t.chart_position);
  set('t-file-path', t.file_path);
  set('t-auto-params', t.auto_params);
  set('t-prog-type', t.prog_type);
  set('t-prod-source', t.prod_source);
  set('t-music-usage', t.music_usage);
  // Restrictions
  set('t-player-id', t.id_in_player);
  set('t-origin', t.origin);
  set('t-start-date', t.start_date);
  set('t-end-date', t.end_date);
  set('t-hit-date', t.hit_date);
  set('t-start-hour', t.start_hour);
  set('t-end-hour', t.end_hour);
  setChk('t-beginning', !t.can_open_hour);
  setChk('t-ending', !t.can_close_hour);
  setChk('t-hr-restricted', t.hour_restricted || t.hr_restricted);
  setChk('t-native', t.native_content);
  setChk('t-prior-approval', t.prior_approval);
  setChk('t-mcps', t.mcps);
  // Licensing
  set('t-composer', t.composer);
  set('t-arranger', t.arranger);
  set('t-publisher', t.publisher);
  set('t-catalog-num', t.catalog_num || t.catalog_number);
  set('t-work-code', t.work_code);
  set('t-recording-code', t.recording_code);
  set('t-isci', t.isrc_code || t.isci_code);
  // Category + Sound Codes
  $('t-category').innerHTML = _buildCatOptions(t.category);
  buildScCheckboxes(t);
  // Populate announcer select if needed
  _populateAnnouncerSelect(t.announcer);
}

function _collectTrackBody() {
  const g   = id => $(id) ? $(id).value.trim() : '';
  const n   = id => { const v = $(id) ? +$(id).value : NaN; return isNaN(v) || !$(id) || $(id).value==='' ? undefined : v; };
  const chk = id => $(id) ? $(id).checked : false;

  const body = { title: g('t-title'), artist: g('t-artist'), category: $('t-category').value };
  const str  = (key, id)   => { const v = g(id);  if (v !== '') body[key] = v; };
  const num  = (key, id)   => { const v = n(id);  if (v !== undefined) body[key] = v; };
  const sel  = (key, id)   => { const v = n(id);  if (v) body[key] = v; };

  // Basic Info
  str('alt_artists','t-alt-artists');  str('cart','t-cart');
  str('genre','t-genre');              str('album','t-album');
  str('record_label','t-record-label'); str('notes','t-notes');
  sel('chart_position','t-chart-pos');

  // Timing (seconds → ms for m1 fields)
  num('duration_seconds','t-duration');
  num('intro_seconds','t-intro');      num('outro_seconds','t-outro');
  num('hook_in_seconds','t-hookin');   num('hook_out_seconds','t-hookout');
  num('mix_in_seconds','t-mixin');     num('mix_out_seconds','t-mixout');
  num('bpm','t-bpm');                  num('energy','t-energy');

  // Attributes
  sel('tempo','t-tempo');     sel('tempo_min','t-tempo-min');   sel('tempo_max','t-tempo-max');
  sel('gender','t-gender');   sel('mood','t-mood');
  sel('texture','t-texture'); sel('texture_min','t-texture-min'); sel('texture_max','t-texture-max');
  sel('key1','t-key1');       sel('key2','t-key2');
  str('user1','t-user1'); str('user2','t-user2'); str('user3','t-user3'); str('user4','t-user4');

  // Scheduling
  if ($('t-active'))    body.active     = $('t-active').value === 'true';
  sel('pct_play','t-pct-play');
  const ann = n('t-announcer'); if (ann !== undefined) body.announcer = ann;
  const lnk = n('t-link-type'); if (lnk !== undefined) body.link_type = lnk;
  sel('chart_position','t-chart-pos2');    // chart-pos2 takes precedence if set
  str('file_path','t-file-path');
  str('auto_params','t-auto-params');
  str('prog_type','t-prog-type');          str('prod_source','t-prod-source');
  str('music_usage','t-music-usage');

  // Restrictions
  str('id_in_player','t-player-id'); str('origin','t-origin');
  str('start_date','t-start-date'); str('end_date','t-end-date'); str('hit_date','t-hit-date');
  const sh = n('t-start-hour'); if (sh !== undefined) body.start_hour = sh;
  const eh = n('t-end-hour');   if (eh !== undefined) body.end_hour   = eh;
  body.can_open_hour    = !chk('t-beginning');
  body.can_close_hour   = !chk('t-ending');
  body.hour_restricted  = chk('t-hr-restricted');
  body.native_content   = chk('t-native');
  body.prior_approval   = chk('t-prior-approval');
  body.mcps             = chk('t-mcps');

  // Licensing
  str('composer','t-composer'); str('arranger','t-arranger'); str('publisher','t-publisher');
  str('catalog_num','t-catalog-num'); str('work_code','t-work-code');
  str('recording_code','t-recording-code'); str('isrc_code','t-isci');

  // Sound codes — store as array in sound_codes field (1-indexed)
  const codes = [];
  for (let i = 1; i <= 30; i++) {
    const el = $(`t-sc${i}`);
    if (el && el.checked) codes.push(i);
    // Also set legacy sc fields for backwards compatibility
    if (el) body[`sc${i}`] = el.checked;
  }
  body.sound_codes = codes;

  return body;
}

function openAddTrack() {
  _editingTrackId = null;
  $('modal-track-title').textContent = 'Add Track';
  $('modal-track-save-btn').textContent = 'Add Track';
  _resetTrackForm();
  buildScCheckboxes(null);
  $('t-category').innerHTML = _buildCatOptions('');
  openModal('modal-track');
}

async function openEditTrack(id) {
  _editingTrackId = id;
  $('modal-track-title').textContent = 'Edit Track';
  $('modal-track-save-btn').textContent = 'Save Changes';
  _resetTrackForm();
  const t = await api('GET', `/api/tracks/${id}`);
  if (t.error) return toast('Could not load track.', false);
  _fillTrackForm(t);
  openModal('modal-track');
}

async function saveTrack() {
  const body = _collectTrackBody();
  if (!body.title || !body.artist) return toast('Title and Artist are required.', false);
  let res;
  if (_editingTrackId) {
    res = await api('PUT', `/api/tracks/${_editingTrackId}`, body);
    if (res.error) return toast(res.error, false);
    closeModal('modal-track');
    toast('Track updated!');
  } else {
    res = await api('POST', '/api/tracks', body);
    if (res.error) return toast(res.error, false);
    closeModal('modal-track');
    toast('Track added!');
  }
  loadTracks();
}

async function deleteTrack(id) {
  if (!confirm('Delete this track?')) return;
  await api('DELETE', `/api/tracks/${id}`);
  toast('Track deleted.');
  loadTracks();
}

// ── Clocks ────────────────────────────────────────────────────────────────────
function _buildCatOptions(selectedVal) {
  // Use real categories loaded from API; value = m1_id (or name), label = name
  const opts = _catList.length
    ? _catList.map(c => {
        const v = catValue(c);
        const sel = v === String(selectedVal) ? ' selected' : '';
        return `<option value="${esc(v)}"${sel}>${esc(c.name)}</option>`;
      }).join('')
    : `<option>Current</option><option>Recurrent</option><option>Gold</option>`;
  return opts;
}

let _editingClockId = null;

function openClockModal() {
  _editingClockId = null;
  $('clock-modal-title').textContent = 'New Clock Template';
  $('clock-save-btn').textContent    = 'Create Clock';
  $('clock-name').value = '';
  $('slots-list').innerHTML = '';
  addSlot(); addSlot(); addSlot();
  openModal('modal-clock');
}
function editClock(clock) {
  _editingClockId = clock.id;
  $('clock-modal-title').textContent = 'Edit Clock Template';
  $('clock-save-btn').textContent    = 'Save Changes';
  $('clock-name').value = clock.name || '';
  $('slots-list').innerHTML = '';
  (clock.slots || []).forEach(s => {
    const div = document.createElement('div');
    div.className = 'slot-row';
    div.innerHTML = `<select>${_buildCatOptions(s.category || '')}</select><input type="number" placeholder="Min secs" min="0" value="${s.min_duration_seconds || s.nominal_length_s || 0}"><button class="btn btn-danger btn-sm" onclick="this.parentNode.remove()">✕</button>`;
    $('slots-list').appendChild(div);
  });
  if (!(clock.slots || []).length) addSlot();
  openModal('modal-clock');
}
function addSlot() {
  const div = document.createElement('div');
  div.className = 'slot-row';
  div.innerHTML = `<select>${_buildCatOptions('')}</select><input type="number" placeholder="Min secs" min="0"><button class="btn btn-danger btn-sm" onclick="this.parentNode.remove()">✕</button>`;
  $('slots-list').appendChild(div);
}
async function saveClock() {
  const name = $('clock-name').value.trim();
  if (!name) return toast('Clock name required.', false);
  const rows = $('slots-list').querySelectorAll('.slot-row');
  const slots = [...rows].map(r => {
    const [sel, inp] = r.querySelectorAll('select, input');
    return { category: sel.value, min_duration_seconds: +inp.value || 0 };
  });
  if (!slots.length) return toast('Add at least one slot.', false);
  let res;
  if (_editingClockId) {
    res = await api('PUT', `/api/clocks/${_editingClockId}`, { name, slots });
  } else {
    res = await api('POST', '/api/clocks', { name, slots });
  }
  if (res && res.error) return toast(res.error, false);
  closeModal('modal-clock');
  toast(_editingClockId ? 'Clock updated!' : 'Clock created!');
  _editingClockId = null;
  loadClocks();
}
let _clocksView = 'list';
let _allClocks  = [];

function setClocksView(v) {
  _clocksView = v;
  $('clocks-view-btn-list').classList.toggle('active', v === 'list');
  $('clocks-view-btn-clock').classList.toggle('active', v === 'clock');
  $('clocks-list-view').style.display  = v === 'list'  ? '' : 'none';
  $('clocks-clock-view').style.display = v === 'clock' ? '' : 'none';
}

function renderClockPieSVG(clock) {
  const slots = clock.slots || [];
  if (!slots.length) {
    return `<svg width="300" height="230" viewBox="0 0 300 230"><text x="150" y="115" text-anchor="middle" dominant-baseline="middle" fill="#7c85a2" font-size="12">No slots defined</text></svg>`;
  }
  // Aggregate by category, weighted by nominal_length_s
  const cats = {};
  slots.forEach(s => {
    const cat = s.category || 'Unknown';
    cats[cat] = (cats[cat] || 0) + (s.nominal_length_s || 210);
  });
  const entries = Object.entries(cats);
  const total   = entries.reduce((s, [, v]) => s + v, 0);

  const W = 300, H = 230, cx = W / 2, cy = H / 2, r = 72;
  let startAngle = -Math.PI / 2;
  let paths = '';

  entries.forEach(([cat, val], i) => {
    const angle    = (val / total) * 2 * Math.PI;
    const endAngle = startAngle + angle;
    const midA     = startAngle + angle / 2;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const large = angle > Math.PI ? 1 : 0;
    const col   = PIE_COLORS[i % PIE_COLORS.length];

    paths += `<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${large} 1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${col}" stroke="#0c0f1a" stroke-width="2"/>`;

    if (angle >= 0.14) {
      const rL1  = r + 3, rL2 = r + 20, rTx = r + 25;
      const lx1  = cx + rL1  * Math.cos(midA), ly1 = cy + rL1  * Math.sin(midA);
      const lx2  = cx + rL2  * Math.cos(midA), ly2 = cy + rL2  * Math.sin(midA);
      const tx   = cx + rTx  * Math.cos(midA), ty  = cy + rTx  * Math.sin(midA);
      const cosM = Math.cos(midA);
      const anchor = cosM > 0.12 ? 'start' : cosM < -0.12 ? 'end' : 'middle';
      const label  = cat.length > 15 ? cat.slice(0, 14) + '…' : cat;
      paths += `<line x1="${lx1.toFixed(1)}" y1="${ly1.toFixed(1)}" x2="${lx2.toFixed(1)}" y2="${ly2.toFixed(1)}" stroke="${col}" stroke-width="1.2" opacity="0.8"/>`;
      paths += `<text x="${tx.toFixed(1)}" y="${ty.toFixed(1)}" text-anchor="${anchor}" dominant-baseline="middle" fill="${col}" font-size="8.5" font-weight="600">${esc(label)}</text>`;
    }
    startAngle = endAngle;
  });

  return `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">${paths}</svg>`;
}

async function loadClocks() {
  const clocks = await api('GET', '/api/clocks');
  _allClocks = clocks;
  $('clocks-empty').style.display = clocks.length ? 'none' : '';

  // List view
  $('clocks-body').innerHTML = clocks.map(c => `
    <tr>
      <td><strong>${esc(c.name)}</strong></td>
      <td>${(c.slots||[]).map(s=>catPill(s.category)).join(' ')}</td>
      <td>${fmtDate(c.created_at)}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-primary btn-sm" onclick='editClock(${JSON.stringify(c)})'>&#9998; Edit</button>
        <button class="btn btn-muted btn-sm" onclick='openClockPie(${JSON.stringify(c)})'>&#9685; Chart</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClock('${c.id}')">✕</button>
      </td>
    </tr>`).join('');

  // Clock grid view
  $('clocks-grid').innerHTML = clocks.map(c => {
    const slotCount = (c.slots||[]).length;
    const totalSec  = (c.slots||[]).reduce((s,sl) => s+(sl.nominal_length_s||0), 0);
    const hm = totalSec ? `${Math.floor(totalSec/3600)}h ${Math.round((totalSec%3600)/60)}m` : `${slotCount} slot${slotCount!==1?'s':''}`;
    return `<div class="clock-card">
      <div class="clock-card-name">${esc(c.name)}</div>
      <div class="clock-card-sub">${hm}</div>
      ${renderClockPieSVG(c)}
      <div class="clock-card-actions">
        <button class="btn btn-primary btn-sm" onclick='editClock(${JSON.stringify(c)})'>&#9998; Edit</button>
        <button class="btn btn-muted btn-sm" onclick='openClockPie(${JSON.stringify(c)})'>&#9685; Detail</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClock('${c.id}')">✕</button>
      </div>
    </div>`;
  }).join('');
}
async function deleteClock(id) {
  if (!confirm('Delete this clock?')) return;
  await api('DELETE', `/api/clocks/${id}`);
  toast('Clock deleted.');
  loadClocks();
}

// ── Schedules ─────────────────────────────────────────────────────────────────
async function loadClocksForGen() {
  const clocks = await api('GET', '/api/clocks');
  $('gen-clock').innerHTML = '<option value="">— No clock (manual) —</option>' +
    clocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
}

async function generateSchedule() {
  const body = { duration_minutes: +$('gen-duration').value || 60 };
  const clockId = $('gen-clock').value;
  const name    = $('gen-name').value.trim();
  const start   = $('gen-start').value;
  if (clockId) body.clock_id = clockId;
  if (name)    body.name = name;
  if (start)   body.start_time = start;

  // Show progress bar
  const btn = $('gen-btn');
  const prog = $('gen-progress');
  const bar  = $('gen-bar');
  const txt  = $('gen-status-text');
  btn.disabled = true;
  prog.style.display = '';
  bar.style.width = '0%';
  txt.textContent = 'Analysing track library…';

  const steps = [
    [20,  'Applying rotation rules…'],
    [50,  'Building hour schedule…'],
    [75,  'Checking artist separation…'],
    [90,  'Finalising track order…'],
    [100, 'Done!'],
  ];
  let si = 0;
  const tick = setInterval(() => {
    if (si < steps.length) {
      bar.style.width = steps[si][0] + '%';
      txt.textContent = steps[si][1];
      si++;
    }
  }, 350);

  const res = await api('POST', '/api/schedule/generate', body);
  clearInterval(tick);
  bar.style.width = '100%';

  setTimeout(() => {
    prog.style.display = 'none';
    btn.disabled = false;
  }, 600);

  if (res.error) return toast(res.error, false);
  toast('Schedule generated!');
  loadSchedules();
  openSchedule(res);
}

async function loadSchedules() {
  const schedules = await api('GET', '/api/schedules');
  $('schedules-empty').style.display = schedules.length ? 'none' : '';
  schedules.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||''));
  $('schedules-body').innerHTML = schedules.map(s => `
    <tr>
      <td><strong>${esc(s.name||'Untitled')}</strong></td>
      <td>${esc(s.clock_name||'—')}</td>
      <td>${(s.tracks||[]).length}</td>
      <td>${s.duration_minutes||0} min</td>
      <td>${fmtDate(s.created_at)}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-muted btn-sm" onclick="viewScheduleById('${s.id}')">View</button>
        <a class="btn btn-success btn-sm" href="/api/schedule/${s.id}/export?format=csv${s.start_time?'&start_time='+s.start_time:''}" download>CSV</a>
        <button class="btn btn-danger btn-sm" onclick="deleteSchedule('${s.id}')">✕</button>
      </td>
    </tr>`).join('');
}

async function viewScheduleById(id) {
  const s = await api('GET', `/api/schedule/${id}`);
  openSchedule(s);
}

function openSchedule(s) {
  _currentSched = s;

  $('modal-sched-title').textContent = s.name || 'Schedule';
  const stats = s.stats || {};
  $('modal-sched-stats').innerHTML = [
    ['Tracks',   stats.total_tracks ?? (s.tracks||[]).length],
    ['Duration', stats.total_duration_hms || fmtDur(stats.total_duration_seconds)],
    ['Artists',  stats.unique_artists ?? '—'],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');

  $('viol-panel').style.display = 'none';

  // Reset to list view
  switchView('list');

  const tracks = s.tracks || [];
  $('modal-sched-body').innerHTML = tracks.map((t, i) => {
    const isNonMusic = t.type && t.type !== 'music';
    return `<tr id="srow-${i}" ${isNonMusic ? 'style="opacity:.7"' : ''}>
      <td class="track-pos">${i+1}</td>
      <td class="air-time">${t.air_time||'—'}</td>
      <td>${esc(t.title || (t.type==='lognote' ? '[lognote]' : t.type) || '—')}${t.lognote_command ? `<span style="font-size:10px;color:var(--muted);margin-left:6px">${esc(t.lognote_command)}</span>` : ''}</td>
      <td>${esc(t.artist||'—')}</td>
      <td>${isNonMusic ? `<span class="pill pill-orange">${t.type}</span>` : catPill(t.category)}</td>
      <td class="dur">${fmtDur(t.duration_seconds)}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" class="empty">No tracks</td></tr>';

  const csvHref = `/api/schedule/${s.id}/export?format=csv${s.start_time?'&start_time='+s.start_time:''}`;
  $('modal-sched-actions').innerHTML = `
    <button class="btn btn-muted" onclick="closeModal('modal-schedule')">Close</button>
    <button class="btn btn-warn btn-sm" onclick="scanViolations('${s.id}')">&#9888; Scan Violations</button>
    <a class="btn btn-success" href="${csvHref}" download>Export CSV</a>`;
  openModal('modal-schedule');
}

async function scanViolations(schedId) {
  const res = await api('POST', `/api/schedule/${schedId}/validate`);
  if (!res) return toast('Validation failed', false);

  const errors   = res.errors   || [];
  const warnings = res.warnings || [];
  const total    = (res.total_tracks || 0);
  const ok       = total - errors.length - warnings.length;
  const pct      = total ? Math.round((ok / total) * 100) : 100;

  const panel = $('viol-panel');
  panel.style.display = '';
  $('viol-stats').innerHTML = `
    <div class="viol-stat"><div class="viol-stat-val err">${errors.length}</div><div class="viol-stat-label">Errors</div></div>
    <div class="viol-stat"><div class="viol-stat-val warn">${warnings.length}</div><div class="viol-stat-label">Warnings</div></div>
    <div class="viol-stat"><div class="viol-stat-val ok">${pct}%</div><div class="viol-stat-label">Compliance</div></div>`;

  const items = [...errors.map(v=>({...v,type:'error'})), ...warnings.map(v=>({...v,type:'warning'}))];
  $('viol-list').innerHTML = items.length
    ? items.map(v => `<div class="viol-item ${v.type}">${esc(v.message||JSON.stringify(v))}</div>`).join('')
    : '<div style="color:var(--success);font-size:13px;padding:8px">&#10003; No violations found!</div>';

  // Highlight rows
  document.querySelectorAll('#modal-sched-body tr').forEach(r => r.classList.remove('row-error','row-warn'));
  errors.forEach(v   => { if (v.position != null) { const r = $('srow-'+(v.position-1)); if(r) r.classList.add('row-error'); } });
  warnings.forEach(v => { if (v.position != null) { const r = $('srow-'+(v.position-1)); if(r) r.classList.add('row-warn');  } });
}

async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;
  await api('DELETE', `/api/schedule/${id}`);
  toast('Schedule deleted.');
  loadSchedules();
}

// ── Export tab ────────────────────────────────────────────────────────────────
function toggleExportCard(card) {
  card.classList.toggle('selected');
}

async function loadExportTab() {
  const schedules = await api('GET', '/api/schedules');
  schedules.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||''));

  $('export-sched-sel').innerHTML = '<option value="">— Select a schedule —</option>' +
    schedules.map(s => `<option value="${s.id}">${esc(s.name||'Untitled')} (${fmtDate(s.created_at)})</option>`).join('');

  $('export-schedules-empty').style.display = schedules.length ? 'none' : '';
  $('export-schedules-body').innerHTML = schedules.map(s => `
    <tr>
      <td><strong>${esc(s.name||'Untitled')}</strong></td>
      <td>${esc(s.clock_name||'—')}</td>
      <td>${(s.tracks||[]).length}</td>
      <td>${fmtDate(s.created_at)}</td>
      <td style="display:flex;gap:6px">
        <a class="btn btn-success btn-sm" href="/api/schedule/${s.id}/export?format=csv" download>CSV</a>
        <a class="btn btn-muted btn-sm" href="/api/schedule/${s.id}/export?format=json" download>JSON</a>
      </td>
    </tr>`).join('');
}

async function doExport() {
  const schedId = $('export-sched-sel').value;
  if (!schedId) return toast('Please select a schedule.', false);

  const selected = [...document.querySelectorAll('#export-cards .export-card.selected')];
  if (!selected.length) return toast('Select at least one export format.', false);

  const fmts = selected.map(c => c.dataset.fmt);
  const start = $('export-start').value;
  const note  = $('export-note');

  // CSV is the only server-supported format; others download as CSV with a note
  const csvFmt = fmts.includes('csv');
  const otherFmts = fmts.filter(f => f !== 'csv');

  let url = `/api/schedule/${schedId}/export?format=csv`;
  if (start) url += `&start_time=${start}`;

  // Trigger CSV download
  const a = document.createElement('a');
  a.href = url;
  a.download = '';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  if (otherFmts.length) {
    note.textContent = `Note: ${otherFmts.join(', ')} export coming soon — downloaded as CSV.`;
  } else {
    note.textContent = '';
  }
  toast('Export downloaded!');
}

// ── Rules Engine ──────────────────────────────────────────────────────────────
const _RULE_NUMERIC = [
  'artist_separation_songs','title_separation_hours','stack_key_separation_songs',
  'album_separation_songs','double_shot_separation_songs',
  'max_gender_run','max_tempo_run','max_mood_run','max_texture_run','max_energy_run',
  'energy_step_limit','bpm_step_limit',
];
const _RULE_BOOL = [
  'allow_double_shots','check_prev_day_artist','check_prev_day_song',
  'enforce_date_range','enforce_hour_open_close',
];

async function loadRules() {
  const r = await api('GET', '/api/rules');
  _RULE_NUMERIC.forEach(k => { const el = $(`rule-${k}`); if (el) el.value = r[k] ?? ''; });
  _RULE_BOOL.forEach(k   => { const el = $(`rule-${k}`); if (el) el.checked = !!r[k]; });
  _conditionalRules = (r.conditional_rules || []).map(cr => ({ ...cr }));
  renderConditionalRules();
}

async function saveRules() {
  const body = {};
  _RULE_NUMERIC.forEach(k => { const el = $(`rule-${k}`); if (el) body[k] = +el.value; });
  _RULE_BOOL.forEach(k   => { const el = $(`rule-${k}`); if (el) body[k] = el.checked; });
  body.conditional_rules = collectConditionalRules();
  const res = await api('PUT', '/api/rules', body);
  if (res && res.error) return toast(res.error, false);
  toast('Rules saved!');
}

// ── Conditional (If/Then) Rules ───────────────────────────────────────────────
let _conditionalRules = [];
let _crNextId = 1;

const CR_FIELDS = [
  { v:'category',      l:'Category',                 ops:['eq','neq','in','not_in'],                      vt:'category' },
  { v:'hour',          l:'Hour (0–23)',               ops:['eq','lt','gt','lte','gte','between'],           vt:'number'   },
  { v:'daypart',       l:'Daypart',                   ops:['eq','neq'],                                     vt:'daypart'  },
  { v:'gender',        l:'Track Gender',              ops:['eq','neq'],                                     vt:'gender'   },
  { v:'tempo',         l:'Track Tempo',               ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'energy',        l:'Track Energy',              ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'mood',          l:'Track Mood',                ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'bpm',           l:'Track BPM',                 ops:['lt','gt','lte','gte','between'],                vt:'number'   },
  { v:'prev_gender',   l:'Prev Song Gender',          ops:['eq','neq'],                                     vt:'gender'   },
  { v:'prev_tempo',    l:'Prev Song Tempo',           ops:['eq','neq','lt','gt','lte','gte'],               vt:'number'   },
  { v:'prev_energy',   l:'Prev Song Energy',          ops:['eq','neq','lt','gt','lte','gte'],               vt:'number'   },
  { v:'prev_category', l:'Prev Song Category',        ops:['eq','neq'],                                     vt:'category' },
  { v:'run_gender',    l:'Consecutive Same-Gender Run', ops:['gte','gt','eq'],                              vt:'number'   },
  { v:'run_tempo',     l:'Consecutive Same-Tempo Run',  ops:['gte','gt','eq'],                              vt:'number'   },
  { v:'run_energy',    l:'Consecutive Same-Energy Run', ops:['gte','gt','eq'],                              vt:'number'   },
];

const CR_OP_LABELS = {
  eq:'=', neq:'≠', lt:'<', lte:'≤', gt:'>', gte:'≥',
  between:'between', in:'in list', not_in:'not in list',
};

const CR_ACTIONS = [
  { v:'artist_separation_songs',    l:'Override Artist Separation (songs)',      vt:'number' },
  { v:'title_separation_hours',     l:'Override Title Separation (hours)',        vt:'number' },
  { v:'stack_key_separation_songs', l:'Override Stack Key Separation (songs)',    vt:'number' },
  { v:'max_run_gender',             l:'Override Max Gender Run',                  vt:'number' },
  { v:'max_run_tempo',              l:'Override Max Tempo Run',                   vt:'number' },
  { v:'max_run_energy',             l:'Override Max Energy Run',                  vt:'number' },
  { v:'max_run_mood',               l:'Override Max Mood Run',                    vt:'number' },
  { v:'require_gender',             l:'Require Track Gender =',                   vt:'gender' },
  { v:'require_gender_neq',         l:'Require Track Gender ≠',                  vt:'gender' },
  { v:'require_energy_gte',         l:'Require Track Energy ≥',                  vt:'number' },
  { v:'require_energy_lte',         l:'Require Track Energy ≤',                  vt:'number' },
  { v:'require_tempo_gte',          l:'Require Track Tempo ≥',                   vt:'number' },
  { v:'require_tempo_lte',          l:'Require Track Tempo ≤',                   vt:'number' },
  { v:'require_bpm_gte',            l:'Require Track BPM ≥',                     vt:'number' },
  { v:'require_bpm_lte',            l:'Require Track BPM ≤',                     vt:'number' },
  { v:'exclude',                    l:'Exclude track from schedule entirely',     vt:'none'   },
];

const CR_GENDER_OPTS = [
  {v:'0',l:'Unknown (0)'},{v:'1',l:'Male (1)'},{v:'2',l:'Female (2)'},{v:'3',l:'Group (3)'},
];
const CR_DAYPART_OPTS = [
  {v:'overnight',     l:'Overnight (12am – 4am)'},
  {v:'early_morning', l:'Early Morning (5am)'},
  {v:'morning_drive', l:'Morning Drive (6am – 9am)'},
  {v:'midmorning',    l:'Mid-Morning (10am – 11am)'},
  {v:'midday',        l:'Midday (12pm – 2pm)'},
  {v:'afternoon',     l:'Afternoon (3pm – 5pm)'},
  {v:'evening',       l:'Evening (6pm – 8pm)'},
  {v:'late_night',    l:'Late Night (9pm – 11pm)'},
];

function _crGenId() { return 'cr' + (_crNextId++); }
function _crFindField(v) { return CR_FIELDS.find(f => f.v === v) || CR_FIELDS[0]; }
function _crFindAction(v) { return CR_ACTIONS.find(a => a.v === v) || CR_ACTIONS[0]; }

function _crCatOpts(sel) {
  return _allCats.map(c => {
    const v = catValue(c);
    return `<option value="${esc(v)}" ${v === sel ? 'selected' : ''}>${esc(c.name)}</option>`;
  }).join('');
}
function _crFieldOpts(sel) {
  return CR_FIELDS.map(f =>
    `<option value="${f.v}" ${f.v === sel ? 'selected' : ''}>${f.l}</option>`
  ).join('');
}
function _crOpOpts(fieldDef, selOp) {
  return (fieldDef?.ops || ['eq','neq']).map(op =>
    `<option value="${op}" ${op === selOp ? 'selected' : ''}>${CR_OP_LABELS[op] || op}</option>`
  ).join('');
}
function _crGenderSel(val) {
  return `<select class="cr-v-sel">${CR_GENDER_OPTS.map(o =>
    `<option value="${o.v}" ${o.v === String(val ?? '') ? 'selected' : ''}>${o.l}</option>`
  ).join('')}</select>`;
}
function _crDaypartSel(val) {
  return `<select class="cr-v-sel">${CR_DAYPART_OPTS.map(o =>
    `<option value="${o.v}" ${o.v === (val ?? '') ? 'selected' : ''}>${o.l}</option>`
  ).join('')}</select>`;
}

function _crValInput(fieldDef, op, value) {
  if (op === 'between') {
    const [lo='', hi=''] = Array.isArray(value) ? value : [value ?? '', ''];
    return `<div class="cr-between">
      <input type="number" class="cr-v-lo" value="${esc(String(lo))}" placeholder="min">
      <span style="color:var(--muted);font-size:11px">–</span>
      <input type="number" class="cr-v-hi" value="${esc(String(hi))}" placeholder="max">
    </div>`;
  }
  if (op === 'in' || op === 'not_in') {
    const joined = Array.isArray(value) ? value.join(', ') : (value ?? '');
    return `<input type="text" class="cr-v-list" value="${esc(joined)}" placeholder="val1, val2 …">`;
  }
  const vt = fieldDef?.vt || 'number';
  if (vt === 'category') return `<select class="cr-v-sel">${_crCatOpts(value ?? '')}</select>`;
  if (vt === 'gender')   return _crGenderSel(value);
  if (vt === 'daypart')  return _crDaypartSel(value);
  return `<input type="number" class="cr-v-num" value="${value ?? ''}">`;
}

function _crActionValInput(actionDef, value) {
  if (!actionDef || actionDef.vt === 'none') return '';
  if (actionDef.vt === 'gender') return _crGenderSel(value);
  return `<input type="number" class="cr-av-num" value="${value ?? ''}">`;
}

function _crActionOpts(sel) {
  return CR_ACTIONS.map(a =>
    `<option value="${a.v}" ${a.v === sel ? 'selected' : ''}>${a.l}</option>`
  ).join('');
}

function _renderCondRow(rid, idx, cond) {
  const field    = cond.field || CR_FIELDS[0].v;
  const fieldDef = _crFindField(field);
  const op       = cond.op || fieldDef.ops[0];
  return `<div class="cr-cond-row" data-cond="${idx}">
    <select class="cr-cond-field" onchange="_crFieldChange(this,'${rid}',${idx})">${_crFieldOpts(field)}</select>
    <select class="cr-cond-op"    onchange="_crOpChange(this,'${rid}',${idx})">${_crOpOpts(fieldDef, op)}</select>
    <span   class="cr-cond-val">${_crValInput(fieldDef, op, cond.value)}</span>
    <button class="btn btn-danger btn-sm" onclick="_crRemoveCond('${rid}',${idx})">×</button>
  </div>`;
}

function _renderCRCard(cr) {
  const rid      = cr._uiId || (cr._uiId = _crGenId());
  const enabled  = cr.enabled !== false;
  const conds    = (cr.conditions && cr.conditions.length) ? cr.conditions
                    : [{ field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null }];
  const logic    = cr.condition_logic || 'AND';
  const action   = cr.action || {};
  const atype    = action.type || CR_ACTIONS[0].v;
  const aDef     = _crFindAction(atype);

  return `<div class="cr-rule${enabled ? '' : ' cr-disabled'}" data-rid="${rid}">
    <div class="cr-header">
      <label class="cr-toggle">
        <input type="checkbox" class="cr-enabled" ${enabled ? 'checked' : ''}
               onchange="this.closest('.cr-rule').classList.toggle('cr-disabled',!this.checked)">
        Enable
      </label>
      <input class="cr-label-inp" type="text" placeholder="Rule name…" value="${esc(cr.label || '')}">
      <button class="btn btn-danger btn-sm" onclick="removeCR('${rid}')">Delete</button>
    </div>
    <div class="cr-body">
      <div class="cr-section">
        <div class="cr-kw kw-if">IF</div>
        <div class="cr-inner">
          <div class="cr-conditions-list">
            ${conds.map((c, i) => _renderCondRow(rid, i, c)).join('')}
          </div>
          <div class="cr-foot">
            <button class="btn btn-muted btn-sm" onclick="_crAddCondition('${rid}')">+ Condition</button>
            <div class="cr-logic">
              <span>Logic:</span>
              <label><input type="radio" name="cr-${rid}-logic" value="AND" ${logic === 'AND' ? 'checked' : ''}> AND</label>
              <label><input type="radio" name="cr-${rid}-logic" value="OR"  ${logic === 'OR'  ? 'checked' : ''}> OR</label>
            </div>
          </div>
        </div>
      </div>
      <div class="cr-section">
        <div class="cr-kw kw-then">THEN</div>
        <div class="cr-inner">
          <div class="cr-action-row">
            <select class="cr-action-type" onchange="_crActionChange(this,'${rid}')">${_crActionOpts(atype)}</select>
            <span class="cr-action-val">${_crActionValInput(aDef, action.value)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderConditionalRules() {
  const list  = $('cond-rules-list');
  const empty = $('cond-rules-empty');
  list.querySelectorAll('.cr-rule').forEach(el => el.remove());
  if (!_conditionalRules.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  _conditionalRules.forEach(cr => {
    const div = document.createElement('div');
    div.innerHTML = _renderCRCard(cr);
    list.appendChild(div.firstElementChild);
  });
}

function addConditionalRule() {
  $('cond-rules-empty').style.display = 'none';
  const cr = {
    enabled: true, label: '',
    conditions: [{ field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null }],
    condition_logic: 'AND',
    action: { type: CR_ACTIONS[0].v, value: null },
  };
  cr._uiId = _crGenId();
  const div = document.createElement('div');
  div.innerHTML = _renderCRCard(cr);
  $('cond-rules-list').appendChild(div.firstElementChild);
}

function removeCR(rid) {
  document.querySelector(`.cr-rule[data-rid="${rid}"]`).remove();
  if (!document.querySelector('.cr-rule')) $('cond-rules-empty').style.display = '';
}

function _crFieldChange(sel, rid, idx) {
  const row      = sel.closest('.cr-cond-row');
  const fieldDef = _crFindField(sel.value);
  row.querySelector('.cr-cond-op').innerHTML = _crOpOpts(fieldDef, fieldDef.ops[0]);
  row.querySelector('.cr-cond-val').innerHTML = _crValInput(fieldDef, fieldDef.ops[0], null);
}

function _crOpChange(sel, rid, idx) {
  const row      = sel.closest('.cr-cond-row');
  const fieldDef = _crFindField(row.querySelector('.cr-cond-field').value);
  row.querySelector('.cr-cond-val').innerHTML = _crValInput(fieldDef, sel.value, null);
}

function _crActionChange(sel, rid) {
  const card    = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const aDef    = _crFindAction(sel.value);
  card.querySelector('.cr-action-val').innerHTML = _crActionValInput(aDef, null);
}

function _crAddCondition(rid) {
  const card     = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const condList = card.querySelector('.cr-conditions-list');
  const idx      = condList.querySelectorAll('.cr-cond-row').length;
  const div      = document.createElement('div');
  div.innerHTML  = _renderCondRow(rid, idx, { field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null });
  condList.appendChild(div.firstElementChild);
}

function _crRemoveCond(rid, idx) {
  const card = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const rows = card.querySelectorAll('.cr-cond-row');
  if (rows.length <= 1) return toast('At least one condition required.', false);
  rows[idx].remove();
  card.querySelectorAll('.cr-cond-row').forEach((r, i) => r.dataset.cond = i);
}

function _crReadCondValue(row) {
  const lo = row.querySelector('.cr-v-lo');
  if (lo) return [lo.value, (row.querySelector('.cr-v-hi') || {}).value ?? ''];
  const list = row.querySelector('.cr-v-list');
  if (list) return list.value.split(',').map(s => s.trim()).filter(Boolean);
  const sel = row.querySelector('.cr-v-sel');
  if (sel) return sel.value;
  const num = row.querySelector('.cr-v-num');
  return num ? +num.value : null;
}

function _crReadActionValue(card) {
  const sel = card.querySelector('.cr-av-sel');
  if (sel) return sel.value;
  const num = card.querySelector('.cr-av-num');
  return num ? +num.value : null;
}

function collectConditionalRules() {
  const rules = [];
  document.querySelectorAll('.cr-rule').forEach(card => {
    const rid       = card.dataset.rid;
    const enabled   = card.querySelector('.cr-enabled').checked;
    const label     = card.querySelector('.cr-label-inp').value.trim();
    const logic     = (card.querySelector(`input[name="cr-${rid}-logic"]:checked`) || {}).value || 'AND';
    const atype     = card.querySelector('.cr-action-type').value;
    const aval      = atype === 'exclude' ? null : _crReadActionValue(card);
    const conditions = [];
    card.querySelectorAll('.cr-cond-row').forEach(row => {
      conditions.push({
        field: row.querySelector('.cr-cond-field').value,
        op:    row.querySelector('.cr-cond-op').value,
        value: _crReadCondValue(row),
      });
    });
    rules.push({ id: rid, enabled, label, conditions, condition_logic: logic, action: { type: atype, value: aval } });
  });
  return rules;
}

// ── Program Grid ──────────────────────────────────────────────────────────────
let _pgClocks   = [];
let _pgTmplId   = null;
let _pgTmpl     = null;
let _pgTmpls    = [];     // all templates (for Day Detail list)
let _pgView     = 'grid'; // 'grid' | 'detail' | 'daypart'
let _ddTmplId   = null;   // selected template in Day Detail view
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

// Daypart definitions — name, color, hours covered, CSS class
const DAYPARTS = [
  { name:'Overnight',      color:'#00e5ff', cls:'dp-overnight', hours:[0,1,2,3,4]   },
  { name:'Early Morning',  color:'#ff7043', cls:'dp-early',     hours:[5]            },
  { name:'Morning Drive',  color:'#ffea00', cls:'dp-morning',   hours:[6,7,8,9]      },
  { name:'Mid-morning',    color:'#00e676', cls:'dp-midmorn',   hours:[10,11]        },
  { name:'Midday',         color:'#ffa726', cls:'dp-midday',    hours:[12,13,14]     },
  { name:'Afternoon Drive',color:'#f44336', cls:'dp-afternoon', hours:[15,16,17,18]  },
  { name:'Evening',        color:'#e91e63', cls:'dp-evening',   hours:[19,20,21]     },
  { name:'Late Night',     color:'#9c27b0', cls:'dp-latenight', hours:[22,23]        },
];
const hourDpClass = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).cls;
const hourDpName  = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).name;
const hourDpColor = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).color;

// Format hour as "6 am" / "12 pm" / "6 pm"
function fmtHour(h) {
  if (h === 0)  return '12 am';
  if (h < 12)   return `${h} am`;
  if (h === 12) return '12 pm';
  return `${h-12} pm`;
}

// ── Program tab load ──────────────────────────────────────────────────────────
async function loadProgramTab() {
  [_pgClocks, { day_templates: _pgTmpls = [] }] = await Promise.all([
    api('GET', '/api/clocks'),
    api('GET', '/api/day-templates'),
  ]);

  // Populate template selector
  const sel = $('pg-tmpl-sel');
  sel.innerHTML = '<option value="">— Select a day template —</option>' +
    _pgTmpls.map(t => `<option value="${t.id}" ${t.id===_pgTmplId?'selected':''}>${esc(t.name)}</option>`).join('');

  loadProgramGrid();
  renderDaypLegend();
}

// ── View switching ────────────────────────────────────────────────────────────
function switchPgView(mode) {
  _pgView = mode;
  ['grid','detail','daypart'].forEach(m => {
    $('pg-view-' + m).style.display = m === mode ? '' : 'none';
    $('pgv-'     + m).classList.toggle('active', m === mode);
  });
  if (mode === 'detail')  renderDayDetail();
  if (mode === 'daypart') renderDaypartMap();
}

// ── Template management ───────────────────────────────────────────────────────
async function createDayTemplate() {
  const name = $('pg-new-name').value.trim();
  if (!name) return toast('Enter a template name first.', false);
  const res = await api('POST', '/api/day-templates', { name });
  if (res.error) return toast(res.error, false);
  $('pg-new-name').value = '';
  _pgTmplId = res.id;
  toast('Template created!');
  loadProgramTab();
}

async function deleteDayTemplate() {
  if (!_pgTmplId) return;
  if (!confirm('Delete this day template?')) return;
  await api('DELETE', `/api/day-templates/${_pgTmplId}`);
  _pgTmplId = null; _pgTmpl = null;
  $('pg-tmpl-sel').value = '';
  toast('Template deleted.');
  loadProgramTab();
}

async function loadProgramGrid() {
  const sel    = $('pg-tmpl-sel');
  const tmplId = sel.value;
  _pgTmplId    = tmplId || null;

  $('pg-del-btn').style.display  = tmplId ? '' : 'none';
  $('pg-gen-card').style.display = tmplId ? '' : 'none';

  if (!tmplId) {
    $('prog-grid-body').innerHTML = '';
    $('prog-grid-empty').style.display = '';
    _pgTmpl = null;
    if (_pgView === 'detail')  renderDayDetail();
    if (_pgView === 'daypart') renderDaypartMap();
    return;
  }
  $('prog-grid-empty').style.display = 'none';
  _pgTmpl = await api('GET', `/api/day-templates/${tmplId}`);

  renderProgramGrid();
  if (_pgView === 'detail')  renderDayDetail();
  if (_pgView === 'daypart') renderDaypartMap();

  if (!$('pg-gen-date').value)
    $('pg-gen-date').value = new Date().toISOString().slice(0, 10);
}

// Helper: read clock id for a given day index + hour from _pgTmpl
function tmplClockAt(d, h) {
  if (!_pgTmpl) return null;
  const dayKey = DAYS[d].toLowerCase() + '_' + h;
  return _pgTmpl[dayKey] !== undefined
    ? _pgTmpl[dayKey]
    : ((_pgTmpl.hours || {})[String(h)] || null);
}

// ── WEEK GRID rendering ───────────────────────────────────────────────────────
function renderProgramGrid() {
  if (!_pgTmpl) return;
  const clockOptHTML = '<option value="">—</option>' +
    _pgClocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');

  let html = '';
  for (let h = 0; h < 24; h++) {
    const dpCls = hourDpClass(h);
    html += `<tr class="${dpCls}"><td class="hour-label">${fmtHour(h)}</td>`;
    for (let d = 0; d < 7; d++) {
      html += `<td><select class="gc-select" data-day="${d}" data-hour="${h}" onchange="pgCellChange(this)">${clockOptHTML}</select></td>`;
    }
    html += '</tr>';
  }
  $('prog-grid-body').innerHTML = html;

  // Set values
  $('prog-grid-body').querySelectorAll('select.gc-select').forEach(sel => {
    sel.value = tmplClockAt(+sel.dataset.day, +sel.dataset.hour) || '';
  });
}

async function pgCellChange(sel) {
  if (!_pgTmpl || !_pgTmplId) return;
  const d      = +sel.dataset.day;
  const h      = +sel.dataset.hour;
  const dayKey = DAYS[d].toLowerCase() + '_' + h;
  const clockId = sel.value || null;

  const update = { [dayKey]: clockId };
  if (d === 0) {
    const hours = { ...(_pgTmpl.hours || {}) };
    hours[String(h)] = clockId;
    update.hours = hours;
  }

  const res = await api('PUT', `/api/day-templates/${_pgTmplId}`, update);
  if (res && !res.error) {
    _pgTmpl = res;
    sel.parentElement.style.transition = 'background .05s';
    sel.parentElement.style.background = 'rgba(108,99,255,.35)';
    setTimeout(() => { sel.parentElement.style.background = ''; }, 500);
    // Sync other views
    if (_pgView === 'detail')  renderDayDetail();
    // Keep week grid and daypart map in sync without full re-render
    const peer = sel.classList.contains('dp-sel') ? '.gc-select' : '.dp-sel';
    $('prog-grid-body').querySelectorAll(`${peer}[data-day="${d}"][data-hour="${h}"]`)
      .forEach(s => { s.value = clockId || ''; });
    $('dp-map-body').querySelectorAll(`${peer}[data-day="${d}"][data-hour="${h}"]`)
      .forEach(s => { s.value = clockId || ''; });
  }
}

// ── DAY DETAIL view ───────────────────────────────────────────────────────────
function renderDayDetail() {
  const panel  = $('ddl-panel');
  const center = $('dd-center');
  const clockById = Object.fromEntries(_pgClocks.map(c => [c.id, c]));
  const clockOptHTML = '<option value="">— not used —</option>' +
    _pgClocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');

  // Left panel: template list
  if (!_pgTmpls.length) {
    panel.innerHTML = '<div class="empty" style="padding:16px;font-size:12px">No templates yet.</div>';
  } else {
    panel.innerHTML = _pgTmpls.map(t => `
      <div class="ddl-item ${t.id===(_ddTmplId||_pgTmplId)?'active':''}"
           onclick="ddSelectTmpl('${t.id}')">${esc(t.name)}</div>
    `).join('');
  }

  // Default selection
  if (!_ddTmplId) _ddTmplId = _pgTmplId;

  const tmpl = _pgTmpls.find(t => t.id === _ddTmplId);
  if (!tmpl) {
    center.innerHTML = '<div class="empty" style="padding:40px 20px">Select a template on the left.</div>';
    return;
  }

  // Load and render the 24-hour list for this template
  api('GET', `/api/day-templates/${tmpl.id}`).then(data => {
    let rows = '';
    for (let h = 0; h < 24; h++) {
      const dpColor = hourDpColor(h);
      const dpName  = hourDpName(h);
      // For Day Detail, show the Mon clock (or flat hours as reference)
      const clockId = (data['mon_' + h] !== undefined)
        ? data['mon_' + h]
        : ((data.hours || {})[String(h)] || '');
      rows += `<div class="dd-row">
        <div class="dd-hour" style="border-left:3px solid ${dpColor}">
          ${fmtHour(h)}<span class="dd-hour-name">${dpName}</span>
        </div>
        <select class="dd-sel" data-tmpl="${tmpl.id}" data-hour="${h}" onchange="ddCellChange(this)">
          ${clockOptHTML}
        </select>
      </div>`;
    }
    center.innerHTML = `<div style="padding:10px 14px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--border);font-weight:600">${esc(tmpl.name)} — editing Mon column (applies as default for all days)</div>` + rows;
    // Set values
    center.querySelectorAll('select.dd-sel').forEach(sel => {
      const h      = +sel.dataset.hour;
      const clockId = (data['mon_' + h] !== undefined)
        ? data['mon_' + h]
        : ((data.hours || {})[String(h)] || '');
      sel.value = clockId || '';
    });
  });
}

async function ddSelectTmpl(id) {
  _ddTmplId = id;
  renderDayDetail();
}

async function ddCellChange(sel) {
  const tmplId  = sel.dataset.tmpl;
  const h       = +sel.dataset.hour;
  const clockId = sel.value || null;
  const hours   = {};
  // Build a full hours update from current center selects
  $('dd-center').querySelectorAll('select.dd-sel').forEach(s => {
    hours[String(+s.dataset.hour)] = s.value || null;
  });
  const update = { ['mon_' + h]: clockId, hours };
  const res = await api('PUT', `/api/day-templates/${tmplId}`, update);
  if (res && !res.error) {
    // If this is the active week-grid template, sync it
    if (tmplId === _pgTmplId) {
      _pgTmpl = res;
      renderProgramGrid();
    }
    sel.style.background = 'rgba(108,99,255,.2)';
    setTimeout(() => { sel.style.background = ''; }, 500);
  }
}

// ── DAYPART MAP view ──────────────────────────────────────────────────────────
function renderDaypLegend() {
  $('dp-legend').innerHTML = DAYPARTS.map(dp => `
    <div class="dp-leg-item">
      <div class="dp-swatch" style="background:${dp.color}"></div>
      <span>${dp.name}</span>
    </div>`).join('');
}

function renderDaypartMap() {
  if (!_pgTmpl) return;
  const clockOptHTML = '<option value="">— not used —</option>' +
    _pgClocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');

  let html = '';
  for (let h = 0; h < 24; h++) {
    const dp = DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0];
    // Hex to rgba for select background
    const bg = dp.color + '33'; // 20% opacity tint
    html += `<tr><td class="hour-label" style="border-left:3px solid ${dp.color}">${fmtHour(h)}</td>`;
    for (let d = 0; d < 7; d++) {
      html += `<td style="padding:1px">
        <select class="dp-sel" data-day="${d}" data-hour="${h}"
                onchange="pgCellChange(this)"
                style="background:${bg};border-color:${dp.color}44">
          ${clockOptHTML}
        </select>
      </td>`;
    }
    html += '</tr>';
  }
  $('dp-map-body').innerHTML = html;

  // Set saved values
  $('dp-map-body').querySelectorAll('select.dp-sel').forEach(sel => {
    sel.value = tmplClockAt(+sel.dataset.day, +sel.dataset.hour) || '';
  });
}

// ── Generate from template ────────────────────────────────────────────────────
async function generateFromTemplate() {
  if (!_pgTmplId) return;
  const body = {
    template_id: _pgTmplId,
    date:       $('pg-gen-date').value || undefined,
    start_hour: +$('pg-gen-start-hr').value,
    end_hour:   +$('pg-gen-end-hr').value,
    name:       $('pg-gen-name').value.trim() || undefined,
  };
  const st = $('pg-gen-status');
  st.textContent = 'Generating…';
  const res = await api('POST', '/api/schedule/generate-day', body);
  if (res && res.error) { st.textContent = ''; return toast(res.error, false); }
  st.textContent = `Done — ${(res.tracks||[]).length} tracks scheduled.`;
  toast('Day schedule generated!');
  openSchedule(res);
}

// ── Clock Pie Chart ───────────────────────────────────────────────────────────
const PIE_COLORS = [
  '#6c63ff','#48bb78','#ff6584','#f6ad55','#00bcd4',
  '#ec407a','#66bb6a','#7e57c2','#ff9800','#e53935',
];
function openClockPie(clock) {
  $('pie-title').textContent = clock.name + ' — Composition';
  const slots = clock.slots || [];
  if (!slots.length) {
    $('pie-svg').innerHTML = '<text x="110" y="115" text-anchor="middle" fill="#7c85a2" font-size="13">No slots defined</text>';
    $('pie-legend').innerHTML = '';
    openModal('modal-pie');
    return;
  }

  // Count slots by category
  const counts = {};
  slots.forEach(s => { counts[s.category] = (counts[s.category] || 0) + 1; });
  const entries = Object.entries(counts);
  const total   = entries.reduce((s,[,v]) => s+v, 0);

  // Draw SVG pie
  const cx = 110, cy = 110, r = 90;
  let startAngle = -Math.PI / 2;
  let paths = '', legend = '';

  entries.forEach(([cat, count], i) => {
    const angle = (count / total) * 2 * Math.PI;
    const endAngle = startAngle + angle;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const large = angle > Math.PI ? 1 : 0;
    const col = PIE_COLORS[i % PIE_COLORS.length];

    // Mid-point for label placement
    const midA = startAngle + angle / 2;
    const lx = cx + (r * 0.62) * Math.cos(midA);
    const ly = cy + (r * 0.62) * Math.sin(midA);
    const pct = Math.round(count / total * 100);

    paths += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} Z" fill="${col}" stroke="#1a1d27" stroke-width="1.5"/>`;
    if (pct >= 6)
      paths += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="11" font-weight="700">${pct}%</text>`;

    legend += `<div class="pie-leg-row"><div class="pie-dot" style="background:${col}"></div><span>${esc(cat)} (${count})</span></div>`;
    startAngle = endAngle;
  });

  $('pie-svg').innerHTML = paths;
  $('pie-legend').innerHTML = legend;
  openModal('modal-pie');
}

// ── Schedule view modes ────────────────────────────────────────────────────────
let _currentSched = null;   // last opened schedule object

function switchView(mode) {
  ['list','blocks','timeline'].forEach(m => {
    $('view-'  +m).style.display = m===mode ? '' : 'none';
    $('vt-'    +m).classList.toggle('active', m===mode);
  });
  if (mode==='blocks')   renderHourBlocks(_currentSched);
  if (mode==='timeline') renderTimeline(_currentSched);
}

function renderHourBlocks(s) {
  const tracks = (s && s.tracks) || [];
  if (!tracks.length) { $('view-blocks').innerHTML = '<div class="empty">No tracks</div>'; return; }

  // Group by hour (derive from air_time, or group every ~60 min)
  const blocks = {};
  let hourIdx = 0, blockSecs = 0;
  tracks.forEach((t, i) => {
    if (t.air_time) {
      hourIdx = parseInt(t.air_time.split(':')[0], 10);
    } else {
      if (i > 0 && blockSecs >= 3600) { hourIdx++; blockSecs = 0; }
      blockSecs += (t.duration_seconds || 0);
    }
    const key = t.air_time ? hourIdx : hourIdx;
    if (!blocks[key]) blocks[key] = [];
    blocks[key].push(t);
  });

  $('view-blocks').innerHTML = Object.entries(blocks).map(([hr, trks]) => {
    const label = `${fmtHour(+hr)} — ${trks.length} tracks`;
    const rows = trks.map((t, i) => {
      const typeClass = t.type !== 'music' ? 'color:var(--warn)' : '';
      return `<div class="hb-row">
        <span class="hb-pos">${i+1}</span>
        <span class="hb-time">${t.air_time||'—'}</span>
        <span class="hb-title" style="${typeClass}">${esc(t.title||t.type||'—')}</span>
        <span class="hb-artist">${esc(t.artist||'')}</span>
        <span class="hb-dur">${fmtDur(t.duration_seconds)}</span>
      </div>`;
    }).join('');
    return `<div class="hour-block">
      <div class="hour-block-head">${label}</div>
      <div class="hour-block-body">${rows}</div>
    </div>`;
  }).join('');
}

function renderTimeline(s) {
  const tracks = (s && s.tracks) || [];
  if (!tracks.length) {
    $('tl-tracks').innerHTML = '<div class="empty">No tracks</div>';
    $('tl-ruler').innerHTML = '';
    return;
  }

  // Total duration in seconds for scaling
  const totalSecs = tracks.reduce((sum, t) => sum + (t.duration_seconds || 0), 0) || 3600;
  const PX_PER_SEC = 600 / totalSecs;   // fit to 600px base width

  // Ruler: one tick per 5 minutes
  let ruler = '';
  for (let s2 = 0; s2 <= totalSecs; s2 += 300) {
    const pct = (s2 / totalSecs * 100).toFixed(1);
    const label = `${Math.floor(s2/60)}m`;
    ruler += `<div class="tl-tick" style="width:${300/totalSecs*100}%;max-width:60px">${label}</div>`;
  }
  $('tl-ruler').innerHTML = ruler;

  const CAT_CLASSES = ['tl-music-0','tl-music-1','tl-music-2','tl-music-3'];
  const catIdxMap = {};
  let catCounter = 0;

  let offsetSecs = 0;
  $('tl-tracks').innerHTML = tracks.map((t, i) => {
    const dur = t.duration_seconds || 0;
    const left  = (offsetSecs / totalSecs * 100).toFixed(2);
    const width = (dur / totalSecs * 100).toFixed(2);
    offsetSecs += dur;

    let barClass = 'tl-music-0';
    if (t.type === 'spot')    barClass = 'tl-spot';
    else if (t.type === 'liner') barClass = 'tl-liner';
    else if (t.type === 'lognote') barClass = 'tl-lognote';
    else {
      const cat = t.category || '';
      if (!(cat in catIdxMap)) catIdxMap[cat] = catCounter++ % 4;
      barClass = CAT_CLASSES[catIdxMap[cat]];
    }

    const label = t.title || t.type || '?';
    return `<div class="tl-track">
      <div class="tl-label" title="${esc(t.artist||'')}">
        <span style="font-size:10px;color:var(--border)">${i+1}</span> ${esc(t.artist||t.type||'')}
      </div>
      <div class="tl-bar-wrap">
        <div class="tl-bar ${barClass}" style="left:${left}%;width:${Math.max(0.5,+width)}%" title="${esc(label)} — ${fmtDur(dur)}">
          ${+width > 3 ? esc(label) : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ── Sound Codes ───────────────────────────────────────────────────────────────
let _scEditId = null;

async function loadSoundCodes() {
  const data = await api('GET', '/api/sound-codes');
  const rows = data.sound_codes || [];
  $('sc-tbody').innerHTML = rows.length ? rows.map((sc, i) => `
    <tr>
      <td style="color:var(--muted)">${i+1}</td>
      <td><strong style="color:var(--accent)">SC${sc.number}</strong></td>
      <td>${esc(sc.name)}</td>
      <td style="color:var(--muted);font-size:12px">${esc(sc.description||'')}</td>
      <td>
        <button class="btn btn-muted btn-sm" onclick="editSC(${JSON.stringify(sc).replace(/"/g,'&quot;')})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteSC('${sc.id}')">Delete</button>
      </td>
    </tr>`).join('') : '<tr><td colspan="5" class="empty">No sound codes defined yet.</td></tr>';
}

function openSCModal(sc) {
  _scEditId = sc ? sc.id : null;
  const html = `
    <div class="card" style="max-width:440px;margin:24px auto">
      <h3 style="font-size:15px;font-weight:600;margin-bottom:16px">${_scEditId ? 'Edit' : 'Add'} Sound Code</h3>
      <div class="form-grid">
        <div class="form-group"><label>Code Number (1-30)</label><input type="number" id="sc-num" min="1" max="30" value="${sc?sc.number:1}"></div>
        <div class="form-group"><label>Name</label><input type="text" id="sc-name" value="${sc?esc(sc.name):''}"></div>
        <div class="form-group" style="grid-column:span 2"><label>Description</label><input type="text" id="sc-desc" value="${sc?esc(sc.description||''):''}"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-primary" onclick="saveSC()">Save</button>
        <button class="btn btn-muted" onclick="this.closest('.card').remove()">Cancel</button>
      </div>
    </div>`;
  const el = document.createElement('div');
  el.innerHTML = html;
  el.style.cssText = 'position:fixed;inset:0;background:#0009;z-index:200;display:flex;align-items:center;justify-content:center';
  el.id = 'sc-modal-overlay';
  el.onclick = e => { if (e.target===el) el.remove(); };
  document.body.appendChild(el);
}

function editSC(sc) { openSCModal(sc); }

async function saveSC() {
  const body = { number: +$('sc-num').value, name: $('sc-name').value, description: $('sc-desc').value };
  if (!body.name) { toast('Name is required', false); return; }
  if (_scEditId) await api('PUT', `/api/sound-codes/${_scEditId}`, body);
  else           await api('POST', '/api/sound-codes', body);
  document.getElementById('sc-modal-overlay')?.remove();
  loadSoundCodes();
  toast(_scEditId ? 'Sound code updated' : 'Sound code added');
}

async function deleteSC(id) {
  if (!confirm('Delete this sound code?')) return;
  await api('DELETE', `/api/sound-codes/${id}`);
  loadSoundCodes();
  toast('Deleted');
}

// ── Bulk Actions ──────────────────────────────────────────────────────────────
async function initBulkTab() {
  const catSel = $('bulk-cat');
  if (catSel.options.length <= 1) {
    _allCats.forEach(c => catSel.add(new Option(c.name, c.name)));
  }
  const newCatSel = $('bulk-new-cat');
  if (newCatSel.options.length <= 1) {
    _allCats.forEach(c => newCatSel.add(new Option(c.name, c.name)));
  }
  updateBulkUI();
}

function updateBulkUI() {
  const action = $('bulk-action').value;
  $('bulk-recategorize-row').style.display = action==='recategorize' ? '' : 'none';
  $('bulk-setfield-row').style.display     = action==='set_field'    ? '' : 'none';
  $('bulk-delete-warn').style.display      = action==='delete'       ? '' : 'none';
}

async function runBulkAction() {
  const action = $('bulk-action').value;
  const body = {
    action,
    filters: {
      category: $('bulk-cat').value,
      tempo:    $('bulk-tempo').value,
      search:   $('bulk-search').value,
    },
  };
  if (action === 'recategorize') body.value = $('bulk-new-cat').value;
  if (action === 'set_field')    { body.field = $('bulk-field').value; body.value = $('bulk-value').value; }
  if (action === 'delete') {
    if (!confirm('Permanently delete matching tracks?')) return;
  }
  const res = await api('POST', '/api/tracks/bulk-action', body);
  $('bulk-result').textContent = res.success ? `✓ ${res.affected} track(s) affected` : '✗ Error';
  if (res.success) toast(`Bulk action complete — ${res.affected} track(s) affected`);
  else toast('Bulk action failed', false);
}

// ── Traffic ───────────────────────────────────────────────────────────────────
let _tcEditId = null;

async function loadTraffic() {
  const type = $('traffic-type-filter').value;
  const url  = '/api/traffic' + (type ? `?type=${encodeURIComponent(type)}` : '');
  const data = await api('GET', url);
  const rows = data.components || [];
  $('traffic-tbody').innerHTML = rows.length ? rows.map(tc => `
    <tr>
      <td style="font-weight:600">${esc(tc.name)}</td>
      <td><span class="pill pill-blue">${esc(tc.type)}</span></td>
      <td style="color:var(--muted)">${esc(tc.client||'')}</td>
      <td>${tc.duration_s}s</td>
      <td><code style="font-size:11px;color:var(--accent)">${esc(tc.cart||'—')}</code></td>
      <td style="font-size:12px;color:var(--muted)">${tc.start_date||'—'} → ${tc.end_date||'∞'}</td>
      <td>${tc.active ? '<span class="pill pill-green">Active</span>' : '<span class="pill pill-red">Off</span>'}</td>
      <td>
        <button class="btn btn-muted btn-sm" onclick="openTrafficModal(${JSON.stringify(tc).replace(/"/g,'&quot;')})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTraffic('${tc.id}')">Del</button>
      </td>
    </tr>`).join('') : '<tr><td colspan="8" class="empty">No components. Click + Add Component.</td></tr>';
}

function openTrafficModal(tc) {
  _tcEditId = tc ? tc.id : null;
  const html = `
    <div class="card" style="max-width:520px;margin:24px auto;max-height:80vh;overflow-y:auto">
      <h3 style="font-size:15px;font-weight:600;margin-bottom:16px">${_tcEditId?'Edit':'Add'} Traffic Component</h3>
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2"><label>Name *</label><input type="text" id="tc-name" value="${tc?esc(tc.name):''}"></div>
        <div class="form-group"><label>Type</label><select id="tc-type">
          ${['spot','psa','promo','liner','jingle','news'].map(t=>`<option${tc&&tc.type===t?' selected':''}>${t}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Duration (seconds)</label><input type="number" id="tc-dur" value="${tc?tc.duration_s:30}" min="1"></div>
        <div class="form-group"><label>Client / Advertiser</label><input type="text" id="tc-client" value="${tc?esc(tc.client||''):''}"></div>
        <div class="form-group"><label>Cart Number</label><input type="text" id="tc-cart" value="${tc?esc(tc.cart||''):''}"></div>
        <div class="form-group"><label>Start Date</label><input type="date" id="tc-start" value="${tc&&tc.start_date?tc.start_date:''}"></div>
        <div class="form-group"><label>End Date</label><input type="date" id="tc-end" value="${tc&&tc.end_date?tc.end_date:''}"></div>
        <div class="form-group"><label>Target Plays/Day</label><input type="number" id="tc-plays-day" min="0" value="${tc?tc.target_plays_per_day:0}"></div>
        <div class="form-group"><label>ISCI Code</label><input type="text" id="tc-isci" value="${tc?esc(tc.isci_code||''):''}"></div>
        <div class="form-group" style="grid-column:span 2"><label>Notes</label><input type="text" id="tc-notes" value="${tc?esc(tc.notes||''):''}"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-primary" onclick="saveTraffic()">Save</button>
        <button class="btn btn-muted" onclick="document.getElementById('tc-modal-overlay').remove()">Cancel</button>
      </div>
    </div>`;
  const el = document.createElement('div');
  el.innerHTML = html;
  el.style.cssText = 'position:fixed;inset:0;background:#0009;z-index:200;display:flex;align-items:center;justify-content:center';
  el.id = 'tc-modal-overlay';
  el.onclick = e => { if (e.target===el) el.remove(); };
  document.body.appendChild(el);
}

async function saveTraffic() {
  const body = {
    name: $('tc-name').value,
    type: $('tc-type').value,
    duration_s: +$('tc-dur').value,
    client: $('tc-client').value,
    cart: $('tc-cart').value,
    start_date: $('tc-start').value || null,
    end_date: $('tc-end').value || null,
    target_plays_per_day: +$('tc-plays-day').value,
    isci_code: $('tc-isci').value,
    notes: $('tc-notes').value,
  };
  if (!body.name) { toast('Name is required', false); return; }
  if (_tcEditId) await api('PUT', `/api/traffic/${_tcEditId}`, body);
  else           await api('POST', '/api/traffic', body);
  document.getElementById('tc-modal-overlay')?.remove();
  loadTraffic();
  toast(_tcEditId ? 'Component updated' : 'Component added');
}

async function deleteTraffic(id) {
  if (!confirm('Delete this component?')) return;
  await api('DELETE', `/api/traffic/${id}`);
  loadTraffic();
  toast('Deleted');
}

// ── Announcers ────────────────────────────────────────────────────────────────
let _annEditId = null;

async function loadAnnouncers() {
  const data = await api('GET', '/api/announcers');
  const rows = data.announcers || [];
  $('ann-tbody').innerHTML = rows.length ? rows.map(a => `
    <tr>
      <td style="font-weight:600">${esc(a.name)}</td>
      <td style="color:var(--muted)">${esc(a.initials||'')}</td>
      <td>${a.active ? '<span class="pill pill-green">Active</span>' : '<span class="pill pill-red">Off</span>'}</td>
      <td style="color:var(--muted);font-size:12px">${esc(a.notes||'')}</td>
      <td>
        <button class="btn btn-muted btn-sm" onclick="openAnnouncerModal(${JSON.stringify(a).replace(/"/g,'&quot;')})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteAnnouncer('${a.id}')">Del</button>
      </td>
    </tr>`).join('') : '<tr><td colspan="5" class="empty">No announcers. Click + Add Announcer.</td></tr>';
}

function openAnnouncerModal(ann) {
  _annEditId = ann ? ann.id : null;
  const html = `
    <div class="card" style="max-width:400px;margin:24px auto">
      <h3 style="font-size:15px;font-weight:600;margin-bottom:16px">${_annEditId?'Edit':'Add'} Announcer</h3>
      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2"><label>Name *</label><input type="text" id="ann-name" value="${ann?esc(ann.name):''}"></div>
        <div class="form-group"><label>Initials</label><input type="text" id="ann-init" maxlength="4" value="${ann?esc(ann.initials||''):''}"></div>
        <div class="form-group"><label>Active</label><select id="ann-active">
          <option value="true"${!ann||ann.active?' selected':''}>Yes</option>
          <option value="false"${ann&&!ann.active?' selected':''}>No</option>
        </select></div>
        <div class="form-group" style="grid-column:span 2"><label>Notes</label><input type="text" id="ann-notes" value="${ann?esc(ann.notes||''):''}"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-primary" onclick="saveAnnouncer()">Save</button>
        <button class="btn btn-muted" onclick="document.getElementById('ann-modal-overlay').remove()">Cancel</button>
      </div>
    </div>`;
  const el = document.createElement('div');
  el.innerHTML = html;
  el.style.cssText = 'position:fixed;inset:0;background:#0009;z-index:200;display:flex;align-items:center;justify-content:center';
  el.id = 'ann-modal-overlay';
  el.onclick = e => { if (e.target===el) el.remove(); };
  document.body.appendChild(el);
}

async function saveAnnouncer() {
  const body = {
    name: $('ann-name').value,
    initials: $('ann-init').value,
    active: $('ann-active').value === 'true',
    notes: $('ann-notes').value,
  };
  if (!body.name) { toast('Name is required', false); return; }
  if (_annEditId) await api('PUT', `/api/announcers/${_annEditId}`, body);
  else            await api('POST', '/api/announcers', body);
  document.getElementById('ann-modal-overlay')?.remove();
  loadAnnouncers();
  toast(_annEditId ? 'Announcer updated' : 'Announcer added');
}

async function deleteAnnouncer(id) {
  if (!confirm('Delete this announcer?')) return;
  await api('DELETE', `/api/announcers/${id}`);
  loadAnnouncers();
  toast('Deleted');
}

// ── Boot ──────────────────────────────────────────────────────────────────────
(async () => {
  const [status] = await Promise.all([
    api('GET', '/api/status'),
    loadCategories(),          // must load before any rendering
  ]);
  if (status && status.ai_available) $('ai-badge').style.display = '';

  // Auto-open the correct tab based on which URL the user navigated from
  const PATH_TAB = { '/library': 'tracks', '/clocks-editor': 'clocks', '/rules-editor': 'rules' };
  const autoTab = PATH_TAB[location.pathname];
  if (autoTab) showTab(autoTab, navBtn(autoTab));
  else loadDashboard();
})();
</script>
</body>
</html>
