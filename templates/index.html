<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Scheduler</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #252836;
    --border: #2e3147; --accent: #6c63ff; --accent2: #ff6584;
    --text: #e2e8f0; --muted: #7c85a2; --success: #48bb78; --danger: #fc8181;
    --warn: #f6ad55;
  }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; min-height: 100vh; }
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; gap: 16px; height: 56px; }
  header h1 { font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: .5px; }
  header .badge { background: var(--accent); color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 600; }
  nav { display: flex; gap: 2px; margin-left: auto; }
  nav button { background: none; border: none; color: var(--muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all .15s; }
  nav button:hover { background: var(--surface2); color: var(--text); }
  nav button.active { background: var(--accent); color: #fff; }
  main { max-width: 1100px; margin: 0 auto; padding: 24px; }
  .tab { display: none; } .tab.active { display: block; }
  h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  /* Toolbar */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  input[type=text], input[type=number], input[type=time], input[type=date], select, textarea {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    border-radius: 6px; padding: 7px 12px; font-size: 13px; outline: none; transition: border .15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  input[type=text] { min-width: 180px; }
  /* Buttons */
  .btn { padding: 7px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity .15s; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
  .btn:hover { opacity: .85; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-danger  { background: var(--danger); color: #fff; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-warn    { background: var(--warn); color: #1a1200; }
  .btn-muted   { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  /* Table */
  .tbl-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .6px; color: var(--muted); padding: 8px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }
  tr.row-error td { background: rgba(252,129,129,.07); }
  tr.row-warn  td { background: rgba(246,173,85,.07); }
  .pill { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600; }
  .pill-purple { background: #3d3571; color: #b8b0ff; }
  .pill-blue   { background: #1e3a5f; color: #90cdf4; }
  .pill-green  { background: #1d4a2e; color: #9ae6b4; }
  .pill-orange { background: #4a2d0d; color: #fbd38d; }
  .pill-pink   { background: #4a1d2e; color: #fbb6ce; }
  .pill-red    { background: #4a1d1d; color: #fca5a5; }
  /* Forms */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  label { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); }
  .form-grid input, .form-grid select { width: 100%; }
  /* Stats */
  .stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
  .stat { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; flex: 1; min-width: 120px; }
  .stat-val { font-size: 22px; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; }
  /* Toast */
  #toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; font-size: 13px; box-shadow: 0 4px 20px #0008; opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 999; }
  #toast.show { opacity: 1; }
  #toast.ok   { border-left: 3px solid var(--success); }
  #toast.err  { border-left: 3px solid var(--danger); }
  /* Empty */
  .empty { text-align: center; color: var(--muted); padding: 40px; }
  /* Modal */
  .modal-bg { display: none; position: fixed; inset: 0; background: #0009; z-index: 100; align-items: center; justify-content: center; }
  .modal-bg.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
  .modal h3 { margin-bottom: 16px; font-size: 15px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
  /* Clock slots */
  #slots-list .slot-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  #slots-list .slot-row select, #slots-list .slot-row input { flex: 1; }
  /* Schedule track list */
  .track-pos { color: var(--muted); font-size: 12px; width: 32px; }
  .air-time  { color: var(--warn); font-size: 12px; white-space: nowrap; }
  .dur       { color: var(--muted); font-size: 12px; }
  /* Progress bar */
  .progress-wrap { background: var(--surface2); border-radius: 99px; height: 8px; overflow: hidden; margin: 12px 0; }
  .progress-bar  { height: 100%; background: var(--accent); border-radius: 99px; transition: width .4s ease; width: 0%; }
  /* Dashboard quick actions */
  .quick-actions { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .quick-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; cursor: pointer; transition: border-color .15s, transform .15s; display: flex; align-items: center; gap: 12px; }
  .quick-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .quick-card .icon { font-size: 24px; }
  .quick-card .label { font-weight: 600; font-size: 13px; }
  .quick-card .sub   { font-size: 11px; color: var(--muted); margin-top: 2px; }
  /* Activity feed */
  .activity-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
  .activity-text { flex: 1; font-size: 13px; }
  .activity-time { font-size: 11px; color: var(--muted); white-space: nowrap; }
  /* Export format cards */
  .export-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .export-card { background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all .15s; }
  .export-card:hover { border-color: var(--muted); }
  .export-card.selected { border-color: var(--accent); background: rgba(108,99,255,.08); }
  .export-card .ec-icon { font-size: 28px; margin-bottom: 8px; }
  .export-card .ec-title { font-weight: 700; font-size: 14px; }
  .export-card .ec-desc  { font-size: 11px; color: var(--muted); margin: 4px 0 8px; }
  .export-card .ec-tags  { display: flex; gap: 4px; flex-wrap: wrap; }
  .ec-tag { background: var(--border); color: var(--muted); font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
  /* Violation panel */
  .viol-panel { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 16px; }
  .viol-stats { display: flex; gap: 16px; margin-bottom: 12px; }
  .viol-stat { flex: 1; text-align: center; }
  .viol-stat-val { font-size: 28px; font-weight: 700; }
  .viol-stat-val.err  { color: var(--danger); }
  .viol-stat-val.warn { color: var(--warn); }
  .viol-stat-val.ok   { color: var(--success); }
  .viol-stat-label { font-size: 11px; color: var(--muted); }
  .viol-list { max-height: 200px; overflow-y: auto; }
  .viol-item { padding: 6px 8px; border-radius: 6px; margin-bottom: 4px; font-size: 12px; }
  .viol-item.error   { background: rgba(252,129,129,.12); color: var(--danger); }
  .viol-item.warning { background: rgba(246,173,85,.12); color: var(--warn); }

  /* ── Daypart bands ── */
  :root {
    --dp-overnight: rgba(0,188,212,.13);
    --dp-early:     rgba(255,138,101,.14);
    --dp-morning:   rgba(255,214,0,.16);
    --dp-midmorn:   rgba(102,187,106,.13);
    --dp-midday:    rgba(255,152,0,.13);
    --dp-afternoon: rgba(229,57,53,.13);
    --dp-evening:   rgba(236,64,122,.13);
    --dp-latenight: rgba(126,87,194,.13);
  }
  tr.dp-overnight td { background: var(--dp-overnight); }
  tr.dp-early td     { background: var(--dp-early); }
  tr.dp-morning td   { background: var(--dp-morning); }
  tr.dp-midmorn td   { background: var(--dp-midmorn); }
  tr.dp-midday td    { background: var(--dp-midday); }
  tr.dp-afternoon td { background: var(--dp-afternoon); }
  tr.dp-evening td   { background: var(--dp-evening); }
  tr.dp-latenight td { background: var(--dp-latenight); }
  /* hour-label overrides to keep its own bg */
  tr.dp-overnight td.hour-label { background: var(--surface2); border-left: 3px solid #00bcd4; }
  tr.dp-early td.hour-label     { background: var(--surface2); border-left: 3px solid #ff8a65; }
  tr.dp-morning td.hour-label   { background: var(--surface2); border-left: 3px solid #ffd600; }
  tr.dp-midmorn td.hour-label   { background: var(--surface2); border-left: 3px solid #66bb6a; }
  tr.dp-midday td.hour-label    { background: var(--surface2); border-left: 3px solid #ff9800; }
  tr.dp-afternoon td.hour-label { background: var(--surface2); border-left: 3px solid #e53935; }
  tr.dp-evening td.hour-label   { background: var(--surface2); border-left: 3px solid #ec407a; }
  tr.dp-latenight td.hour-label { background: var(--surface2); border-left: 3px solid #7e57c2; }

  /* ── Program Grid (week view) ── */
  .pg-view-toggle { display: flex; gap: 4px; margin-bottom: 16px; }
  .pg-view-toggle button { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .15s; }
  .pg-view-toggle button.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .prog-grid-wrap { overflow-x: auto; }
  .prog-grid { border-collapse: collapse; font-size: 12px; min-width: 700px; width: 100%; }
  .prog-grid th { padding: 6px 8px; background: var(--surface2); border: 1px solid var(--border); white-space: nowrap; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); text-align: center; }
  .prog-grid td { border: 1px solid var(--border); padding: 0; vertical-align: top; min-width: 100px; }
  .prog-grid .hour-label { background: var(--surface2); color: var(--muted); font-size: 11px; padding: 5px 8px; text-align: right; white-space: nowrap; min-width: 56px; font-weight: 600; }
  .grid-cell { min-height: 32px; padding: 4px 6px; cursor: pointer; transition: background .1s; display: flex; align-items: center; justify-content: space-between; gap: 4px; }
  .grid-cell:hover { background: var(--surface2); }
  .grid-cell .gc-name { font-size: 11px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
  .grid-cell .gc-empty { font-size: 11px; color: var(--border); font-style: italic; }
  .grid-cell .gc-clr { display: inline-block; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .cell-assigned { background: rgba(108,99,255,.08); }
  .day-col-head { font-weight: 700; color: var(--text); }
  /* Grid cell picker dropdown */
  .gc-select { width: 100%; background: transparent; border: none; color: var(--text); font-size: 11px; padding: 4px; border-radius: 4px; cursor: pointer; }
  .gc-select:focus { outline: 1px solid var(--accent); background: var(--surface); }
  /* Daypart map mode — solid colored cells */
  .dp-map-cell { height: 28px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; letter-spacing: .4px; color: rgba(0,0,0,.45); cursor: default; }

  /* ── Day Detail view ── */
  .day-detail-wrap { display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; max-height: 70vh; }
  .ddl-panel { width: 190px; flex-shrink: 0; border-right: 1px solid var(--border); overflow-y: auto; background: var(--surface2); }
  .ddl-item { padding: 9px 14px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); transition: background .1s; }
  .ddl-item:hover { background: var(--surface); }
  .ddl-item.active { background: rgba(108,99,255,.18); color: var(--accent); font-weight: 600; }
  .ddl-item.add-btn { color: var(--accent); font-size: 12px; }
  .dd-center { flex: 1; overflow-y: auto; }
  .dd-row { display: flex; align-items: center; gap: 0; border-bottom: 1px solid var(--border); }
  .dd-row:last-child { border-bottom: none; }
  .dd-hour { width: 70px; flex-shrink: 0; font-size: 11px; color: var(--muted); font-weight: 600; padding: 5px 10px; white-space: nowrap; }
  .dd-hour-name { font-size: 9px; display: block; text-transform: uppercase; letter-spacing: .4px; margin-top: 1px; }
  .dd-sel { flex: 1; background: transparent; border: none; color: var(--text); font-size: 12px; padding: 5px 8px; cursor: pointer; }
  .dd-sel:focus { outline: 1px solid var(--accent); background: var(--surface2); }

  /* ── Daypart legend (map mode) ── */
  .dp-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; align-items: center; }
  .dp-leg-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted); }
  .dp-swatch { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }

  /* ── Clock pie chart ── */
  .pie-modal-body { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; justify-content: center; }
  .pie-legend { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
  .pie-leg-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }
  .pie-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

  /* ── Schedule view modes ── */
  .view-toggle { display: flex; gap: 4px; margin-bottom: 12px; }
  .view-toggle button { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .15s; }
  .view-toggle button.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Hour-block view */
  .hour-block { margin-bottom: 12px; }
  .hour-block-head { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px 6px 0 0; padding: 6px 12px; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .hour-block-body { border: 1px solid var(--border); border-top: none; border-radius: 0 0 6px 6px; }
  .hb-row { display: flex; align-items: center; gap: 10px; padding: 7px 12px; border-bottom: 1px solid var(--border); }
  .hb-row:last-child { border-bottom: none; }
  .hb-pos { color: var(--muted); font-size: 11px; width: 24px; flex-shrink: 0; }
  .hb-time { color: var(--warn); font-size: 11px; width: 52px; flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .hb-title { font-weight: 500; flex: 1; font-size: 13px; }
  .hb-artist { color: var(--muted); font-size: 12px; width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .hb-dur { color: var(--muted); font-size: 11px; width: 40px; text-align: right; flex-shrink: 0; }

  /* Timeline view */
  .timeline-wrap { overflow-x: auto; padding-bottom: 8px; }
  .timeline { position: relative; height: auto; }
  .tl-ruler { display: flex; height: 20px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
  .tl-tick { border-left: 1px solid var(--border); flex-shrink: 0; font-size: 10px; color: var(--muted); padding-left: 3px; padding-top: 4px; }
  .tl-track { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .tl-label { width: 130px; flex-shrink: 0; font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; }
  .tl-bar-wrap { flex: 1; position: relative; height: 22px; }
  .tl-bar { position: absolute; height: 20px; border-radius: 3px; display: flex; align-items: center; padding: 0 6px; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: default; transition: opacity .1s; }
  .tl-bar:hover { opacity: .85; }
  .tl-spot  { background: rgba(252,129,129,.5); color: #fca5a5; }
  .tl-liner { background: rgba(246,173,85,.4); color: #fbd38d; }
  .tl-lognote { background: rgba(128,128,128,.4); color: var(--muted); }
  .tl-music-0 { background: rgba(108,99,255,.6); color: #b8b0ff; }
  .tl-music-1 { background: rgba(72,187,120,.5); color: #9ae6b4; }
  .tl-music-2 { background: rgba(246,173,85,.5); color: #fbd38d; }
  .tl-music-3 { background: rgba(255,101,132,.5); color: #fbb6ce; }

  /* ── Rules Engine ── */
  .rules-section-head { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--muted); margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  .rule-hint { font-size: 10px; color: var(--muted); margin-top: 2px; line-height: 1.4; }
  /* Conditional rule cards */
  .cr-rule { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
  .cr-rule.cr-disabled { opacity: .55; }
  .cr-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .cr-toggle { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; color: var(--muted); white-space: nowrap; flex-shrink: 0; }
  .cr-toggle input[type=checkbox] { width: auto; }
  .cr-label-inp { flex: 1; background: transparent; border: none; border-bottom: 1px dashed var(--border); color: var(--text); font-size: 13px; font-weight: 600; padding: 2px 4px; outline: none; min-width: 0; }
  .cr-label-inp:focus { border-bottom-color: var(--accent); }
  .cr-body { padding: 14px; display: flex; flex-direction: column; gap: 12px; }
  .cr-section { display: flex; gap: 10px; align-items: flex-start; }
  .cr-kw { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: .6px; padding: 5px 8px; border-radius: 4px; flex-shrink: 0; margin-top: 5px; min-width: 44px; text-align: center; }
  .cr-kw.kw-if   { background: rgba(108,99,255,.2); color: var(--accent); }
  .cr-kw.kw-then { background: rgba(72,187,120,.2); color: var(--success); }
  .cr-inner { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  .cr-cond-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .cr-cond-field { flex: 2; min-width: 160px; }
  .cr-cond-op    { flex: 1; min-width: 80px; }
  .cr-cond-val   { flex: 1.5; min-width: 90px; }
  .cr-cond-val input, .cr-cond-val select { width: 100%; }
  .cr-between { display: flex; gap: 4px; align-items: center; }
  .cr-between input { flex: 1; min-width: 50px; }
  .cr-foot { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 2px; }
  .cr-logic { display: flex; gap: 10px; align-items: center; font-size: 12px; color: var(--muted); }
  .cr-logic label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; text-transform: none; letter-spacing: 0; color: var(--text); }
  .cr-logic input[type=radio] { width: auto; }
  .cr-action-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .cr-action-type { flex: 2; min-width: 240px; }
  .cr-action-val { flex: 1; min-width: 90px; }
  .cr-action-val input, .cr-action-val select { width: 100%; }
</style>
</head>
<body>

<header>
  <h1 style="cursor:pointer" onclick="window.location.href='/'">&#127925; Music Scheduler</h1>
  <span class="badge" id="ai-badge" style="display:none">AI</span>
  <nav>
    <button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
    <button onclick="showTab('tracks',this)">Tracks</button>
    <button onclick="showTab('clocks',this)">Clocks</button>
    <button onclick="showTab('schedules',this)">Schedules</button>
    <button onclick="showTab('program',this)">Program</button>
    <button onclick="showTab('export',this)">Export</button>
    <button onclick="showTab('rules',this)">Rules</button>
  </nav>
</header>

<main>

<!-- ======================== DASHBOARD TAB ======================== -->
<div id="tab-dashboard" class="tab active">
  <div class="stats" id="dash-stats"></div>

  <div class="card">
    <h2>Quick Actions</h2>
    <div class="quick-actions">
      <div class="quick-card" onclick="showTab('schedules',navBtn('schedules'))">
        <div class="icon">&#9654;</div>
        <div><div class="label">Generate Schedule</div><div class="sub">Build a new rotation</div></div>
      </div>
      <div class="quick-card" onclick="showTab('tracks',navBtn('tracks'))">
        <div class="icon">&#127925;</div>
        <div><div class="label">Track Library</div><div class="sub">Add or manage tracks</div></div>
      </div>
      <div class="quick-card" onclick="showTab('clocks',navBtn('clocks'))">
        <div class="icon">&#128336;</div>
        <div><div class="label">Clock Templates</div><div class="sub">Design hour clocks</div></div>
      </div>
      <div class="quick-card" onclick="showTab('export',navBtn('export'))">
        <div class="icon">&#128229;</div>
        <div><div class="label">Export</div><div class="sub">Download schedule files</div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Recent Schedules</h2>
    <div id="dash-activity"></div>
  </div>
</div>

<!-- ======================== TRACKS TAB ======================== -->
<div id="tab-tracks" class="tab">
  <div class="stats" id="track-stats"></div>
  <div class="card">
    <div class="toolbar">
      <input type="text" id="track-search" placeholder="Search title / artist…" oninput="loadTracks()">
      <select id="track-cat" onchange="loadTracks()">
        <option value="">All categories</option>
      </select>
      <select id="track-sort" onchange="loadTracks()">
        <option value="added_at">Date added</option>
        <option value="title">Title</option>
        <option value="artist">Artist</option>
        <option value="play_count">Play count</option>
        <option value="bpm">BPM</option>
        <option value="energy">Energy</option>
      </select>
      <select id="track-order" onchange="loadTracks()">
        <option value="asc">Asc</option>
        <option value="desc">Desc</option>
      </select>
      <button class="btn btn-primary" onclick="openAddTrack()">+ Add Track</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>Title</th><th>Artist</th><th>Category</th>
          <th>Duration</th><th>BPM</th><th>Energy</th><th>Plays</th><th></th>
        </tr></thead>
        <tbody id="tracks-body"></tbody>
      </table>
    </div>
    <div id="tracks-empty" class="empty" style="display:none">No tracks yet — add one above.</div>
    <div id="tracks-footer" style="font-size:12px;color:var(--muted);margin-top:10px;display:none;gap:12px;align-items:center">
      <span id="tracks-count"></span>
      <button id="tracks-load-more" class="btn btn-muted btn-sm" style="display:none" onclick="loadMoreTracks()">Load more…</button>
    </div>
  </div>
</div>

<!-- ======================== CLOCKS TAB ======================== -->
<div id="tab-clocks" class="tab">
  <div class="card">
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openClockModal()">+ New Clock Template</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Slots</th><th>Created</th><th></th></tr></thead>
        <tbody id="clocks-body"></tbody>
      </table>
    </div>
    <div id="clocks-empty" class="empty" style="display:none">No clock templates yet.</div>
  </div>
</div>

<!-- Clock Pie Chart Modal -->
<div class="modal-bg" id="modal-pie">
  <div class="modal" style="width:520px">
    <h3 id="pie-title">Clock Composition</h3>
    <div class="pie-modal-body">
      <svg id="pie-svg" width="220" height="220" viewBox="0 0 220 220"></svg>
      <div class="pie-legend" id="pie-legend"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-pie')">Close</button>
    </div>
  </div>
</div>

<!-- ======================== SCHEDULES TAB ======================== -->
<div id="tab-schedules" class="tab">
  <div class="card">
    <h2>Generate Schedule</h2>
    <div class="form-grid" style="margin-bottom:12px">
      <div class="form-group">
        <label>Clock Template</label>
        <select id="gen-clock"></select>
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" id="gen-duration" value="60" min="1">
      </div>
      <div class="form-group">
        <label>Start Time</label>
        <input type="time" id="gen-start">
      </div>
      <div class="form-group">
        <label>Schedule Name</label>
        <input type="text" id="gen-name" placeholder="Optional name…">
      </div>
    </div>
    <div id="gen-progress" style="display:none">
      <div style="color:var(--muted);font-size:13px;margin-bottom:4px" id="gen-status-text">Generating…</div>
      <div class="progress-wrap"><div class="progress-bar" id="gen-bar"></div></div>
    </div>
    <button class="btn btn-primary" id="gen-btn" onclick="generateSchedule()">&#9654; Generate</button>
  </div>

  <div class="card">
    <h2>Saved Schedules</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Clock</th><th>Tracks</th><th>Duration</th><th>Created</th><th></th></tr></thead>
        <tbody id="schedules-body"></tbody>
      </table>
    </div>
    <div id="schedules-empty" class="empty" style="display:none">No schedules yet.</div>
  </div>
</div>

<!-- ======================== PROGRAM GRID TAB ======================== -->
<div id="tab-program" class="tab">

  <!-- Template selector + create toolbar -->
  <div class="card">
    <h2>Program Grid</h2>
    <div class="toolbar" style="margin-bottom:12px">
      <select id="pg-tmpl-sel" onchange="loadProgramGrid()">
        <option value="">— Select a day template —</option>
      </select>
      <input type="text" id="pg-new-name" placeholder="New template name…" style="max-width:200px">
      <button class="btn btn-primary btn-sm" onclick="createDayTemplate()">+ New Template</button>
      <button class="btn btn-danger btn-sm" id="pg-del-btn" style="display:none" onclick="deleteDayTemplate()">Delete Template</button>
    </div>

    <!-- View mode toggle -->
    <div class="pg-view-toggle">
      <button class="active" id="pgv-grid"     onclick="switchPgView('grid')">&#9783; Week Grid</button>
      <button              id="pgv-detail"   onclick="switchPgView('detail')">&#9776; Day Detail</button>
      <button              id="pgv-daypart"  onclick="switchPgView('daypart')">&#9632; Daypart Map</button>
    </div>

    <!-- ── WEEK GRID view ── -->
    <div id="pg-view-grid">
      <p style="font-size:12px;color:var(--muted);margin-bottom:10px">
        Each cell: pick a clock for that day &amp; hour. Row colors show daypart bands. Changes save immediately.
      </p>
      <div class="prog-grid-wrap">
        <table class="prog-grid" id="prog-grid">
          <thead>
            <tr>
              <th style="min-width:56px">Hr</th>
              <th class="day-col-head">Mon</th>
              <th class="day-col-head">Tue</th>
              <th class="day-col-head">Wed</th>
              <th class="day-col-head">Thu</th>
              <th class="day-col-head">Fri</th>
              <th class="day-col-head">Sat</th>
              <th class="day-col-head">Sun</th>
            </tr>
          </thead>
          <tbody id="prog-grid-body"></tbody>
        </table>
      </div>
      <div id="prog-grid-empty" class="empty" style="display:none">Select or create a day template to start programming.</div>
    </div>

    <!-- ── DAY DETAIL view ── -->
    <div id="pg-view-detail" style="display:none">
      <p style="font-size:12px;color:var(--muted);margin-bottom:10px">
        Select a day template on the left to see &amp; edit its full 24-hour clock schedule.
      </p>
      <div class="day-detail-wrap">
        <div class="ddl-panel" id="ddl-panel">
          <div class="empty" style="padding:16px;font-size:12px">No templates yet.</div>
        </div>
        <div class="dd-center" id="dd-center">
          <div class="empty" style="padding:40px 20px">Select a template on the left.</div>
        </div>
      </div>
    </div>

    <!-- ── DAYPART MAP view ── -->
    <div id="pg-view-daypart" style="display:none">
      <div class="dp-legend" id="dp-legend"></div>
      <div class="prog-grid-wrap">
        <table class="prog-grid" id="dp-map-grid">
          <thead>
            <tr>
              <th style="min-width:56px">Hr</th>
              <th class="day-col-head">Mon</th>
              <th class="day-col-head">Tue</th>
              <th class="day-col-head">Wed</th>
              <th class="day-col-head">Thu</th>
              <th class="day-col-head">Fri</th>
              <th class="day-col-head">Sat</th>
              <th class="day-col-head">Sun</th>
            </tr>
          </thead>
          <tbody id="dp-map-body"></tbody>
        </table>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:8px">
        Bands show standard daypart groupings. Switch to Week Grid to change clock assignments.
      </p>
    </div>
  </div>

  <!-- Generate from template -->
  <div class="card" id="pg-gen-card" style="display:none">
    <h2>Generate from Template</h2>
    <div class="form-grid" style="margin-bottom:12px">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="pg-gen-date">
      </div>
      <div class="form-group">
        <label>Start Hour</label>
        <input type="number" id="pg-gen-start-hr" value="0" min="0" max="23">
      </div>
      <div class="form-group">
        <label>End Hour</label>
        <input type="number" id="pg-gen-end-hr" value="23" min="0" max="23">
      </div>
      <div class="form-group">
        <label>Schedule Name</label>
        <input type="text" id="pg-gen-name" placeholder="Optional…">
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateFromTemplate()">&#9654; Generate Full Day</button>
    <span id="pg-gen-status" style="font-size:12px;color:var(--muted);margin-left:12px"></span>
  </div>
</div>

<!-- ======================== EXPORT TAB ======================== -->
<div id="tab-export" class="tab">
  <div class="card">
    <h2>Export Format</h2>
    <div class="export-grid" id="export-cards">
      <div class="export-card selected" data-fmt="csv" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128202;</div>
        <div class="ec-title">CSV</div>
        <div class="ec-desc">Universal spreadsheet format</div>
        <div class="ec-tags"><span class="ec-tag">.CSV</span></div>
      </div>
      <div class="export-card" data-fmt="zetta-log" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128251;</div>
        <div class="ec-title">Zetta LOG</div>
        <div class="ec-desc">RCS Zetta automation system</div>
        <div class="ec-tags"><span class="ec-tag">.LOG</span></div>
      </div>
      <div class="export-card" data-fmt="zetta-xml" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#128251;</div>
        <div class="ec-title">Zetta XML</div>
        <div class="ec-desc">RCS Zetta XML format</div>
        <div class="ec-tags"><span class="ec-tag">.XML</span></div>
      </div>
      <div class="export-card" data-fmt="wideorbit" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#127925;</div>
        <div class="ec-title">WideOrbit</div>
        <div class="ec-desc">WideOrbit automation system</div>
        <div class="ec-tags"><span class="ec-tag">.WO</span></div>
      </div>
      <div class="export-card" data-fmt="enco" onclick="toggleExportCard(this)">
        <div class="ec-icon">&#127926;</div>
        <div class="ec-title">ENCO DAD</div>
        <div class="ec-desc">ENCO automation system</div>
        <div class="ec-tags"><span class="ec-tag">.TXT</span></div>
      </div>
    </div>
    <div class="form-grid" style="margin-bottom:16px">
      <div class="form-group">
        <label>Schedule</label>
        <select id="export-sched-sel"></select>
      </div>
      <div class="form-group">
        <label>Start Time (for air times)</label>
        <input type="time" id="export-start">
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-primary" onclick="doExport()">&#128229; Export</button>
      <span id="export-note" style="font-size:12px;color:var(--muted)"></span>
    </div>
  </div>

  <div class="card">
    <h2>Saved Schedules</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Name</th><th>Clock</th><th>Tracks</th><th>Created</th><th></th></tr></thead>
        <tbody id="export-schedules-body"></tbody>
      </table>
    </div>
    <div id="export-schedules-empty" class="empty" style="display:none">No schedules yet.</div>
  </div>
</div>

<!-- ======================== RULES TAB ======================== -->
<div id="tab-rules" class="tab">

  <div class="toolbar" style="align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin:0">Rotation Rules Engine</h2>
    <button class="btn btn-primary" onclick="saveRules()">Save All Rules</button>
  </div>
  <p style="color:var(--muted);font-size:12px;margin-bottom:20px">Configure global scheduling rules applied during schedule generation. Conditional rules override global values for specific tracks or contexts.</p>

  <!-- ── Separation Rules ── -->
  <div class="card">
    <div class="rules-section-head">Separation Rules</div>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(230px,1fr))">
      <div class="form-group">
        <label>Artist Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-artist_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between plays of the same artist</span>
      </div>
      <div class="form-group">
        <label>Title Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-title_separation_hours" min="0" step="0.5" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">hours</span>
        </div>
        <span class="rule-hint">Min hours before the same title can repeat</span>
      </div>
      <div class="form-group">
        <label>Stack Key Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-stack_key_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between tracks sharing a stack group (versions / box sets)</span>
      </div>
      <div class="form-group">
        <label>Album Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-album_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Min songs between tracks from the same album (0 = disabled)</span>
      </div>
    </div>
    <div style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px">
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-allow_double_shots" style="width:auto">
          Allow Double Shots
        </label>
        <span class="rule-hint">Let the same artist appear back-to-back on occasion</span>
      </div>
      <div class="form-group">
        <label>Double Shot Separation</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input type="number" id="rule-double_shot_separation_songs" min="0" style="flex:1">
          <span style="font-size:11px;color:var(--muted)">songs</span>
        </div>
        <span class="rule-hint">Songs between double-shot appearances</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-check_prev_day_artist" style="width:auto">
          Check Prev-Day Artist
        </label>
        <span class="rule-hint">Avoid the same artist in the same hour on consecutive days</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-check_prev_day_song" style="width:auto">
          Check Prev-Day Song
        </label>
        <span class="rule-hint">Avoid the same title in the same hour on consecutive days</span>
      </div>
    </div>
  </div>

  <!-- ── Flow & Sequencing ── -->
  <div class="card">
    <div class="rules-section-head">Flow &amp; Sequencing</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Limit consecutive runs of the same attribute. Set <strong style="color:var(--text)">−1</strong> to disable a limit.</p>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr))">
      <div class="form-group">
        <label>Max Gender Run</label>
        <input type="number" id="rule-max_gender_run" min="-1">
        <span class="rule-hint">e.g. 3 = no more than 3 consecutive male songs</span>
      </div>
      <div class="form-group">
        <label>Max Tempo Run</label>
        <input type="number" id="rule-max_tempo_run" min="-1">
        <span class="rule-hint">Prevents monotonous tempo sequences</span>
      </div>
      <div class="form-group">
        <label>Max Mood Run</label>
        <input type="number" id="rule-max_mood_run" min="-1">
        <span class="rule-hint">Prevents monotonous mood sequences</span>
      </div>
      <div class="form-group">
        <label>Max Texture Run</label>
        <input type="number" id="rule-max_texture_run" min="-1">
        <span class="rule-hint">Prevents monotonous texture sequences</span>
      </div>
      <div class="form-group">
        <label>Max Energy Run</label>
        <input type="number" id="rule-max_energy_run" min="-1">
        <span class="rule-hint">Prevents monotonous energy-level sequences</span>
      </div>
    </div>
    <div style="margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
      <div class="form-group">
        <label>Energy Step Limit</label>
        <input type="number" id="rule-energy_step_limit" min="0">
        <span class="rule-hint">Max energy jump between consecutive songs (0 = off)</span>
      </div>
      <div class="form-group">
        <label>BPM Step Limit</label>
        <input type="number" id="rule-bpm_step_limit" min="0">
        <span class="rule-hint">Max BPM jump between consecutive songs (0 = off)</span>
      </div>
    </div>
  </div>

  <!-- ── Scheduling Restrictions ── -->
  <div class="card">
    <div class="rules-section-head">Scheduling Restrictions</div>
    <div class="form-grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr))">
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-enforce_date_range" style="width:auto">
          Enforce Date Range
        </label>
        <span class="rule-hint">Skip tracks outside their configured start/end date window</span>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:13px;letter-spacing:0;font-weight:500">
          <input type="checkbox" id="rule-enforce_hour_open_close" style="width:auto">
          Enforce Hour Open / Close Flags
        </label>
        <span class="rule-hint">Respect can_open_hour / can_close_hour track flags</span>
      </div>
    </div>
  </div>

  <!-- ── Conditional Rules ── -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div class="rules-section-head" style="margin:0;border:none;padding:0">Conditional Rules — If / Then</div>
      <button class="btn btn-primary btn-sm" onclick="addConditionalRule()">+ Add Rule</button>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
      Override scheduling behavior for specific tracks or contexts. Rules are evaluated in order; multiple matching rules stack their overrides.
      <br>Use <strong style="color:var(--text)">IF</strong> conditions to describe the context, and <strong style="color:var(--success)">THEN</strong> to define what changes or is required.
    </p>
    <div id="cond-rules-list">
      <div class="empty" id="cond-rules-empty" style="padding:20px">No conditional rules defined. Click <strong>+ Add Rule</strong> to create one.</div>
    </div>
  </div>

</div>

</main>

<!-- ======================== MODALS ======================== -->

<!-- Add Track -->
<div class="modal-bg" id="modal-track">
  <div class="modal">
    <h3>Add Track</h3>
    <div class="form-grid">
      <div class="form-group"><label>Title *</label><input type="text" id="t-title"></div>
      <div class="form-group"><label>Artist *</label><input type="text" id="t-artist"></div>
      <div class="form-group">
        <label>Category *</label>
        <select id="t-category"></select>
      </div>
      <div class="form-group"><label>Duration (seconds)</label><input type="number" id="t-duration" min="1"></div>
      <div class="form-group"><label>BPM</label><input type="number" id="t-bpm" min="1" max="300"></div>
      <div class="form-group"><label>Energy (1–10)</label><input type="number" id="t-energy" min="1" max="10"></div>
      <div class="form-group"><label>Mood</label><input type="text" id="t-mood" placeholder="e.g. Upbeat"></div>
      <div class="form-group"><label>Notes</label><input type="text" id="t-notes"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-track')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTrack()">Add Track</button>
    </div>
  </div>
</div>

<!-- Clock Builder -->
<div class="modal-bg" id="modal-clock">
  <div class="modal">
    <h3>New Clock Template</h3>
    <div class="form-group" style="margin-bottom:12px">
      <label>Clock Name</label>
      <input type="text" id="clock-name" style="width:100%" placeholder="e.g. Morning Drive">
    </div>
    <label style="font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);display:block;margin-bottom:8px">Slots</label>
    <div id="slots-list"></div>
    <button class="btn btn-muted btn-sm" onclick="addSlot()" style="margin-top:4px">+ Add Slot</button>
    <div class="modal-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-clock')">Cancel</button>
      <button class="btn btn-primary" onclick="saveClock()">Create Clock</button>
    </div>
  </div>
</div>

<!-- Schedule Viewer -->
<div class="modal-bg" id="modal-schedule">
  <div class="modal" style="width:min(1020px,96vw);max-height:94vh">
    <h3 id="modal-sched-title"></h3>
    <div id="modal-sched-stats" class="stats" style="margin-bottom:12px"></div>

    <!-- View mode toggle -->
    <div class="view-toggle">
      <button class="active" id="vt-list"     onclick="switchView('list')">&#9776; List</button>
      <button              id="vt-blocks"   onclick="switchView('blocks')">&#9632; Hour Blocks</button>
      <button              id="vt-timeline" onclick="switchView('timeline')">&#9472; Timeline</button>
    </div>

    <!-- Violation panel -->
    <div id="viol-panel" class="viol-panel" style="display:none">
      <div class="viol-stats" id="viol-stats"></div>
      <div class="viol-list" id="viol-list"></div>
    </div>

    <!-- LIST view -->
    <div id="view-list" class="tbl-wrap">
      <table>
        <thead><tr><th>#</th><th>Air</th><th>Title</th><th>Artist</th><th>Category</th><th>Dur</th></tr></thead>
        <tbody id="modal-sched-body"></tbody>
      </table>
    </div>

    <!-- HOUR BLOCKS view -->
    <div id="view-blocks" style="display:none;max-height:60vh;overflow-y:auto"></div>

    <!-- TIMELINE view -->
    <div id="view-timeline" style="display:none;max-height:60vh;overflow-y:auto">
      <div class="timeline-wrap">
        <div class="tl-ruler" id="tl-ruler"></div>
        <div class="timeline" id="tl-tracks"></div>
      </div>
    </div>

    <div class="modal-actions" id="modal-sched-actions">
      <button class="btn btn-muted" onclick="closeModal('modal-schedule')">Close</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ── Utilities ────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);

// ── Category map ─────────────────────────────────────────────────────────────
// Keyed by m1_id (string), uuid, and name — all pointing to the category record.
let _catMap  = {};   // key → category record
let _catList = [];   // sorted list of schedulable categories (for dropdowns)
let _allCats = [];   // complete category list (for library filter dropdown)

async function loadCategories() {
  const data = await api('GET', '/api/categories');
  const all  = data.categories || [];
  _catMap = {};
  for (const cat of all) {
    if (cat.m1_id != null)  _catMap[String(cat.m1_id)] = cat;
    if (cat.id)             _catMap[cat.id]             = cat;
    if (cat.name)           _catMap[cat.name]           = cat;
  }
  // All categories sorted by name for the library filter
  _allCats = all.slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  // Schedulable categories for dropdowns (exclude housekeeping ones)
  _catList = all.filter(c =>
    c.schedulable !== false &&
    !(c.name || '').startsWith('(')
  ).sort((a, b) => (a.priority || 0) - (b.priority || 0));
}

// Resolve any category key (m1_id / uuid / name) to a display record
function catResolve(c) {
  return _catMap[String(c)] || null;
}
// Value to use in selects for a category record (prefer m1_id, fall back to name)
function catValue(rec) {
  return rec.m1_id != null ? String(rec.m1_id) : (rec.name || rec.id);
}
const api = async (method, path, body) => {
  const r = await fetch(path, {
    method,
    headers: body ? {'Content-Type':'application/json'} : {},
    body: body ? JSON.stringify(body) : undefined,
  });
  if (r.status === 204) return null;
  return r.json();
};
const toast = (msg, ok=true) => {
  const el = $('toast');
  el.textContent = msg;
  el.className = 'show ' + (ok ? 'ok' : 'err');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.className = '', 2800);
};
const fmtDur = s => s ? `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}` : '—';
const fmtDate = s => s ? new Date(s).toLocaleDateString() : '—';
const timeAgo = s => {
  if (!s) return '—';
  const d = (Date.now() - new Date(s)) / 1000;
  if (d < 60)   return 'just now';
  if (d < 3600) return `${Math.floor(d/60)}m ago`;
  if (d < 86400) return `${Math.floor(d/3600)}h ago`;
  return `${Math.floor(d/86400)}d ago`;
};
const CAT_COLORS = {Current:'pill-purple',Recurrent:'pill-blue',Gold:'pill-orange',Power:'pill-green',Jingle:'pill-pink'};
const catPill = c => {
  const rec  = catResolve(c);
  const name = rec ? rec.name : (c || '—');
  if (rec && rec.color) {
    // Use the category's own M1 colour with a subtle tint
    const hex = rec.color;
    return `<span class="pill" style="background:${hex}28;color:${hex};border:1px solid ${hex}55" title="${esc(name)}">${esc(name)}</span>`;
  }
  return `<span class="pill ${CAT_COLORS[name]||'pill-blue'}">${esc(name)}</span>`;
};
function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
const navBtn = name => document.querySelector(`nav button:nth-child(${['dashboard','tracks','clocks','schedules','program','export','rules'].indexOf(name)+1})`);

// ── Tabs ─────────────────────────────────────────────────────────────────────
function showTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  $('tab-'+name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name==='dashboard') loadDashboard();
  if (name==='tracks')    loadTracks();
  if (name==='clocks')    loadClocks();
  if (name==='schedules') { loadSchedules(); loadClocksForGen(); }
  if (name==='program')   loadProgramTab();
  if (name==='export')    loadExportTab();
  if (name==='rules')     loadRules();
}

// ── Modals ────────────────────────────────────────────────────────────────────
function openModal(id)  { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

// ── Dashboard ─────────────────────────────────────────────────────────────────
async function loadDashboard() {
  const [tracksData, schedules, clocks] = await Promise.all([
    api('GET', '/api/tracks?limit=0'),
    api('GET', '/api/schedules'),
    api('GET', '/api/clocks'),
  ]);
  const tracks = tracksData.tracks || [];
  const totalDur = tracks.reduce((s,t) => s+(t.duration_seconds||0), 0);

  $('dash-stats').innerHTML = [
    ['Total Tracks', tracksData.total ?? tracks.length],
    ['Library Duration', fmtDur(totalDur)],
    ['Schedules', schedules.length],
    ['Clock Templates', clocks.length],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');

  // Recent schedules
  const recent = [...schedules].sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||'')).slice(0,5);
  $('dash-activity').innerHTML = recent.length
    ? recent.map(s => `
        <div class="activity-item">
          <div class="activity-dot"></div>
          <div class="activity-text"><strong>${esc(s.name||'Untitled')}</strong> — ${(s.tracks||[]).length} tracks, ${s.duration_minutes||0} min</div>
          <div class="activity-time">${timeAgo(s.created_at)}</div>
          <button class="btn btn-muted btn-sm" onclick="viewScheduleById('${s.id}')">View</button>
        </div>`).join('')
    : '<div class="empty">No schedules yet — generate one!</div>';
}

// ── Tracks ────────────────────────────────────────────────────────────────────
const TRACKS_PER_PAGE = 200;
let _tracksTotal = 0;
let _tracksLoaded = 0;

async function loadTracks() {
  const search = $('track-search').value.trim();
  const cat    = $('track-cat').value;
  const sort   = $('track-sort').value;
  const order  = $('track-order').value;

  // Show loading state immediately so user knows button worked
  $('tracks-body').innerHTML = `<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--muted)">Loading library…</td></tr>`;
  $('tracks-empty').style.display = 'none';
  $('tracks-footer').style.display = 'none';

  let url = `/api/tracks?sort=${sort}&order=${order}&limit=${TRACKS_PER_PAGE}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (cat)    url += `&category=${encodeURIComponent(cat)}`;
  const data = await api('GET', url);
  const tracks = data.tracks || [];
  _tracksTotal = data.total || tracks.length;
  _tracksLoaded = tracks.length;

  renderTracks(tracks);
  updateTrackStats(tracks, _tracksTotal);
  populateCatFilter(tracks);

  // Show footer with count + load-more if needed
  $('tracks-footer').style.display = 'flex';
  $('tracks-count').textContent = _tracksLoaded >= _tracksTotal
    ? `Showing all ${_tracksTotal.toLocaleString()} tracks`
    : `Showing ${_tracksLoaded.toLocaleString()} of ${_tracksTotal.toLocaleString()} tracks`;
  $('tracks-load-more').style.display = _tracksLoaded < _tracksTotal ? '' : 'none';
}

async function loadMoreTracks() {
  const search = $('track-search').value.trim();
  const cat    = $('track-cat').value;
  const sort   = $('track-sort').value;
  const order  = $('track-order').value;

  $('tracks-load-more').textContent = 'Loading…';
  $('tracks-load-more').disabled = true;

  let url = `/api/tracks?sort=${sort}&order=${order}&limit=${TRACKS_PER_PAGE}&offset=${_tracksLoaded}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (cat)    url += `&category=${encodeURIComponent(cat)}`;
  const data = await api('GET', url);
  const newTracks = data.tracks || [];
  _tracksLoaded += newTracks.length;

  // Append rows instead of replacing
  $('tracks-body').innerHTML += newTracks.map((t, i) => renderTrackRow(t, _tracksLoaded - newTracks.length + i)).join('');

  $('tracks-count').textContent = _tracksLoaded >= _tracksTotal
    ? `Showing all ${_tracksTotal.toLocaleString()} tracks`
    : `Showing ${_tracksLoaded.toLocaleString()} of ${_tracksTotal.toLocaleString()} tracks`;
  $('tracks-load-more').textContent = 'Load more…';
  $('tracks-load-more').disabled = false;
  $('tracks-load-more').style.display = _tracksLoaded < _tracksTotal ? '' : 'none';
}
function populateCatFilter(tracks) {
  const sel = $('track-cat');
  const cur = sel.value;
  // Use the full category list from the API so all categories are visible
  // regardless of which page of tracks is currently loaded.
  sel.innerHTML = '<option value="">All categories</option>' +
    _allCats.map(c => {
      const v = catValue(c);
      return `<option value="${esc(v)}" ${v===cur?'selected':''}>${esc(c.name)}</option>`;
    }).join('');
}
function renderTrackRow(t, i) {
  return `<tr>
    <td class="track-pos">${i+1}</td>
    <td><strong>${esc(t.title)}</strong></td>
    <td>${esc(t.artist)}</td>
    <td>${catPill(t.category)}</td>
    <td class="dur">${fmtDur(t.duration_seconds)}</td>
    <td>${t.bpm||'—'}</td>
    <td>${t.energy||'—'}</td>
    <td>${t.play_count||0}</td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteTrack('${t.id}')">✕</button></td>
  </tr>`;
}
function renderTracks(tracks) {
  $('tracks-empty').style.display = tracks.length ? 'none' : '';
  $('tracks-body').innerHTML = tracks.map((t, i) => renderTrackRow(t, i)).join('');
}
function updateTrackStats(tracks, total) {
  const totalDur = tracks.reduce((s,t) => s+(t.duration_seconds||0), 0);
  const cats = new Set(tracks.map(t=>t.category).filter(Boolean)).size;
  $('track-stats').innerHTML = [
    ['Tracks', total ?? tracks.length],
    ['Total Duration', fmtDur(totalDur)],
    ['Categories', cats],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');
}
function openAddTrack() {
  ['t-title','t-artist','t-mood','t-notes'].forEach(id => $(id).value='');
  ['t-duration','t-bpm','t-energy'].forEach(id => $(id).value='');
  $('t-category').innerHTML = _buildCatOptions('');
  openModal('modal-track');
}
async function saveTrack() {
  const body = {
    title: $('t-title').value.trim(),
    artist: $('t-artist').value.trim(),
    category: $('t-category').value,
  };
  if (!body.title || !body.artist) return toast('Title and Artist are required.', false);
  if ($('t-duration').value) body.duration_seconds = +$('t-duration').value;
  if ($('t-bpm').value)      body.bpm = +$('t-bpm').value;
  if ($('t-energy').value)   body.energy = +$('t-energy').value;
  if ($('t-mood').value)     body.mood = $('t-mood').value.trim();
  if ($('t-notes').value)    body.notes = $('t-notes').value.trim();
  const res = await api('POST', '/api/tracks', body);
  if (res.error) return toast(res.error, false);
  closeModal('modal-track');
  toast('Track added!');
  loadTracks();
}
async function deleteTrack(id) {
  if (!confirm('Delete this track?')) return;
  await api('DELETE', `/api/tracks/${id}`);
  toast('Track deleted.');
  loadTracks();
}

// ── Clocks ────────────────────────────────────────────────────────────────────
function _buildCatOptions(selectedVal) {
  // Use real categories loaded from API; value = m1_id (or name), label = name
  const opts = _catList.length
    ? _catList.map(c => {
        const v = catValue(c);
        const sel = v === String(selectedVal) ? ' selected' : '';
        return `<option value="${esc(v)}"${sel}>${esc(c.name)}</option>`;
      }).join('')
    : `<option>Current</option><option>Recurrent</option><option>Gold</option>`;
  return opts;
}

function openClockModal() {
  $('clock-name').value = '';
  $('slots-list').innerHTML = '';
  addSlot(); addSlot(); addSlot();
  openModal('modal-clock');
}
function addSlot() {
  const div = document.createElement('div');
  div.className = 'slot-row';
  div.innerHTML = `<select>${_buildCatOptions('')}</select><input type="number" placeholder="Min secs" min="0"><button class="btn btn-danger btn-sm" onclick="this.parentNode.remove()">✕</button>`;
  $('slots-list').appendChild(div);
}
async function saveClock() {
  const name = $('clock-name').value.trim();
  if (!name) return toast('Clock name required.', false);
  const rows = $('slots-list').querySelectorAll('.slot-row');
  const slots = [...rows].map(r => {
    const [sel, inp] = r.querySelectorAll('select, input');
    return { category: sel.value, min_duration_seconds: +inp.value || 0 };
  });
  if (!slots.length) return toast('Add at least one slot.', false);
  const res = await api('POST', '/api/clocks', { name, slots });
  if (res.error) return toast(res.error, false);
  closeModal('modal-clock');
  toast('Clock created!');
  loadClocks();
}
async function loadClocks() {
  const clocks = await api('GET', '/api/clocks');
  $('clocks-empty').style.display = clocks.length ? 'none' : '';
  $('clocks-body').innerHTML = clocks.map(c => `
    <tr>
      <td><strong>${esc(c.name)}</strong></td>
      <td>${(c.slots||[]).map(s=>catPill(s.category)).join(' ')}</td>
      <td>${fmtDate(c.created_at)}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-muted btn-sm" onclick='openClockPie(${JSON.stringify(c)})'>&#9685; Chart</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClock('${c.id}')">✕</button>
      </td>
    </tr>`).join('');
}
async function deleteClock(id) {
  if (!confirm('Delete this clock?')) return;
  await api('DELETE', `/api/clocks/${id}`);
  toast('Clock deleted.');
  loadClocks();
}

// ── Schedules ─────────────────────────────────────────────────────────────────
async function loadClocksForGen() {
  const clocks = await api('GET', '/api/clocks');
  $('gen-clock').innerHTML = '<option value="">— No clock (manual) —</option>' +
    clocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
}

async function generateSchedule() {
  const body = { duration_minutes: +$('gen-duration').value || 60 };
  const clockId = $('gen-clock').value;
  const name    = $('gen-name').value.trim();
  const start   = $('gen-start').value;
  if (clockId) body.clock_id = clockId;
  if (name)    body.name = name;
  if (start)   body.start_time = start;

  // Show progress bar
  const btn = $('gen-btn');
  const prog = $('gen-progress');
  const bar  = $('gen-bar');
  const txt  = $('gen-status-text');
  btn.disabled = true;
  prog.style.display = '';
  bar.style.width = '0%';
  txt.textContent = 'Analysing track library…';

  const steps = [
    [20,  'Applying rotation rules…'],
    [50,  'Building hour schedule…'],
    [75,  'Checking artist separation…'],
    [90,  'Finalising track order…'],
    [100, 'Done!'],
  ];
  let si = 0;
  const tick = setInterval(() => {
    if (si < steps.length) {
      bar.style.width = steps[si][0] + '%';
      txt.textContent = steps[si][1];
      si++;
    }
  }, 350);

  const res = await api('POST', '/api/schedule/generate', body);
  clearInterval(tick);
  bar.style.width = '100%';

  setTimeout(() => {
    prog.style.display = 'none';
    btn.disabled = false;
  }, 600);

  if (res.error) return toast(res.error, false);
  toast('Schedule generated!');
  loadSchedules();
  openSchedule(res);
}

async function loadSchedules() {
  const schedules = await api('GET', '/api/schedules');
  $('schedules-empty').style.display = schedules.length ? 'none' : '';
  schedules.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||''));
  $('schedules-body').innerHTML = schedules.map(s => `
    <tr>
      <td><strong>${esc(s.name||'Untitled')}</strong></td>
      <td>${esc(s.clock_name||'—')}</td>
      <td>${(s.tracks||[]).length}</td>
      <td>${s.duration_minutes||0} min</td>
      <td>${fmtDate(s.created_at)}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-muted btn-sm" onclick="viewScheduleById('${s.id}')">View</button>
        <a class="btn btn-success btn-sm" href="/api/schedule/${s.id}/export?format=csv${s.start_time?'&start_time='+s.start_time:''}" download>CSV</a>
        <button class="btn btn-danger btn-sm" onclick="deleteSchedule('${s.id}')">✕</button>
      </td>
    </tr>`).join('');
}

async function viewScheduleById(id) {
  const s = await api('GET', `/api/schedule/${id}`);
  openSchedule(s);
}

function openSchedule(s) {
  _currentSched = s;

  $('modal-sched-title').textContent = s.name || 'Schedule';
  const stats = s.stats || {};
  $('modal-sched-stats').innerHTML = [
    ['Tracks',   stats.total_tracks ?? (s.tracks||[]).length],
    ['Duration', stats.total_duration_hms || fmtDur(stats.total_duration_seconds)],
    ['Artists',  stats.unique_artists ?? '—'],
  ].map(([l,v]) => `<div class="stat"><div class="stat-val">${v}</div><div class="stat-label">${l}</div></div>`).join('');

  $('viol-panel').style.display = 'none';

  // Reset to list view
  switchView('list');

  const tracks = s.tracks || [];
  $('modal-sched-body').innerHTML = tracks.map((t, i) => {
    const isNonMusic = t.type && t.type !== 'music';
    return `<tr id="srow-${i}" ${isNonMusic ? 'style="opacity:.7"' : ''}>
      <td class="track-pos">${i+1}</td>
      <td class="air-time">${t.air_time||'—'}</td>
      <td>${esc(t.title || (t.type==='lognote' ? '[lognote]' : t.type) || '—')}${t.lognote_command ? `<span style="font-size:10px;color:var(--muted);margin-left:6px">${esc(t.lognote_command)}</span>` : ''}</td>
      <td>${esc(t.artist||'—')}</td>
      <td>${isNonMusic ? `<span class="pill pill-orange">${t.type}</span>` : catPill(t.category)}</td>
      <td class="dur">${fmtDur(t.duration_seconds)}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" class="empty">No tracks</td></tr>';

  const csvHref = `/api/schedule/${s.id}/export?format=csv${s.start_time?'&start_time='+s.start_time:''}`;
  $('modal-sched-actions').innerHTML = `
    <button class="btn btn-muted" onclick="closeModal('modal-schedule')">Close</button>
    <button class="btn btn-warn btn-sm" onclick="scanViolations('${s.id}')">&#9888; Scan Violations</button>
    <a class="btn btn-success" href="${csvHref}" download>Export CSV</a>`;
  openModal('modal-schedule');
}

async function scanViolations(schedId) {
  const res = await api('POST', `/api/schedule/${schedId}/validate`);
  if (!res) return toast('Validation failed', false);

  const errors   = res.errors   || [];
  const warnings = res.warnings || [];
  const total    = (res.total_tracks || 0);
  const ok       = total - errors.length - warnings.length;
  const pct      = total ? Math.round((ok / total) * 100) : 100;

  const panel = $('viol-panel');
  panel.style.display = '';
  $('viol-stats').innerHTML = `
    <div class="viol-stat"><div class="viol-stat-val err">${errors.length}</div><div class="viol-stat-label">Errors</div></div>
    <div class="viol-stat"><div class="viol-stat-val warn">${warnings.length}</div><div class="viol-stat-label">Warnings</div></div>
    <div class="viol-stat"><div class="viol-stat-val ok">${pct}%</div><div class="viol-stat-label">Compliance</div></div>`;

  const items = [...errors.map(v=>({...v,type:'error'})), ...warnings.map(v=>({...v,type:'warning'}))];
  $('viol-list').innerHTML = items.length
    ? items.map(v => `<div class="viol-item ${v.type}">${esc(v.message||JSON.stringify(v))}</div>`).join('')
    : '<div style="color:var(--success);font-size:13px;padding:8px">&#10003; No violations found!</div>';

  // Highlight rows
  document.querySelectorAll('#modal-sched-body tr').forEach(r => r.classList.remove('row-error','row-warn'));
  errors.forEach(v   => { if (v.position != null) { const r = $('srow-'+(v.position-1)); if(r) r.classList.add('row-error'); } });
  warnings.forEach(v => { if (v.position != null) { const r = $('srow-'+(v.position-1)); if(r) r.classList.add('row-warn');  } });
}

async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;
  await api('DELETE', `/api/schedule/${id}`);
  toast('Schedule deleted.');
  loadSchedules();
}

// ── Export tab ────────────────────────────────────────────────────────────────
function toggleExportCard(card) {
  card.classList.toggle('selected');
}

async function loadExportTab() {
  const schedules = await api('GET', '/api/schedules');
  schedules.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||''));

  $('export-sched-sel').innerHTML = '<option value="">— Select a schedule —</option>' +
    schedules.map(s => `<option value="${s.id}">${esc(s.name||'Untitled')} (${fmtDate(s.created_at)})</option>`).join('');

  $('export-schedules-empty').style.display = schedules.length ? 'none' : '';
  $('export-schedules-body').innerHTML = schedules.map(s => `
    <tr>
      <td><strong>${esc(s.name||'Untitled')}</strong></td>
      <td>${esc(s.clock_name||'—')}</td>
      <td>${(s.tracks||[]).length}</td>
      <td>${fmtDate(s.created_at)}</td>
      <td style="display:flex;gap:6px">
        <a class="btn btn-success btn-sm" href="/api/schedule/${s.id}/export?format=csv" download>CSV</a>
        <a class="btn btn-muted btn-sm" href="/api/schedule/${s.id}/export?format=json" download>JSON</a>
      </td>
    </tr>`).join('');
}

async function doExport() {
  const schedId = $('export-sched-sel').value;
  if (!schedId) return toast('Please select a schedule.', false);

  const selected = [...document.querySelectorAll('#export-cards .export-card.selected')];
  if (!selected.length) return toast('Select at least one export format.', false);

  const fmts = selected.map(c => c.dataset.fmt);
  const start = $('export-start').value;
  const note  = $('export-note');

  // CSV is the only server-supported format; others download as CSV with a note
  const csvFmt = fmts.includes('csv');
  const otherFmts = fmts.filter(f => f !== 'csv');

  let url = `/api/schedule/${schedId}/export?format=csv`;
  if (start) url += `&start_time=${start}`;

  // Trigger CSV download
  const a = document.createElement('a');
  a.href = url;
  a.download = '';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  if (otherFmts.length) {
    note.textContent = `Note: ${otherFmts.join(', ')} export coming soon — downloaded as CSV.`;
  } else {
    note.textContent = '';
  }
  toast('Export downloaded!');
}

// ── Rules Engine ──────────────────────────────────────────────────────────────
const _RULE_NUMERIC = [
  'artist_separation_songs','title_separation_hours','stack_key_separation_songs',
  'album_separation_songs','double_shot_separation_songs',
  'max_gender_run','max_tempo_run','max_mood_run','max_texture_run','max_energy_run',
  'energy_step_limit','bpm_step_limit',
];
const _RULE_BOOL = [
  'allow_double_shots','check_prev_day_artist','check_prev_day_song',
  'enforce_date_range','enforce_hour_open_close',
];

async function loadRules() {
  const r = await api('GET', '/api/rules');
  _RULE_NUMERIC.forEach(k => { const el = $(`rule-${k}`); if (el) el.value = r[k] ?? ''; });
  _RULE_BOOL.forEach(k   => { const el = $(`rule-${k}`); if (el) el.checked = !!r[k]; });
  _conditionalRules = (r.conditional_rules || []).map(cr => ({ ...cr }));
  renderConditionalRules();
}

async function saveRules() {
  const body = {};
  _RULE_NUMERIC.forEach(k => { const el = $(`rule-${k}`); if (el) body[k] = +el.value; });
  _RULE_BOOL.forEach(k   => { const el = $(`rule-${k}`); if (el) body[k] = el.checked; });
  body.conditional_rules = collectConditionalRules();
  const res = await api('PUT', '/api/rules', body);
  if (res && res.error) return toast(res.error, false);
  toast('Rules saved!');
}

// ── Conditional (If/Then) Rules ───────────────────────────────────────────────
let _conditionalRules = [];
let _crNextId = 1;

const CR_FIELDS = [
  { v:'category',      l:'Category',                 ops:['eq','neq','in','not_in'],                      vt:'category' },
  { v:'hour',          l:'Hour (0–23)',               ops:['eq','lt','gt','lte','gte','between'],           vt:'number'   },
  { v:'daypart',       l:'Daypart',                   ops:['eq','neq'],                                     vt:'daypart'  },
  { v:'gender',        l:'Track Gender',              ops:['eq','neq'],                                     vt:'gender'   },
  { v:'tempo',         l:'Track Tempo',               ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'energy',        l:'Track Energy',              ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'mood',          l:'Track Mood',                ops:['eq','neq','lt','gt','lte','gte','between'],     vt:'number'   },
  { v:'bpm',           l:'Track BPM',                 ops:['lt','gt','lte','gte','between'],                vt:'number'   },
  { v:'prev_gender',   l:'Prev Song Gender',          ops:['eq','neq'],                                     vt:'gender'   },
  { v:'prev_tempo',    l:'Prev Song Tempo',           ops:['eq','neq','lt','gt','lte','gte'],               vt:'number'   },
  { v:'prev_energy',   l:'Prev Song Energy',          ops:['eq','neq','lt','gt','lte','gte'],               vt:'number'   },
  { v:'prev_category', l:'Prev Song Category',        ops:['eq','neq'],                                     vt:'category' },
  { v:'run_gender',    l:'Consecutive Same-Gender Run', ops:['gte','gt','eq'],                              vt:'number'   },
  { v:'run_tempo',     l:'Consecutive Same-Tempo Run',  ops:['gte','gt','eq'],                              vt:'number'   },
  { v:'run_energy',    l:'Consecutive Same-Energy Run', ops:['gte','gt','eq'],                              vt:'number'   },
];

const CR_OP_LABELS = {
  eq:'=', neq:'≠', lt:'<', lte:'≤', gt:'>', gte:'≥',
  between:'between', in:'in list', not_in:'not in list',
};

const CR_ACTIONS = [
  { v:'artist_separation_songs',    l:'Override Artist Separation (songs)',      vt:'number' },
  { v:'title_separation_hours',     l:'Override Title Separation (hours)',        vt:'number' },
  { v:'stack_key_separation_songs', l:'Override Stack Key Separation (songs)',    vt:'number' },
  { v:'max_run_gender',             l:'Override Max Gender Run',                  vt:'number' },
  { v:'max_run_tempo',              l:'Override Max Tempo Run',                   vt:'number' },
  { v:'max_run_energy',             l:'Override Max Energy Run',                  vt:'number' },
  { v:'max_run_mood',               l:'Override Max Mood Run',                    vt:'number' },
  { v:'require_gender',             l:'Require Track Gender =',                   vt:'gender' },
  { v:'require_gender_neq',         l:'Require Track Gender ≠',                  vt:'gender' },
  { v:'require_energy_gte',         l:'Require Track Energy ≥',                  vt:'number' },
  { v:'require_energy_lte',         l:'Require Track Energy ≤',                  vt:'number' },
  { v:'require_tempo_gte',          l:'Require Track Tempo ≥',                   vt:'number' },
  { v:'require_tempo_lte',          l:'Require Track Tempo ≤',                   vt:'number' },
  { v:'require_bpm_gte',            l:'Require Track BPM ≥',                     vt:'number' },
  { v:'require_bpm_lte',            l:'Require Track BPM ≤',                     vt:'number' },
  { v:'exclude',                    l:'Exclude track from schedule entirely',     vt:'none'   },
];

const CR_GENDER_OPTS = [
  {v:'0',l:'Unknown (0)'},{v:'1',l:'Male (1)'},{v:'2',l:'Female (2)'},{v:'3',l:'Group (3)'},
];
const CR_DAYPART_OPTS = [
  {v:'overnight',     l:'Overnight (12am – 4am)'},
  {v:'early_morning', l:'Early Morning (5am)'},
  {v:'morning_drive', l:'Morning Drive (6am – 9am)'},
  {v:'midmorning',    l:'Mid-Morning (10am – 11am)'},
  {v:'midday',        l:'Midday (12pm – 2pm)'},
  {v:'afternoon',     l:'Afternoon (3pm – 5pm)'},
  {v:'evening',       l:'Evening (6pm – 8pm)'},
  {v:'late_night',    l:'Late Night (9pm – 11pm)'},
];

function _crGenId() { return 'cr' + (_crNextId++); }
function _crFindField(v) { return CR_FIELDS.find(f => f.v === v) || CR_FIELDS[0]; }
function _crFindAction(v) { return CR_ACTIONS.find(a => a.v === v) || CR_ACTIONS[0]; }

function _crCatOpts(sel) {
  return _allCats.map(c => {
    const v = catValue(c);
    return `<option value="${esc(v)}" ${v === sel ? 'selected' : ''}>${esc(c.name)}</option>`;
  }).join('');
}
function _crFieldOpts(sel) {
  return CR_FIELDS.map(f =>
    `<option value="${f.v}" ${f.v === sel ? 'selected' : ''}>${f.l}</option>`
  ).join('');
}
function _crOpOpts(fieldDef, selOp) {
  return (fieldDef?.ops || ['eq','neq']).map(op =>
    `<option value="${op}" ${op === selOp ? 'selected' : ''}>${CR_OP_LABELS[op] || op}</option>`
  ).join('');
}
function _crGenderSel(val) {
  return `<select class="cr-v-sel">${CR_GENDER_OPTS.map(o =>
    `<option value="${o.v}" ${o.v === String(val ?? '') ? 'selected' : ''}>${o.l}</option>`
  ).join('')}</select>`;
}
function _crDaypartSel(val) {
  return `<select class="cr-v-sel">${CR_DAYPART_OPTS.map(o =>
    `<option value="${o.v}" ${o.v === (val ?? '') ? 'selected' : ''}>${o.l}</option>`
  ).join('')}</select>`;
}

function _crValInput(fieldDef, op, value) {
  if (op === 'between') {
    const [lo='', hi=''] = Array.isArray(value) ? value : [value ?? '', ''];
    return `<div class="cr-between">
      <input type="number" class="cr-v-lo" value="${esc(String(lo))}" placeholder="min">
      <span style="color:var(--muted);font-size:11px">–</span>
      <input type="number" class="cr-v-hi" value="${esc(String(hi))}" placeholder="max">
    </div>`;
  }
  if (op === 'in' || op === 'not_in') {
    const joined = Array.isArray(value) ? value.join(', ') : (value ?? '');
    return `<input type="text" class="cr-v-list" value="${esc(joined)}" placeholder="val1, val2 …">`;
  }
  const vt = fieldDef?.vt || 'number';
  if (vt === 'category') return `<select class="cr-v-sel">${_crCatOpts(value ?? '')}</select>`;
  if (vt === 'gender')   return _crGenderSel(value);
  if (vt === 'daypart')  return _crDaypartSel(value);
  return `<input type="number" class="cr-v-num" value="${value ?? ''}">`;
}

function _crActionValInput(actionDef, value) {
  if (!actionDef || actionDef.vt === 'none') return '';
  if (actionDef.vt === 'gender') return _crGenderSel(value);
  return `<input type="number" class="cr-av-num" value="${value ?? ''}">`;
}

function _crActionOpts(sel) {
  return CR_ACTIONS.map(a =>
    `<option value="${a.v}" ${a.v === sel ? 'selected' : ''}>${a.l}</option>`
  ).join('');
}

function _renderCondRow(rid, idx, cond) {
  const field    = cond.field || CR_FIELDS[0].v;
  const fieldDef = _crFindField(field);
  const op       = cond.op || fieldDef.ops[0];
  return `<div class="cr-cond-row" data-cond="${idx}">
    <select class="cr-cond-field" onchange="_crFieldChange(this,'${rid}',${idx})">${_crFieldOpts(field)}</select>
    <select class="cr-cond-op"    onchange="_crOpChange(this,'${rid}',${idx})">${_crOpOpts(fieldDef, op)}</select>
    <span   class="cr-cond-val">${_crValInput(fieldDef, op, cond.value)}</span>
    <button class="btn btn-danger btn-sm" onclick="_crRemoveCond('${rid}',${idx})">×</button>
  </div>`;
}

function _renderCRCard(cr) {
  const rid      = cr._uiId || (cr._uiId = _crGenId());
  const enabled  = cr.enabled !== false;
  const conds    = (cr.conditions && cr.conditions.length) ? cr.conditions
                    : [{ field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null }];
  const logic    = cr.condition_logic || 'AND';
  const action   = cr.action || {};
  const atype    = action.type || CR_ACTIONS[0].v;
  const aDef     = _crFindAction(atype);

  return `<div class="cr-rule${enabled ? '' : ' cr-disabled'}" data-rid="${rid}">
    <div class="cr-header">
      <label class="cr-toggle">
        <input type="checkbox" class="cr-enabled" ${enabled ? 'checked' : ''}
               onchange="this.closest('.cr-rule').classList.toggle('cr-disabled',!this.checked)">
        Enable
      </label>
      <input class="cr-label-inp" type="text" placeholder="Rule name…" value="${esc(cr.label || '')}">
      <button class="btn btn-danger btn-sm" onclick="removeCR('${rid}')">Delete</button>
    </div>
    <div class="cr-body">
      <div class="cr-section">
        <div class="cr-kw kw-if">IF</div>
        <div class="cr-inner">
          <div class="cr-conditions-list">
            ${conds.map((c, i) => _renderCondRow(rid, i, c)).join('')}
          </div>
          <div class="cr-foot">
            <button class="btn btn-muted btn-sm" onclick="_crAddCondition('${rid}')">+ Condition</button>
            <div class="cr-logic">
              <span>Logic:</span>
              <label><input type="radio" name="cr-${rid}-logic" value="AND" ${logic === 'AND' ? 'checked' : ''}> AND</label>
              <label><input type="radio" name="cr-${rid}-logic" value="OR"  ${logic === 'OR'  ? 'checked' : ''}> OR</label>
            </div>
          </div>
        </div>
      </div>
      <div class="cr-section">
        <div class="cr-kw kw-then">THEN</div>
        <div class="cr-inner">
          <div class="cr-action-row">
            <select class="cr-action-type" onchange="_crActionChange(this,'${rid}')">${_crActionOpts(atype)}</select>
            <span class="cr-action-val">${_crActionValInput(aDef, action.value)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderConditionalRules() {
  const list  = $('cond-rules-list');
  const empty = $('cond-rules-empty');
  list.querySelectorAll('.cr-rule').forEach(el => el.remove());
  if (!_conditionalRules.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  _conditionalRules.forEach(cr => {
    const div = document.createElement('div');
    div.innerHTML = _renderCRCard(cr);
    list.appendChild(div.firstElementChild);
  });
}

function addConditionalRule() {
  $('cond-rules-empty').style.display = 'none';
  const cr = {
    enabled: true, label: '',
    conditions: [{ field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null }],
    condition_logic: 'AND',
    action: { type: CR_ACTIONS[0].v, value: null },
  };
  cr._uiId = _crGenId();
  const div = document.createElement('div');
  div.innerHTML = _renderCRCard(cr);
  $('cond-rules-list').appendChild(div.firstElementChild);
}

function removeCR(rid) {
  document.querySelector(`.cr-rule[data-rid="${rid}"]`).remove();
  if (!document.querySelector('.cr-rule')) $('cond-rules-empty').style.display = '';
}

function _crFieldChange(sel, rid, idx) {
  const row      = sel.closest('.cr-cond-row');
  const fieldDef = _crFindField(sel.value);
  row.querySelector('.cr-cond-op').innerHTML = _crOpOpts(fieldDef, fieldDef.ops[0]);
  row.querySelector('.cr-cond-val').innerHTML = _crValInput(fieldDef, fieldDef.ops[0], null);
}

function _crOpChange(sel, rid, idx) {
  const row      = sel.closest('.cr-cond-row');
  const fieldDef = _crFindField(row.querySelector('.cr-cond-field').value);
  row.querySelector('.cr-cond-val').innerHTML = _crValInput(fieldDef, sel.value, null);
}

function _crActionChange(sel, rid) {
  const card    = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const aDef    = _crFindAction(sel.value);
  card.querySelector('.cr-action-val').innerHTML = _crActionValInput(aDef, null);
}

function _crAddCondition(rid) {
  const card     = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const condList = card.querySelector('.cr-conditions-list');
  const idx      = condList.querySelectorAll('.cr-cond-row').length;
  const div      = document.createElement('div');
  div.innerHTML  = _renderCondRow(rid, idx, { field: CR_FIELDS[0].v, op: CR_FIELDS[0].ops[0], value: null });
  condList.appendChild(div.firstElementChild);
}

function _crRemoveCond(rid, idx) {
  const card = document.querySelector(`.cr-rule[data-rid="${rid}"]`);
  const rows = card.querySelectorAll('.cr-cond-row');
  if (rows.length <= 1) return toast('At least one condition required.', false);
  rows[idx].remove();
  card.querySelectorAll('.cr-cond-row').forEach((r, i) => r.dataset.cond = i);
}

function _crReadCondValue(row) {
  const lo = row.querySelector('.cr-v-lo');
  if (lo) return [lo.value, (row.querySelector('.cr-v-hi') || {}).value ?? ''];
  const list = row.querySelector('.cr-v-list');
  if (list) return list.value.split(',').map(s => s.trim()).filter(Boolean);
  const sel = row.querySelector('.cr-v-sel');
  if (sel) return sel.value;
  const num = row.querySelector('.cr-v-num');
  return num ? +num.value : null;
}

function _crReadActionValue(card) {
  const sel = card.querySelector('.cr-av-sel');
  if (sel) return sel.value;
  const num = card.querySelector('.cr-av-num');
  return num ? +num.value : null;
}

function collectConditionalRules() {
  const rules = [];
  document.querySelectorAll('.cr-rule').forEach(card => {
    const rid       = card.dataset.rid;
    const enabled   = card.querySelector('.cr-enabled').checked;
    const label     = card.querySelector('.cr-label-inp').value.trim();
    const logic     = (card.querySelector(`input[name="cr-${rid}-logic"]:checked`) || {}).value || 'AND';
    const atype     = card.querySelector('.cr-action-type').value;
    const aval      = atype === 'exclude' ? null : _crReadActionValue(card);
    const conditions = [];
    card.querySelectorAll('.cr-cond-row').forEach(row => {
      conditions.push({
        field: row.querySelector('.cr-cond-field').value,
        op:    row.querySelector('.cr-cond-op').value,
        value: _crReadCondValue(row),
      });
    });
    rules.push({ id: rid, enabled, label, conditions, condition_logic: logic, action: { type: atype, value: aval } });
  });
  return rules;
}

// ── Program Grid ──────────────────────────────────────────────────────────────
let _pgClocks   = [];
let _pgTmplId   = null;
let _pgTmpl     = null;
let _pgTmpls    = [];     // all templates (for Day Detail list)
let _pgView     = 'grid'; // 'grid' | 'detail' | 'daypart'
let _ddTmplId   = null;   // selected template in Day Detail view
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

// Daypart definitions — name, color, hours covered, CSS class
const DAYPARTS = [
  { name:'Overnight',      color:'#00bcd4', cls:'dp-overnight', hours:[0,1,2,3,4]   },
  { name:'Early Morning',  color:'#ff8a65', cls:'dp-early',     hours:[5]            },
  { name:'Morning Drive',  color:'#ffd600', cls:'dp-morning',   hours:[6,7,8,9]      },
  { name:'Mid-morning',    color:'#66bb6a', cls:'dp-midmorn',   hours:[10,11]        },
  { name:'Midday',         color:'#ff9800', cls:'dp-midday',    hours:[12,13,14]     },
  { name:'Afternoon Drive',color:'#e53935', cls:'dp-afternoon', hours:[15,16,17,18]  },
  { name:'Evening',        color:'#ec407a', cls:'dp-evening',   hours:[19,20,21]     },
  { name:'Late Night',     color:'#7e57c2', cls:'dp-latenight', hours:[22,23]        },
];
const hourDpClass = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).cls;
const hourDpName  = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).name;
const hourDpColor = h => (DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0]).color;

// Format hour as "6 am" / "12 pm" / "6 pm"
function fmtHour(h) {
  if (h === 0)  return '12 am';
  if (h < 12)   return `${h} am`;
  if (h === 12) return '12 pm';
  return `${h-12} pm`;
}

// ── Program tab load ──────────────────────────────────────────────────────────
async function loadProgramTab() {
  [_pgClocks, { day_templates: _pgTmpls = [] }] = await Promise.all([
    api('GET', '/api/clocks'),
    api('GET', '/api/day-templates'),
  ]);

  // Populate template selector
  const sel = $('pg-tmpl-sel');
  sel.innerHTML = '<option value="">— Select a day template —</option>' +
    _pgTmpls.map(t => `<option value="${t.id}" ${t.id===_pgTmplId?'selected':''}>${esc(t.name)}</option>`).join('');

  loadProgramGrid();
  renderDaypLegend();
}

// ── View switching ────────────────────────────────────────────────────────────
function switchPgView(mode) {
  _pgView = mode;
  ['grid','detail','daypart'].forEach(m => {
    $('pg-view-' + m).style.display = m === mode ? '' : 'none';
    $('pgv-'     + m).classList.toggle('active', m === mode);
  });
  if (mode === 'detail')  renderDayDetail();
  if (mode === 'daypart') renderDaypartMap();
}

// ── Template management ───────────────────────────────────────────────────────
async function createDayTemplate() {
  const name = $('pg-new-name').value.trim();
  if (!name) return toast('Enter a template name first.', false);
  const res = await api('POST', '/api/day-templates', { name });
  if (res.error) return toast(res.error, false);
  $('pg-new-name').value = '';
  _pgTmplId = res.id;
  toast('Template created!');
  loadProgramTab();
}

async function deleteDayTemplate() {
  if (!_pgTmplId) return;
  if (!confirm('Delete this day template?')) return;
  await api('DELETE', `/api/day-templates/${_pgTmplId}`);
  _pgTmplId = null; _pgTmpl = null;
  $('pg-tmpl-sel').value = '';
  toast('Template deleted.');
  loadProgramTab();
}

async function loadProgramGrid() {
  const sel    = $('pg-tmpl-sel');
  const tmplId = sel.value;
  _pgTmplId    = tmplId || null;

  $('pg-del-btn').style.display  = tmplId ? '' : 'none';
  $('pg-gen-card').style.display = tmplId ? '' : 'none';

  if (!tmplId) {
    $('prog-grid-body').innerHTML = '';
    $('prog-grid-empty').style.display = '';
    _pgTmpl = null;
    if (_pgView === 'detail')  renderDayDetail();
    if (_pgView === 'daypart') renderDaypartMap();
    return;
  }
  $('prog-grid-empty').style.display = 'none';
  _pgTmpl = await api('GET', `/api/day-templates/${tmplId}`);

  renderProgramGrid();
  if (_pgView === 'detail')  renderDayDetail();
  if (_pgView === 'daypart') renderDaypartMap();

  if (!$('pg-gen-date').value)
    $('pg-gen-date').value = new Date().toISOString().slice(0, 10);
}

// Helper: read clock id for a given day index + hour from _pgTmpl
function tmplClockAt(d, h) {
  if (!_pgTmpl) return null;
  const dayKey = DAYS[d].toLowerCase() + '_' + h;
  return _pgTmpl[dayKey] !== undefined
    ? _pgTmpl[dayKey]
    : ((_pgTmpl.hours || {})[String(h)] || null);
}

// ── WEEK GRID rendering ───────────────────────────────────────────────────────
function renderProgramGrid() {
  if (!_pgTmpl) return;
  const clockOptHTML = '<option value="">—</option>' +
    _pgClocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');

  let html = '';
  for (let h = 0; h < 24; h++) {
    const dpCls = hourDpClass(h);
    html += `<tr class="${dpCls}"><td class="hour-label">${fmtHour(h)}</td>`;
    for (let d = 0; d < 7; d++) {
      html += `<td><select class="gc-select" data-day="${d}" data-hour="${h}" onchange="pgCellChange(this)">${clockOptHTML}</select></td>`;
    }
    html += '</tr>';
  }
  $('prog-grid-body').innerHTML = html;

  // Set values
  $('prog-grid-body').querySelectorAll('select.gc-select').forEach(sel => {
    sel.value = tmplClockAt(+sel.dataset.day, +sel.dataset.hour) || '';
  });
}

async function pgCellChange(sel) {
  if (!_pgTmpl || !_pgTmplId) return;
  const d      = +sel.dataset.day;
  const h      = +sel.dataset.hour;
  const dayKey = DAYS[d].toLowerCase() + '_' + h;
  const clockId = sel.value || null;

  const update = { [dayKey]: clockId };
  if (d === 0) {
    const hours = { ...(_pgTmpl.hours || {}) };
    hours[String(h)] = clockId;
    update.hours = hours;
  }

  const res = await api('PUT', `/api/day-templates/${_pgTmplId}`, update);
  if (res && !res.error) {
    _pgTmpl = res;
    sel.parentElement.style.transition = 'background .05s';
    sel.parentElement.style.background = 'rgba(108,99,255,.35)';
    setTimeout(() => { sel.parentElement.style.background = ''; }, 500);
    // Sync Day Detail if visible
    if (_pgView === 'detail') renderDayDetail();
  }
}

// ── DAY DETAIL view ───────────────────────────────────────────────────────────
function renderDayDetail() {
  const panel  = $('ddl-panel');
  const center = $('dd-center');
  const clockById = Object.fromEntries(_pgClocks.map(c => [c.id, c]));
  const clockOptHTML = '<option value="">— not used —</option>' +
    _pgClocks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');

  // Left panel: template list
  if (!_pgTmpls.length) {
    panel.innerHTML = '<div class="empty" style="padding:16px;font-size:12px">No templates yet.</div>';
  } else {
    panel.innerHTML = _pgTmpls.map(t => `
      <div class="ddl-item ${t.id===(_ddTmplId||_pgTmplId)?'active':''}"
           onclick="ddSelectTmpl('${t.id}')">${esc(t.name)}</div>
    `).join('');
  }

  // Default selection
  if (!_ddTmplId) _ddTmplId = _pgTmplId;

  const tmpl = _pgTmpls.find(t => t.id === _ddTmplId);
  if (!tmpl) {
    center.innerHTML = '<div class="empty" style="padding:40px 20px">Select a template on the left.</div>';
    return;
  }

  // Load and render the 24-hour list for this template
  api('GET', `/api/day-templates/${tmpl.id}`).then(data => {
    let rows = '';
    for (let h = 0; h < 24; h++) {
      const dpColor = hourDpColor(h);
      const dpName  = hourDpName(h);
      // For Day Detail, show the Mon clock (or flat hours as reference)
      const clockId = (data['mon_' + h] !== undefined)
        ? data['mon_' + h]
        : ((data.hours || {})[String(h)] || '');
      rows += `<div class="dd-row">
        <div class="dd-hour" style="border-left:3px solid ${dpColor}">
          ${fmtHour(h)}<span class="dd-hour-name">${dpName}</span>
        </div>
        <select class="dd-sel" data-tmpl="${tmpl.id}" data-hour="${h}" onchange="ddCellChange(this)">
          ${clockOptHTML}
        </select>
      </div>`;
    }
    center.innerHTML = `<div style="padding:10px 14px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--border);font-weight:600">${esc(tmpl.name)} — editing Mon column (applies as default for all days)</div>` + rows;
    // Set values
    center.querySelectorAll('select.dd-sel').forEach(sel => {
      const h      = +sel.dataset.hour;
      const clockId = (data['mon_' + h] !== undefined)
        ? data['mon_' + h]
        : ((data.hours || {})[String(h)] || '');
      sel.value = clockId || '';
    });
  });
}

async function ddSelectTmpl(id) {
  _ddTmplId = id;
  renderDayDetail();
}

async function ddCellChange(sel) {
  const tmplId  = sel.dataset.tmpl;
  const h       = +sel.dataset.hour;
  const clockId = sel.value || null;
  const hours   = {};
  // Build a full hours update from current center selects
  $('dd-center').querySelectorAll('select.dd-sel').forEach(s => {
    hours[String(+s.dataset.hour)] = s.value || null;
  });
  const update = { ['mon_' + h]: clockId, hours };
  const res = await api('PUT', `/api/day-templates/${tmplId}`, update);
  if (res && !res.error) {
    // If this is the active week-grid template, sync it
    if (tmplId === _pgTmplId) {
      _pgTmpl = res;
      renderProgramGrid();
    }
    sel.style.background = 'rgba(108,99,255,.2)';
    setTimeout(() => { sel.style.background = ''; }, 500);
  }
}

// ── DAYPART MAP view ──────────────────────────────────────────────────────────
function renderDaypLegend() {
  $('dp-legend').innerHTML = DAYPARTS.map(dp => `
    <div class="dp-leg-item">
      <div class="dp-swatch" style="background:${dp.color}"></div>
      <span>${dp.name}</span>
    </div>`).join('');
}

function renderDaypartMap() {
  const clockById = Object.fromEntries(_pgClocks.map(c => [c.id, c]));
  let html = '';
  for (let h = 0; h < 24; h++) {
    const dp    = DAYPARTS.find(d => d.hours.includes(h)) || DAYPARTS[0];
    html += `<tr><td class="hour-label" style="border-left:3px solid ${dp.color}">${fmtHour(h)}</td>`;
    for (let d = 0; d < 7; d++) {
      const clockId  = _pgTmpl ? tmplClockAt(d, h) : null;
      const clock    = clockId ? clockById[clockId] : null;
      const tooltip  = clock ? clock.name : '(not assigned)';
      html += `<td title="${esc(tooltip)}">
        <div class="dp-map-cell" style="background:${dp.color};opacity:${clock ? 0.85 : 0.25}">
          ${clock ? esc(clock.name.length > 12 ? clock.name.slice(0,12)+'…' : clock.name) : ''}
        </div>
      </td>`;
    }
    html += '</tr>';
  }
  $('dp-map-body').innerHTML = html;
}

// ── Generate from template ────────────────────────────────────────────────────
async function generateFromTemplate() {
  if (!_pgTmplId) return;
  const body = {
    template_id: _pgTmplId,
    date:       $('pg-gen-date').value || undefined,
    start_hour: +$('pg-gen-start-hr').value,
    end_hour:   +$('pg-gen-end-hr').value,
    name:       $('pg-gen-name').value.trim() || undefined,
  };
  const st = $('pg-gen-status');
  st.textContent = 'Generating…';
  const res = await api('POST', '/api/schedule/generate-day', body);
  if (res && res.error) { st.textContent = ''; return toast(res.error, false); }
  st.textContent = `Done — ${(res.tracks||[]).length} tracks scheduled.`;
  toast('Day schedule generated!');
  openSchedule(res);
}

// ── Clock Pie Chart ───────────────────────────────────────────────────────────
const PIE_COLORS = [
  '#6c63ff','#48bb78','#ff6584','#f6ad55','#00bcd4',
  '#ec407a','#66bb6a','#7e57c2','#ff9800','#e53935',
];
function openClockPie(clock) {
  $('pie-title').textContent = clock.name + ' — Composition';
  const slots = clock.slots || [];
  if (!slots.length) {
    $('pie-svg').innerHTML = '<text x="110" y="115" text-anchor="middle" fill="#7c85a2" font-size="13">No slots defined</text>';
    $('pie-legend').innerHTML = '';
    openModal('modal-pie');
    return;
  }

  // Count slots by category
  const counts = {};
  slots.forEach(s => { counts[s.category] = (counts[s.category] || 0) + 1; });
  const entries = Object.entries(counts);
  const total   = entries.reduce((s,[,v]) => s+v, 0);

  // Draw SVG pie
  const cx = 110, cy = 110, r = 90;
  let startAngle = -Math.PI / 2;
  let paths = '', legend = '';

  entries.forEach(([cat, count], i) => {
    const angle = (count / total) * 2 * Math.PI;
    const endAngle = startAngle + angle;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const large = angle > Math.PI ? 1 : 0;
    const col = PIE_COLORS[i % PIE_COLORS.length];

    // Mid-point for label placement
    const midA = startAngle + angle / 2;
    const lx = cx + (r * 0.62) * Math.cos(midA);
    const ly = cy + (r * 0.62) * Math.sin(midA);
    const pct = Math.round(count / total * 100);

    paths += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} Z" fill="${col}" stroke="#1a1d27" stroke-width="1.5"/>`;
    if (pct >= 6)
      paths += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="11" font-weight="700">${pct}%</text>`;

    legend += `<div class="pie-leg-row"><div class="pie-dot" style="background:${col}"></div><span>${esc(cat)} (${count})</span></div>`;
    startAngle = endAngle;
  });

  $('pie-svg').innerHTML = paths;
  $('pie-legend').innerHTML = legend;
  openModal('modal-pie');
}

// ── Schedule view modes ────────────────────────────────────────────────────────
let _currentSched = null;   // last opened schedule object

function switchView(mode) {
  ['list','blocks','timeline'].forEach(m => {
    $('view-'  +m).style.display = m===mode ? '' : 'none';
    $('vt-'    +m).classList.toggle('active', m===mode);
  });
  if (mode==='blocks')   renderHourBlocks(_currentSched);
  if (mode==='timeline') renderTimeline(_currentSched);
}

function renderHourBlocks(s) {
  const tracks = (s && s.tracks) || [];
  if (!tracks.length) { $('view-blocks').innerHTML = '<div class="empty">No tracks</div>'; return; }

  // Group by hour (derive from air_time, or group every ~60 min)
  const blocks = {};
  let hourIdx = 0, blockSecs = 0;
  tracks.forEach((t, i) => {
    if (t.air_time) {
      hourIdx = parseInt(t.air_time.split(':')[0], 10);
    } else {
      if (i > 0 && blockSecs >= 3600) { hourIdx++; blockSecs = 0; }
      blockSecs += (t.duration_seconds || 0);
    }
    const key = t.air_time ? hourIdx : hourIdx;
    if (!blocks[key]) blocks[key] = [];
    blocks[key].push(t);
  });

  $('view-blocks').innerHTML = Object.entries(blocks).map(([hr, trks]) => {
    const label = `${fmtHour(+hr)} — ${trks.length} tracks`;
    const rows = trks.map((t, i) => {
      const typeClass = t.type !== 'music' ? 'color:var(--warn)' : '';
      return `<div class="hb-row">
        <span class="hb-pos">${i+1}</span>
        <span class="hb-time">${t.air_time||'—'}</span>
        <span class="hb-title" style="${typeClass}">${esc(t.title||t.type||'—')}</span>
        <span class="hb-artist">${esc(t.artist||'')}</span>
        <span class="hb-dur">${fmtDur(t.duration_seconds)}</span>
      </div>`;
    }).join('');
    return `<div class="hour-block">
      <div class="hour-block-head">${label}</div>
      <div class="hour-block-body">${rows}</div>
    </div>`;
  }).join('');
}

function renderTimeline(s) {
  const tracks = (s && s.tracks) || [];
  if (!tracks.length) {
    $('tl-tracks').innerHTML = '<div class="empty">No tracks</div>';
    $('tl-ruler').innerHTML = '';
    return;
  }

  // Total duration in seconds for scaling
  const totalSecs = tracks.reduce((sum, t) => sum + (t.duration_seconds || 0), 0) || 3600;
  const PX_PER_SEC = 600 / totalSecs;   // fit to 600px base width

  // Ruler: one tick per 5 minutes
  let ruler = '';
  for (let s2 = 0; s2 <= totalSecs; s2 += 300) {
    const pct = (s2 / totalSecs * 100).toFixed(1);
    const label = `${Math.floor(s2/60)}m`;
    ruler += `<div class="tl-tick" style="width:${300/totalSecs*100}%;max-width:60px">${label}</div>`;
  }
  $('tl-ruler').innerHTML = ruler;

  const CAT_CLASSES = ['tl-music-0','tl-music-1','tl-music-2','tl-music-3'];
  const catIdxMap = {};
  let catCounter = 0;

  let offsetSecs = 0;
  $('tl-tracks').innerHTML = tracks.map((t, i) => {
    const dur = t.duration_seconds || 0;
    const left  = (offsetSecs / totalSecs * 100).toFixed(2);
    const width = (dur / totalSecs * 100).toFixed(2);
    offsetSecs += dur;

    let barClass = 'tl-music-0';
    if (t.type === 'spot')    barClass = 'tl-spot';
    else if (t.type === 'liner') barClass = 'tl-liner';
    else if (t.type === 'lognote') barClass = 'tl-lognote';
    else {
      const cat = t.category || '';
      if (!(cat in catIdxMap)) catIdxMap[cat] = catCounter++ % 4;
      barClass = CAT_CLASSES[catIdxMap[cat]];
    }

    const label = t.title || t.type || '?';
    return `<div class="tl-track">
      <div class="tl-label" title="${esc(t.artist||'')}">
        <span style="font-size:10px;color:var(--border)">${i+1}</span> ${esc(t.artist||t.type||'')}
      </div>
      <div class="tl-bar-wrap">
        <div class="tl-bar ${barClass}" style="left:${left}%;width:${Math.max(0.5,+width)}%" title="${esc(label)} — ${fmtDur(dur)}">
          ${+width > 3 ? esc(label) : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ── Boot ──────────────────────────────────────────────────────────────────────
(async () => {
  const [status] = await Promise.all([
    api('GET', '/api/status'),
    loadCategories(),          // must load before any rendering
  ]);
  if (status && status.ai_available) $('ai-badge').style.display = '';

  // Auto-open the correct tab based on which URL the user navigated from
  const PATH_TAB = { '/library': 'tracks', '/clocks-editor': 'clocks', '/rules-editor': 'rules' };
  const autoTab = PATH_TAB[location.pathname];
  if (autoTab) showTab(autoTab, navBtn(autoTab));
  else loadDashboard();
})();
</script>
</body>
</html>
