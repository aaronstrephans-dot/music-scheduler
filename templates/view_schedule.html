<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Schedule ‚Äî Music Scheduler</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#070a12;--bg2:#0c0f1a;
  --surface:rgba(255,255,255,0.035);--border:rgba(255,255,255,0.07);--border-bright:rgba(255,255,255,0.14);
  --accent:#7c6cf0;--accent-dim:rgba(124,108,240,0.18);--accent-glow:rgba(124,108,240,0.35);--accent2:#f472b6;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#475569;
  --success:#34d399;--danger:#f87171;--warn:#fbbf24;--info:#60a5fa;--sidebar-w:220px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;font-size:14px;-webkit-font-smoothing:antialiased}
.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;inset:0 auto 0 0;z-index:50}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:22px 20px 20px;border-bottom:1px solid var(--border)}
.logo-icon{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#7c6cf0,#f472b6);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;box-shadow:0 4px 12px rgba(124,108,240,0.4)}
.logo-text{font-weight:700;font-size:15px;letter-spacing:-.3px}
.logo-sub{font-size:10px;color:var(--text3);font-weight:500;letter-spacing:.5px;text-transform:uppercase}
.sidebar-section{padding:16px 12px 8px;font-size:10px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--text3)}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;margin:2px 8px;border-radius:8px;text-decoration:none;color:var(--text2);font-weight:500;font-size:13.5px;transition:all .15s;position:relative}
.nav-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent)}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 2px 2px 0}
.nav-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sidebar-bottom{margin-top:auto;padding:16px;border-top:1px solid var(--border)}
.station-pill{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.station-avatar{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#7c6cf0,#f472b6);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.station-name{font-weight:600;font-size:12.5px}
.station-role{font-size:11px;color:var(--text3)}

/* Main */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{padding:16px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;border-bottom:1px solid var(--border);background:rgba(7,10,18,0.7);backdrop-filter:blur(20px);position:sticky;top:0;z-index:40;flex-wrap:wrap}
.topbar-left{min-width:0}
.topbar-title{font-size:18px;font-weight:700;letter-spacing:-.3px}
.topbar-sub{font-size:12px;color:var(--text2);margin-top:1px}
.topbar-center{display:flex;align-items:center;gap:8px;flex-shrink:0}
.topbar-right{display:flex;gap:8px;flex-shrink:0}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border:none;border-radius:8px;font-size:12.5px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:hover{box-shadow:0 0 14px var(--accent-glow);transform:translateY(-1px)}
.btn-ghost{background:rgba(255,255,255,0.04);color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:rgba(255,255,255,0.08);color:var(--text)}
.btn-warn{background:rgba(251,191,36,0.12);color:var(--warn);border:1px solid rgba(251,191,36,0.2)}
.btn-warn:hover{background:rgba(251,191,36,0.2)}

/* Day navigator */
.day-nav{display:flex;align-items:center;gap:8px}
.nav-arrow{width:30px;height:30px;border:1px solid var(--border);background:rgba(255,255,255,0.04);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--text2);font-size:14px}
.nav-arrow:hover{background:var(--accent-dim);border-color:rgba(124,108,240,0.4);color:var(--accent)}
.nav-date{font-weight:700;font-size:13px;min-width:170px;text-align:center;color:var(--text)}
.today-btn{padding:5px 10px;font-size:11.5px;font-weight:600;border:1px solid var(--border);border-radius:6px;background:rgba(255,255,255,0.04);cursor:pointer;color:var(--text2);transition:all .15s}
.today-btn:hover{background:var(--accent-dim);border-color:rgba(124,108,240,0.4);color:var(--accent)}

/* Week strip */
.week-strip{display:flex;gap:4px;padding:10px 24px;border-bottom:1px solid var(--border);overflow-x:auto;background:rgba(255,255,255,0.01)}
.day-chip{padding:6px 12px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid transparent;color:var(--text3);flex-shrink:0;text-align:center}
.day-chip:hover{background:rgba(255,255,255,0.05);color:var(--text2)}
.day-chip.active{background:var(--accent-dim);border-color:rgba(124,108,240,0.35);color:var(--accent)}
.day-chip.has-err{border-color:rgba(248,113,113,0.3);background:rgba(248,113,113,0.06);color:var(--danger)}
.day-chip.has-warn{border-color:rgba(251,191,36,0.25);background:rgba(251,191,36,0.06);color:var(--warn)}
.day-num{font-size:16px;font-weight:800;display:block}
.day-name{font-size:10px;opacity:.7}

/* Content */
.content{padding:16px 24px;flex:1}

/* Tool bar */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.toolbar-left{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
.search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:9px;padding:7px 12px;transition:all .15s;min-width:200px}
.search-box:focus-within{border-color:var(--accent);background:rgba(124,108,240,0.06)}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;width:100%}
.search-box input::placeholder{color:var(--text3)}
.filter-select{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:7px 12px;color:var(--text2);font-size:12.5px;font-family:inherit;outline:none;cursor:pointer}
.filter-select:focus{border-color:var(--accent)}
.filter-select option{background:#1a1d2e}

/* Hour strip */
.hour-strip{display:flex;gap:4px;overflow-x:auto;padding-bottom:12px;margin-bottom:4px;scrollbar-width:thin;scrollbar-color:var(--accent) rgba(255,255,255,0.04)}
.hour-strip::-webkit-scrollbar{height:4px}
.hour-strip::-webkit-scrollbar-track{background:rgba(255,255,255,0.03);border-radius:2px}
.hour-strip::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
.hour-chip{padding:5px 10px;border:1px solid var(--border);border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0;color:var(--text3)}
.hour-chip:hover{border-color:var(--border-bright);color:var(--text2)}
.hour-chip.active{background:var(--accent-dim);border-color:rgba(124,108,240,0.4);color:var(--accent)}
.hour-chip.err{border-color:rgba(248,113,113,0.3);color:var(--danger)}
.hour-chip.warn{border-color:rgba(251,191,36,0.25);color:var(--warn)}

/* Violations panel */
.violations-panel{background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.2);border-radius:12px;padding:16px;margin-bottom:14px;display:none}
.violations-panel.show{display:block}
.vp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.vp-title{font-size:13px;font-weight:700;color:var(--danger)}
.vp-close{background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px}
.vp-stats{display:flex;gap:16px;margin-bottom:12px}
.vp-stat{font-size:12px;color:var(--text2)}
.vp-stat strong{font-size:16px;font-weight:800;margin-right:4px}
.vp-stat strong.red{color:var(--danger)}
.vp-stat strong.yellow{color:var(--warn)}
.vp-stat strong.green{color:var(--success)}
.violation-item{padding:8px 12px;background:rgba(248,113,113,0.08);border-left:2px solid var(--danger);border-radius:6px;margin-bottom:6px;font-size:12px}
.violation-item.warn{background:rgba(251,191,36,0.07);border-left-color:var(--warn)}
.vi-head{font-weight:600;color:var(--text);margin-bottom:2px}
.vi-msg{color:var(--text3)}

/* Schedule table */
.table-wrap{background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.schedule-table{width:100%;border-collapse:collapse}
.schedule-table thead th{
  padding:10px 14px;background:rgba(255,255,255,0.03);
  text-align:left;font-size:10.5px;font-weight:600;
  letter-spacing:.5px;text-transform:uppercase;color:var(--text3);
  border-bottom:1px solid var(--border);white-space:nowrap;
}
.schedule-table tbody tr{transition:background .1s;border-bottom:1px solid rgba(255,255,255,0.04)}
.schedule-table tbody tr:last-child{border-bottom:none}
.schedule-table tbody tr:hover{background:rgba(255,255,255,0.03)}
.schedule-table tbody tr.err-row{background:rgba(248,113,113,0.04);border-left:2px solid rgba(248,113,113,0.4)}
.schedule-table tbody tr.warn-row{background:rgba(251,191,36,0.04);border-left:2px solid rgba(251,191,36,0.3)}
.schedule-table td{padding:10px 14px;vertical-align:middle}

.time-pill{display:inline-block;padding:3px 9px;border-radius:5px;font-size:11.5px;font-weight:700;background:var(--accent-dim);color:var(--accent);white-space:nowrap;font-variant-numeric:tabular-nums}
.song-title{font-size:13px;font-weight:600;color:var(--text);line-height:1.2;margin-bottom:2px}
.song-artist{font-size:11.5px;color:var(--text3)}
.err-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:600;background:rgba(248,113,113,0.15);color:var(--danger);margin-left:6px;vertical-align:middle}
.warn-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:600;background:rgba(251,191,36,0.12);color:var(--warn);margin-left:6px;vertical-align:middle}

.cat-pill{display:inline-block;padding:3px 9px;border-radius:20px;font-size:10.5px;font-weight:600}
.cat-current  {background:rgba(96,165,250,0.12);color:var(--info)}
.cat-powergold{background:rgba(52,211,153,0.1);color:var(--success)}
.cat-power    {background:rgba(52,211,153,0.1);color:var(--success)}
.cat-recurrent{background:rgba(167,139,250,0.12);color:#a78bfa}
.cat-gold     {background:rgba(251,191,36,0.1);color:var(--warn)}
.cat-default  {background:rgba(255,255,255,0.06);color:var(--text3)}

.row-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s}
.schedule-table tbody tr:hover .row-actions{opacity:1}
.ra-btn{width:26px;height:26px;border:1px solid var(--border);background:rgba(255,255,255,0.04);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text2);transition:all .15s}
.ra-btn:hover{background:rgba(255,255,255,0.1);border-color:var(--border-bright);color:var(--text)}
.ra-btn.move{background:var(--accent-dim);border-color:rgba(124,108,240,0.3);color:var(--accent);font-weight:800}

.empty-state{padding:60px 20px;text-align:center;color:var(--text3)}
.empty-icon{font-size:48px;margin-bottom:14px;opacity:.6}
.empty-title{font-size:16px;font-weight:700;color:var(--text2);margin-bottom:6px}
.empty-sub{font-size:13px}

.loading-row td{text-align:center;padding:40px;color:var(--text3);font-size:13px}
</style>
</head>
<body>
<div class="app">

<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üéµ</div>
    <div><div class="logo-text">MusicSched</div><div class="logo-sub">Pro</div></div>
  </div>
  <div class="sidebar-section">Main</div>
  <a href="/" class="nav-item"><span class="nav-icon">‚äû</span>Dashboard</a>
  <a href="/generate" class="nav-item"><span class="nav-icon">‚ú¶</span>Generate Schedule</a>
  <a href="/view" class="nav-item active"><span class="nav-icon">‚ó´</span>View Schedule</a>
  <a href="/export" class="nav-item"><span class="nav-icon">‚Üë</span>Export Logs</a>
  <div class="sidebar-section">Library</div>
  <a href="#" class="nav-item"><span class="nav-icon">‚ô™</span>Song Library</a>
  <a href="#" class="nav-item"><span class="nav-icon">‚è±</span>Clock Templates</a>
  <a href="#" class="nav-item"><span class="nav-icon">‚óà</span>Rules Engine</a>
  <div class="sidebar-bottom">
    <div class="station-pill">
      <div class="station-avatar">P</div>
      <div><div class="station-name">Praise FM</div><div class="station-role">Administrator</div></div>
    </div>
  </div>
</aside>

<div class="main">

  <!-- Topbar with navigator -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="topbar-title">View Schedule</div>
      <div class="topbar-sub" id="topbarSub">Loading...</div>
    </div>
    <div class="topbar-center">
      <div class="day-nav">
        <button class="nav-arrow" onclick="shiftDay(-1)">‚óÄ</button>
        <div class="nav-date" id="navDate">‚Äî</div>
        <button class="nav-arrow" onclick="shiftDay(1)">‚ñ∂</button>
        <button class="today-btn" onclick="goToday()">Today</button>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-warn" onclick="toggleViolations()">‚ö† Violations</button>
      <button class="btn btn-ghost" onclick="window.location.href='/export'">‚Üë Export</button>
    </div>
  </header>

  <!-- Week strip -->
  <div class="week-strip" id="weekStrip"></div>

  <div class="content">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box">
          <span style="color:var(--text3);font-size:13px">‚åï</span>
          <input type="text" id="searchInput" placeholder="Search songs, artists..." oninput="applyFilters()">
        </div>
        <select class="filter-select" id="catFilter" onchange="applyFilters()">
          <option value="">All categories</option>
          <option value="Current">Current</option>
          <option value="PowerGold">PowerGold</option>
          <option value="Recurrent">Recurrent</option>
          <option value="Gold">Gold</option>
        </select>
      </div>
      <div style="font-size:12px;color:var(--text3)" id="trackCount">‚Äî</div>
    </div>

    <!-- Hour strip -->
    <div class="hour-strip" id="hourStrip">
      <div class="hour-chip active" onclick="filterHour(null,this)">All Hours</div>
    </div>

    <!-- Violations panel -->
    <div class="violations-panel" id="vPanel">
      <div class="vp-header">
        <div class="vp-title">‚ö† Violations Detected</div>
        <button class="vp-close" onclick="toggleViolations()">‚úï</button>
      </div>
      <div class="vp-stats">
        <div class="vp-stat"><strong class="red" id="vErrCount">0</strong>Errors</div>
        <div class="vp-stat"><strong class="yellow" id="vWarnCount">0</strong>Warnings</div>
        <div class="vp-stat"><strong class="green" id="vPassRate">100%</strong>Pass Rate</div>
      </div>
      <div id="vList"></div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table class="schedule-table">
        <thead>
          <tr>
            <th style="width:90px">#  Time</th>
            <th>Song</th>
            <th style="width:120px">Category</th>
            <th style="width:70px">Length</th>
            <th style="width:110px">Actions</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
          <tr class="loading-row"><td colspan="5">‚è≥  Loading schedule...</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>
</div>

<script>
let currentDate = new Date().toISOString().split('T')[0];
let allTracks   = [];
let activeHour  = null;

// Week days
function getWeekDates(dateStr) {
  const d   = new Date(dateStr + 'T12:00:00');
  const dow = d.getDay();
  const sun = new Date(d); sun.setDate(d.getDate() - dow);
  return Array.from({length:7}, (_, i) => {
    const x = new Date(sun); x.setDate(sun.getDate() + i);
    return x.toISOString().split('T')[0];
  });
}

function fmtDisplay(dateStr) {
  return new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
}
function fmtShort(dateStr) {
  return new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

function buildWeekStrip(dates) {
  const strip = document.getElementById('weekStrip');
  const days  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  strip.innerHTML = dates.map((d,i) => {
    const num = parseInt(d.split('-')[2]);
    const isActive = d === currentDate;
    return `<div class="day-chip ${isActive?'active':''}" onclick="jumpToDate('${d}',this)">
      <span class="day-num">${num}</span>
      <span class="day-name">${days[i]}</span>
    </div>`;
  }).join('');
}

function jumpToDate(date, el) {
  currentDate = date;
  document.querySelectorAll('.day-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('navDate').textContent = fmtDisplay(date);
  document.getElementById('topbarSub').textContent = 'Loading...';
  loadSchedule(date);
}

function shiftDay(dir) {
  const d = new Date(currentDate + 'T12:00:00');
  d.setDate(d.getDate() + dir);
  currentDate = d.toISOString().split('T')[0];
  refreshAll();
}

function goToday() {
  currentDate = new Date().toISOString().split('T')[0];
  refreshAll();
}

function refreshAll() {
  const dates = getWeekDates(currentDate);
  buildWeekStrip(dates);
  document.getElementById('navDate').textContent = fmtDisplay(currentDate);
  loadSchedule(currentDate);
}

// Hour strip
function buildHourStrip(tracks) {
  const strip = document.getElementById('hourStrip');
  const hours = new Set(tracks.map(t => getHour(t.time)).filter(h => h >= 0));
  const sorted = Array.from(hours).sort((a,b)=>a-b);
  strip.innerHTML = '<div class="hour-chip active" onclick="filterHour(null,this)">All Hours</div>';
  sorted.forEach(h => {
    const label = h===0?'12 AM':h<12?`${h} AM`:h===12?'12 PM':`${h-12} PM`;
    const hasErr  = tracks.some(t => getHour(t.time)===h && t.has_error);
    const hasWarn = tracks.some(t => getHour(t.time)===h && t.has_warning);
    const cls = hasErr ? 'err' : hasWarn ? 'warn' : '';
    strip.innerHTML += `<div class="hour-chip ${cls}" onclick="filterHour(${h},this)">${label}</div>`;
  });
}

function getHour(timeStr) {
  if (!timeStr) return -1;
  const m = timeStr.match(/^(\d+):\d+\s*(AM|PM)/i);
  if (!m) return -1;
  let h = parseInt(m[1]);
  const pm = m[2].toUpperCase()==='PM';
  if (pm && h!==12) h+=12;
  if (!pm && h===12) h=0;
  return h;
}

function filterHour(hour, btn) {
  activeHour = hour;
  document.querySelectorAll('.hour-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  applyFilters();
}

function applyFilters() {
  const q   = (document.getElementById('searchInput').value||'').toLowerCase();
  const cat = document.getElementById('catFilter').value;
  let rows  = allTracks;
  if (activeHour !== null) rows = rows.filter(t => getHour(t.time) === activeHour);
  if (cat) rows = rows.filter(t => t.category === cat);
  if (q)   rows = rows.filter(t => (t.title||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q));
  renderRows(rows);
}

function catClass(cat) {
  const k = (cat||'').toLowerCase().replace(/\s+/g,'').replace('power gold','powergold');
  const map = {current:'cat-current',powergold:'cat-powergold',power:'cat-power',recurrent:'cat-recurrent',gold:'cat-gold'};
  return map[k] || 'cat-default';
}

function renderRows(rows) {
  const tbody = document.getElementById('scheduleBody');
  document.getElementById('trackCount').textContent = `${rows.length} track${rows.length===1?'':'s'}`;
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="5">
      <div class="empty-state">
        <div class="empty-icon">‚ô´</div>
        <div class="empty-title">No tracks found</div>
        <div class="empty-sub">Try a different filter, or generate a schedule first.</div>
      </div></td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map((t,i) => {
    const rowCls = t.has_error ? 'err-row' : t.has_warning ? 'warn-row' : '';
    const errB   = t.has_error   ? `<span class="err-badge">‚öë ${t.error||'Error'}</span>`     : '';
    const warnB  = t.has_warning ? `<span class="warn-badge">‚ö† ${t.warning||'Warning'}</span>` : '';
    return `<tr class="${rowCls}">
      <td>
        <div style="font-size:10px;color:var(--text3);margin-bottom:2px">#${t.position||i+1}</div>
        <span class="time-pill">${t.time||'‚Äî'}</span>
      </td>
      <td>
        <div class="song-title">${t.title||'Unknown'}${errB}${warnB}</div>
        <div class="song-artist">${t.artist||''}</div>
      </td>
      <td><span class="cat-pill ${catClass(t.category)}">${t.category||'‚Äî'}</span></td>
      <td style="font-size:12px;color:var(--text2);font-variant-numeric:tabular-nums">${t.length||'‚Äî'}</td>
      <td>
        <div class="row-actions">
          <button class="ra-btn move" title="Move up" onclick="alert('Move up: '+${t.position||0})">‚Üë</button>
          <button class="ra-btn move" title="Move down" onclick="alert('Move down: '+${t.position||0})">‚Üì</button>
          <button class="ra-btn" title="Replace" onclick="alert('Replace: ${(t.title||'').replace(/'/g,"\\'")}')">‚áÑ</button>
          <button class="ra-btn" title="Remove" onclick="alert('Remove: ${(t.title||'').replace(/'/g,"\\'")}')">‚úï</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function updateViolations(tracks) {
  const errs  = tracks.filter(t => t.has_error);
  const warns = tracks.filter(t => t.has_warning);
  document.getElementById('vErrCount').textContent  = errs.length;
  document.getElementById('vWarnCount').textContent = warns.length;
  const pct = tracks.length ? Math.round(((tracks.length-errs.length)/tracks.length)*100) : 100;
  document.getElementById('vPassRate').textContent  = pct + '%';
  document.getElementById('vList').innerHTML = [
    ...errs.map(t  => `<div class="violation-item"><div class="vi-head">${t.time} ‚Äî "${t.title}"</div><div class="vi-msg">${t.error}</div></div>`),
    ...warns.map(t => `<div class="violation-item warn"><div class="vi-head">${t.time} ‚Äî "${t.title}"</div><div class="vi-msg">${t.warning}</div></div>`)
  ].join('') || '<div style="font-size:12px;color:var(--success);padding:6px">‚úì No violations found</div>';

  // Colour topbar button
  const btn = document.querySelector('.btn-warn');
  if (errs.length)  btn.textContent = `‚öë ${errs.length} Error${errs.length>1?'s':''}`;
  else if (warns.length) btn.textContent = `‚ö† ${warns.length} Warning${warns.length>1?'s':''}`;
  else { btn.textContent = '‚úì No Issues'; btn.style.background='rgba(52,211,153,0.1)'; btn.style.borderColor='rgba(52,211,153,0.2)'; btn.style.color='var(--success)'; }
}

function toggleViolations() {
  document.getElementById('vPanel').classList.toggle('show');
}

async function loadSchedule(date) {
  document.getElementById('scheduleBody').innerHTML = '<tr class="loading-row"><td colspan="5">‚è≥ Loading schedule...</td></tr>';
  try {
    const res  = await fetch('/api/schedule/date/' + date);
    const data = await res.json();
    allTracks  = data.schedule || [];
    buildHourStrip(allTracks);
    activeHour = null;
    document.querySelectorAll('.hour-chip').forEach(c=>c.classList.remove('active'));
    document.querySelector('.hour-chip')?.classList.add('active');
    applyFilters();
    updateViolations(allTracks);
    document.getElementById('topbarSub').textContent = `${allTracks.length} tracks scheduled`;
  } catch(e) {
    document.getElementById('scheduleBody').innerHTML = `<tr class="loading-row"><td colspan="5" style="color:var(--danger)">Error: ${e.message}</td></tr>`;
  }
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  refreshAll();
});
</script>
</body>
</html>
